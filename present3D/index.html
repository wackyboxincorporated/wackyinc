<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Modular CLT Housing Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #111;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            background-color: #1a1a1a;
        }
        
        #header {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
            color: #f0f0f0;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }

        #header h1 {
            margin: 0;
            font-size: 1.25rem;
            color: #00dd82;
            text-shadow: 0 0 10px rgba(0, 221, 130, 0.6);
        }
        
        #threejs-container {
            flex-grow: 1;
            position: relative;
            background-color: #000;
        }
        
        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }
        
        #controls-wrapper {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 2rem);
            max-width: 900px;
            z-index: 10;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        #controls-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(120%);
        }

        #controls {
            background: rgba(28, 28, 28, 0.75);
            backdrop-filter: blur(12px);
            padding: 1rem 1.5rem;
            border: 1px solid #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            align-items: center;
        }
        
        .control-button {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            padding: 10px 18px;
            border-radius: 8px;
            border: 1px solid #444;
            background: linear-gradient(145deg, #3a3a3a, #2c2c2c);
            color: #f0f0f0;
            text-shadow: 0 1px 1px rgba(0,0,0,0.4);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .control-button i { font-size: 1rem; color: #00dd82; }
        .control-button:hover {
            background: linear-gradient(145deg, #4a4a4a, #383838);
            border-color: #666;
            transform: translateY(-2px);
        }
        .control-button:active {
            transform: translateY(0px);
            background: linear-gradient(145deg, #2c2c2c, #222222);
        }
        .control-button.active {
            background: linear-gradient(145deg, #00b368, #009a58);
            border-color: #00dd82;
            color: white;
        }
        
        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background: #222; border-radius: 4px; outline: none;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #f0f0f0; border: 2px solid #00dd82; border-radius: 50%;
            cursor: grab; box-shadow: 0 0 8px rgba(0, 221, 130, 0.7); margin-top: -6px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        input[type="range"]:active::-webkit-slider-thumb { cursor: grabbing; transform: scale(1.1); box-shadow: 0 0 12px rgba(0, 221, 130, 1); }
        
        .slider-group { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; min-width: 180px; }
        .slider-label { color: #aaa; font-size: 0.8rem; font-weight: 400; }

        #info-display {
            font-size: 1rem; font-weight: 500; color: #00dd82; background-color: rgba(0,0,0,0.3);
            padding: 8px 12px; border-radius: 8px; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.4);
            text-shadow: 0 0 5px rgba(0, 221, 130, 0.5); border: 1px solid #222; white-space: nowrap;
        }

        #view-controls { display: flex; gap: 0.5rem; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111;
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; transition: opacity 0.5s ease;
        }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        #loading-text { font-size: 1.5rem; }
        #loading-bar-container { width: 300px; height: 4px; background: #333; border-radius: 2px; margin-top: 1rem; }
        #loading-bar { width: 0%; height: 100%; background: #00dd82; border-radius: 2px; transition: width 0.3s; }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 140px; background-color: #111; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 150%;
            left: 50%; margin-left: -70px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        @media (max-width: 768px) {
            #header h1 { font-size: 1rem; }
            #controls { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div id="loading-text">Loading Assets...</div>
        <div id="loading-bar-container"><div id="loading-bar"></div></div>
    </div>
    <div id="app-container">
        <div id="header">
            <h1>Advanced Modular Housing Assembly</h1>
            <div id="view-controls">
                <div class="tooltip">
                    <button id="toggle-controls-btn" class="control-button"><i class="fas fa-eye-slash"></i></button>
                    <span class="tooltiptext">Hide Controls</span>
                </div>
                <div class="tooltip">
                    <button id="view-perspective" class="control-button"><i class="fas fa-cube"></i></button>
                    <span class="tooltiptext">Perspective View</span>
                </div>
                <div class="tooltip">
                    <button id="view-top" class="control-button"><i class="fas fa-arrow-down"></i></button>
                    <span class="tooltiptext">Top View</span>
                </div>
                <div class="tooltip">
                    <button id="view-side" class="control-button"><i class="fas fa-arrows-left-right"></i></button>
                    <span class="tooltiptext">Side View</span>
                </div>
            </div>
        </div>
        <div id="threejs-container">
            <div id="controls-wrapper">
                <div id="controls">
                    <button id="playPauseBtn" class="control-button"><i class="fas fa-play"></i> Play</button>
                    <button id="resetBtn" class="control-button"><i class="fas fa-sync-alt"></i> Reset</button>
                    <div class="slider-group">
                        <label for="progressSlider" class="slider-label">Timeline</label>
                        <input type="range" id="progressSlider" min="0" max="100" value="0">
                    </div>
                    <div class="slider-group">
                        <label for="speedSlider" class="slider-label">Speed: <span id="speedDisplay">1.0x</span></label>
                        <input type="range" id="speedSlider" min="10" max="1000" value="100">
                    </div>
                    <div id="info-display">Waiting to Start</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Sky } from 'three/addons/objects/Sky.js';

        // --- Global Components ---
        let scene, camera, renderer, controls, animationTimeline, sky, sun;
        const modules = [], moduleGroups = [], furnitureGroups = [];
        let crane, craneHook, craneCable, fabricationArea, truck;
        let waterPipe, electricCable;
        const upVector = new THREE.Vector3(0, 1, 0);
        
        // --- Materials ---
        let cltMaterial, concreteMaterial, glassMaterial, metalMaterial, craneMaterial, woodLogMaterial, truckMaterial;

        // --- Configuration ---
        const moduleData = [
            { id: 'module1', targetPos: new THREE.Vector3(0, 0.15, 0) },
            { id: 'module2', targetPos: new THREE.Vector3(4.2, 0.15, 0) },
            { id: 'module3', targetPos: new THREE.Vector3(0, 3.3, 0) },
            { id: 'module4', targetPos: new THREE.Vector3(4.2, 3.3, 0) }
        ];
        const MODULE_WIDTH = 4, MODULE_HEIGHT = 3, MODULE_DEPTH = 8; // Increased depth
        const panelThickness = 0.15;
        const craneBasePosition = new THREE.Vector3(25, 0, -25);
        const fabricationPosition = new THREE.Vector3(-35, 0.1, 15);
        const truckStartPosition = new THREE.Vector3(-60, 0, -10);
        const truckStopPosition = new THREE.Vector3(15, 0, -10);
        const buildingCenter = new THREE.Vector3(2.1, 3.3, 0);

        // --- UI Elements ---
        let playPauseBtn, resetBtn, progressSlider, speedSlider, speedDisplay, infoDisplay, toggleControlsBtn, controlsWrapper;

        function init() {
            setupUI();
            const loadingManager = new THREE.LoadingManager();
            const textureLoader = new THREE.TextureLoader(loadingManager);
            
            const woodTexture = textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/textures/hardwood2_diffuse.jpg');
            const concreteTexture = textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/textures/terrain/rock_b.jpg');
            const woodLogTexture = textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/textures/bark_perpendicular.jpg');
            woodTexture.wrapS = woodTexture.wrapT = THREE.RepeatWrapping;
            concreteTexture.wrapS = concreteTexture.wrapT = THREE.RepeatWrapping;
            concreteTexture.repeat.set(20, 20);
            woodLogTexture.wrapS = woodLogTexture.wrapT = THREE.RepeatWrapping;

            loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
                document.getElementById('loading-bar').style.width = `${(itemsLoaded / itemsTotal) * 100}%`;
            };

            loadingManager.onLoad = () => {
                document.getElementById('loading-overlay').classList.add('hidden');
                setupScene(woodTexture, concreteTexture, woodLogTexture);
                setupEventListeners();
                animate();
            };
        }

        function setupScene(woodTexture, concreteTexture, woodLogTexture) {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111115);
            scene.fog = new THREE.Fog(0x111115, 100, 250);

            const container = document.getElementById('threejs-container');
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(30, 18, 35);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 0.7;
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;
            controls.target.copy(buildingCenter);

            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x8d8d8d, 1.2);
            hemiLight.position.set(0, 50, 0);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 2.5);
            dirLight.position.set(-40, 50, 25);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 40; dirLight.shadow.camera.bottom = -40;
            dirLight.shadow.camera.left = -40; dirLight.shadow.camera.right = 40;
            dirLight.shadow.mapSize.width = 4096; dirLight.shadow.mapSize.height = 4096;
            scene.add(dirLight);

            sky = new Sky();
            sky.scale.setScalar(450000);
            scene.add(sky);
            sun = new THREE.Vector3();
            const effectController = {
                turbidity: 2, rayleigh: 1.2, mieCoefficient: 0.003,
                mieDirectionalG: 0.8, elevation: 35, azimuth: 180
            };
            const phi = THREE.MathUtils.degToRad(90 - effectController.elevation);
            const theta = THREE.MathUtils.degToRad(effectController.azimuth);
            sun.setFromSphericalCoords(1, phi, theta);
            sky.material.uniforms['sunPosition'].value.copy(sun);
            dirLight.position.copy(sun).multiplyScalar(50);
            
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(500, 500),
                new THREE.MeshStandardMaterial({ map: concreteTexture, roughness: 0.9, metalness: 0.1 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            cltMaterial = new THREE.MeshStandardMaterial({ map: woodTexture, roughness: 0.8, metalness: 0.05, side: THREE.DoubleSide });
            woodLogMaterial = new THREE.MeshStandardMaterial({ map: woodLogTexture, roughness: 0.9, side: THREE.DoubleSide });
            metalMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.4, metalness: 0.8 });
            glassMaterial = new THREE.MeshPhysicalMaterial({ roughness: 0.05, transmission: 1.0, thickness: 0.1, ior: 1.5, color: 0xade0ff });
            craneMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.4, metalness: 0.6 });
            truckMaterial = new THREE.MeshStandardMaterial({ color: 0xda3633, roughness: 0.5, metalness: 0.2 });

            createModulesAndComponents();
            createSiteEnvironment();
            crane = createCrane();
            craneHook = createCraneHook();
            craneCable = createCraneCable();
            truck = createTruck();
            scene.add(crane, craneHook, craneCable, truck);

            setupAnimationTimeline();
        }

        function createCrane() {
            const craneGroup = new THREE.Group();
            craneGroup.position.copy(craneBasePosition);
            
            const tower = new THREE.Mesh(new THREE.BoxGeometry(1.5, 42, 1.5), craneMaterial);
            tower.position.y = 21; tower.castShadow = true;

            const jib = new THREE.Mesh(new THREE.BoxGeometry(60, 1.2, 1.2), craneMaterial);
            jib.position.set(21, 41.4, 0); jib.castShadow = true;
            
            const counterWeight = new THREE.Mesh(new THREE.BoxGeometry(5, 4, 4), new THREE.MeshStandardMaterial({color: 0x444444}));
            counterWeight.position.set(-11, 40, 0); counterWeight.castShadow = true;
            
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2.5), new THREE.MeshStandardMaterial({color: 0x333333}));
            cabin.position.set(-2, 38, 0); cabin.castShadow = true;
            
            const operator = new THREE.Group();
            operator.add(jib, counterWeight, cabin);
            craneGroup.add(tower, operator);
            craneGroup.userData.operator = operator;
            return craneGroup;
        }
        
        function createModulesAndComponents() {
            moduleData.forEach((data, index) => {
                const moduleGroup = new THREE.Group();
                moduleGroup.name = `ModuleGroup_${index+1}`;
                moduleGroup.position.copy(data.targetPos);
                scene.add(moduleGroup);
                moduleGroups.push(moduleGroup);

                const components = {
                    floor: new THREE.Mesh(new THREE.BoxGeometry(MODULE_WIDTH, panelThickness, MODULE_DEPTH), cltMaterial),
                    roof: new THREE.Mesh(new THREE.BoxGeometry(MODULE_WIDTH, panelThickness, MODULE_DEPTH), cltMaterial),
                    wall_back: new THREE.Mesh(new THREE.BoxGeometry(MODULE_WIDTH, MODULE_HEIGHT, panelThickness), cltMaterial),
                    wall_left: new THREE.Mesh(new THREE.BoxGeometry(panelThickness, MODULE_HEIGHT, MODULE_DEPTH), cltMaterial),
                    wall_right: new THREE.Mesh(new THREE.BoxGeometry(panelThickness, MODULE_HEIGHT, MODULE_DEPTH), cltMaterial),
                    wall_front_frame: new THREE.Group(),
                    window_glass: new THREE.Mesh(new THREE.BoxGeometry(MODULE_WIDTH * 0.5, MODULE_HEIGHT * 0.7, 0.05), glassMaterial),
                    door: new THREE.Mesh(new THREE.BoxGeometry(1, 2.2, 0.08), new THREE.MeshStandardMaterial({color:0x5c3c20})),
                };
                
                const frontWall = new THREE.Group();
                const topBeam = new THREE.Mesh(new THREE.BoxGeometry(MODULE_WIDTH, 0.4, panelThickness), cltMaterial);
                topBeam.position.y = MODULE_HEIGHT / 2 - 0.2;
                const bottomBeam = new THREE.Mesh(new THREE.BoxGeometry(MODULE_WIDTH, 0.4, panelThickness), cltMaterial);
                bottomBeam.position.y = -MODULE_HEIGHT / 2 + 0.2;
                const pillar = new THREE.Mesh(new THREE.BoxGeometry(0.4, MODULE_HEIGHT - 0.8, panelThickness), cltMaterial);
                pillar.position.x = MODULE_WIDTH * 0.1;
                frontWall.add(topBeam, bottomBeam, pillar);
                components.wall_front_frame = frontWall;

                components.floor.position.y = panelThickness / 2;
                components.roof.position.y = MODULE_HEIGHT + panelThickness / 2;
                components.wall_back.position.set(0, MODULE_HEIGHT / 2 + panelThickness, -MODULE_DEPTH / 2 + panelThickness / 2);
                components.wall_front_frame.position.set(0, MODULE_HEIGHT / 2 + panelThickness, MODULE_DEPTH / 2 - panelThickness / 2);
                components.wall_left.position.set(-MODULE_WIDTH / 2 + panelThickness / 2, MODULE_HEIGHT / 2 + panelThickness, 0);
                components.wall_right.position.set(MODULE_WIDTH / 2 - panelThickness / 2, MODULE_HEIGHT / 2 + panelThickness, 0);
                components.window_glass.position.copy(components.wall_front_frame.position).add(new THREE.Vector3(-0.6, 0.1, 0));
                components.door.position.copy(components.wall_front_frame.position).add(new THREE.Vector3(1.5, -0.3, 0));

                Object.values(components).forEach(obj => {
                    obj.castShadow = true; obj.receiveShadow = true;
                    obj.userData.finalPosition = obj.position.clone();
                    obj.position.copy(fabricationPosition).add(new THREE.Vector3(10, 0, 0));
                    obj.userData.initialPosition = obj.position.clone();
                    obj.userData.initialRotation = obj.rotation.clone();
                    obj.visible = false;
                    scene.add(obj);
                    moduleGroup.userData[obj.name] = obj;
                });
                modules.push(components);

                const furnitureGroup = new THREE.Group();
                const bed = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.4, 2.8), cltMaterial);
                bed.position.set(1, 0.3, -2.5);
                const kitchenette = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.9, 0.6), metalMaterial);
                kitchenette.position.set(-1.2, 0.45, -3.2);
                const sofa = new THREE.Mesh(new THREE.BoxGeometry(2, 0.7, 0.8), new THREE.MeshStandardMaterial({color: 0x556b2f}));
                sofa.position.set(-0.8, 0.35, 1.5);
                const lamp = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({color:0xffff00, emissive: 0xffff00, emissiveIntensity:0}));
                lamp.position.set(0, 2.5, 1.5);
                furnitureGroup.add(bed, kitchenette, sofa, lamp);
                furnitureGroup.visible = false;
                furnitureGroup.position.copy(data.targetPos);
                scene.add(furnitureGroup);
                furnitureGroups.push(furnitureGroup);
            });
        }
        
        function createSiteEnvironment() {
            const pipeGeo = new THREE.CylinderGeometry(0.15, 0.15, 40, 12);
            const waterMain = new THREE.Mesh(pipeGeo, new THREE.MeshStandardMaterial({color:0x3366ff}));
            waterMain.rotation.z = Math.PI/2;
            waterMain.position.set(0, -0.15, -15); scene.add(waterMain);
            const electricMain = new THREE.Mesh(pipeGeo, new THREE.MeshStandardMaterial({color:0xffcc00}));
            electricMain.rotation.z = Math.PI/2;
            electricMain.position.set(0, -0.15, -16); scene.add(electricMain);

            waterPipe = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1, 8), new THREE.MeshStandardMaterial({color:0x0000ff}));
            waterPipe.position.set(2.1, -0.5, -15);
            electricCable = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1, 8), new THREE.MeshStandardMaterial({color:0xffcc00}));
            electricCable.position.set(2.1, -0.5, -16);
            scene.add(waterPipe, electricCable);

            fabricationArea = new THREE.Group();
            fabricationArea.position.copy(fabricationPosition);
            const base = new THREE.Mesh(new THREE.BoxGeometry(12, 0.2, 10), new THREE.MeshStandardMaterial({color: 0x444}));
            const pressMachine = new THREE.Mesh(new THREE.BoxGeometry(4, 3, 5), metalMaterial);
            pressMachine.position.set(0, 1.6, 0);
            fabricationArea.add(base, pressMachine);
            fabricationArea.visible = false;
            
            const logGeo = new THREE.CylinderGeometry(0.2, 0.2, 4, 10);
            for(let i=0; i < 30; i++) {
                const log = new THREE.Mesh(logGeo, woodLogMaterial);
                log.rotation.z = Math.PI/2;
                log.position.set(-5 + (i%5)*0.4, 0.2 + Math.floor(i/5)*0.4, Math.random()*6-3);
                log.name = `log_${i}`;
                fabricationArea.add(log);
            }
            scene.add(fabricationArea);
        }

        function createTruck() {
            const truckGroup = new THREE.Group();
            const bodyMat = new THREE.MeshStandardMaterial({color: 0xbb2222, roughness: 0.6});
            const cab = new THREE.Mesh(new THREE.BoxGeometry(3, 2.5, 2.5), bodyMat);
            cab.position.set(4.5, 1.25, 0);
            const cargo = new THREE.Mesh(new THREE.BoxGeometry(7, 3, 2.8), new THREE.MeshStandardMaterial({color: 0xcccccc}));
            cargo.position.set(0, 1.5, 0);
            const wheelGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.5, 18);
            wheelGeo.rotateZ(Math.PI / 2);
            const wheelMat = new THREE.MeshStandardMaterial({color: 0x111111});
            const wheelPositions = [ [4.5, 0.5, 1.4], [4.5, 0.5, -1.4], [0, 0.5, 1.4], [0, 0.5, -1.4], [-2, 0.5, 1.4], [-2, 0.5, -1.4] ];
            wheelPositions.forEach(p => {
                const wheel = new THREE.Mesh(wheelGeo, wheelMat);
                wheel.position.set(p[0], p[1], p[2]);
                truckGroup.add(wheel);
            });
            truckGroup.add(cab, cargo);
            truckGroup.position.copy(truckStartPosition);
            truckGroup.visible = false;
            return truckGroup;
        }
        
        function createCraneHook() {
            const hookGroup = new THREE.Group(); hookGroup.visible = false;
            hookGroup.position.set(craneBasePosition.x, 35, craneBasePosition.z);
            
            const harnessMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.2, metalness: 0.9 });
            const mainBar = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, MODULE_DEPTH * 0.8), harnessMat);
            hookGroup.add(mainBar);
            const topConnector = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.5, 8), harnessMat);
            topConnector.position.y = 0.35;
            hookGroup.add(topConnector);

            hookGroup.userData.attachPoint = topConnector;
            return hookGroup;
        }

        function createCraneCable() {
            const cableGeo = new THREE.CylinderGeometry(0.04, 0.04, 1, 8);
            const cableMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.8 });
            const cable = new THREE.Mesh(cableGeo, cableMat); cable.visible = false;
            return cable;
        }

        function updateCable() {
            if (!craneCable.visible) return;
            const jib = crane.userData.operator.children[0];
            const endOfJibWorldPos = new THREE.Vector3(jib.position.x + craneHook.position.x - crane.position.x - 21, 0, 0);
            jib.localToWorld(endOfJibWorldPos);
            
            const startPoint = new THREE.Vector3(craneHook.position.x, endOfJibWorldPos.y, craneHook.position.z);
            const endPoint = new THREE.Vector3();
            craneHook.userData.attachPoint.getWorldPosition(endPoint);

            const distance = startPoint.distanceTo(endPoint);
            craneCable.position.copy(startPoint).lerp(endPoint, 0.5);
            craneCable.scale.y = distance;
            craneCable.quaternion.setFromUnitVectors(upVector, endPoint.clone().sub(startPoint).normalize());
        }

        function resetScene() {
            if(animationTimeline) animationTimeline.pause().progress(0);
            gsap.killTweensOf(camera.position);
            gsap.killTweensOf(controls.target);
            controls.enabled = true;

            playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
            infoDisplay.textContent = 'Waiting to Start';
            progressSlider.value = 0;
            
            while(craneHook.children.length > 1) { // Keep harness
                const child = craneHook.children[1];
                scene.add(child);
                craneHook.remove(child);
            }

            modules.forEach((moduleComponents) => {
                 for (const key in moduleComponents) {
                    const component = moduleComponents[key];
                    if (component) {
                        component.position.copy(component.userData.initialPosition);
                        component.rotation.copy(component.userData.initialRotation);
                        component.visible = false;
                    }
                }
            });
            furnitureGroups.forEach(f => {
                f.visible = false;
                f.children.forEach(item => {
                    if(item.material.emissive) item.material.emissiveIntensity = 0;
                });
            });

            craneHook.visible = false;
            craneCable.visible = false;
            if(crane && crane.userData.operator) crane.userData.operator.rotation.y = 0;
            
            fabricationArea.visible = false;
            fabricationArea.children.forEach(child => {
                if(child.name.startsWith('log')) child.visible = true;
            });
            truck.visible = false;
            truck.position.copy(truckStartPosition);

            waterPipe.scale.y = 0.01; waterPipe.position.y = -0.5;
            electricCable.scale.y = 0.01; electricCable.position.y = -0.5;

            setupAnimationTimeline();
        }
        
        /**
         * Adds a camera movement animation to a given GSAP timeline.
         * @param {gsap.core.Timeline} timeline The timeline to add the animation to.
         * @param {THREE.Vector3} targetPosition The position the camera should look at.
         * @param {number} duration The duration of the camera movement.
         * @param {THREE.Vector3} offset The camera's position offset relative to the target.
         * @param {string|number} insertPoint The point in the timeline to insert the animation.
         */
        function addCameraAnimationToTimeline(timeline, targetPosition, duration, offset, insertPoint = ">") {
            timeline.to(camera.position, {
                x: targetPosition.x + offset.x,
                y: targetPosition.y + offset.y,
                z: targetPosition.z + offset.z,
                duration: duration,
                ease: 'power2.inOut'
            }, insertPoint);
            timeline.to(controls.target, {
                x: targetPosition.x,
                y: targetPosition.y,
                z: targetPosition.z,
                duration: duration,
                ease: 'power2.inOut'
            }, insertPoint);
        }

        function createFabricationAndPlacementAction(component, moduleGroup, infoText) {
            const tl = gsap.timeline();
            
            let componentHeight;
            if (component.isGroup) {
                componentHeight = MODULE_HEIGHT;
            } else {
                componentHeight = component.geometry.parameters.height;
            }

            const finalWorldPos = new THREE.Vector3().copy(component.userData.finalPosition).add(moduleGroup.position);
            const pickupPos = new THREE.Vector3().copy(fabricationPosition).add(new THREE.Vector3(5, componentHeight / 2, 0));
            
            // 1. Fabricate. Add camera animation to this local timeline.
            addCameraAnimationToTimeline(tl, fabricationPosition, 2, new THREE.Vector3(0, 15, 20), 0);
            const logsToUse = fabricationArea.children.filter(c => c.name.startsWith('log') && c.visible);
            if (logsToUse.length > 0) {
                const log = logsToUse[logsToUse.length - 1];
                tl.set(infoDisplay, { textContent: `Processing wood for: ${infoText}`})
                  .to(log.position, { x: 0, duration: 1, ease: 'power1.in' })
                  .set(log, { visible: false })
                  .fromTo(fabricationArea.children[1].scale, {x:1,y:1,z:1}, {x:1.05, y:0.95, z:1.05, duration:0.2, yoyo:true, repeat:3});
            }

            // 2. Component appears, move hook to pickup
            tl.set(component, { visible: true })
              .set(infoDisplay, { textContent: `Preparing to lift: ${infoText}`})
              .to(crane.userData.operator.rotation, { y: Math.atan2(pickupPos.x - craneBasePosition.x, pickupPos.z - craneBasePosition.z), duration: 2, ease: 'power2.inOut' }, 'pickup')
              .set(craneHook, { visible: true }, 'pickup')
              .set(craneCable, { visible: true }, 'pickup')
              .to(craneHook.position, { x: pickupPos.x, z: pickupPos.z, duration: 2, ease: 'power2.inOut' }, 'pickup')
              .to(craneHook.position, { y: pickupPos.y + 1, duration: 1.5, ease: 'power1.in' });

            // 3. Attach and lift
            tl.addLabel("lift")
              .add(() => {
                  scene.remove(component);
                  craneHook.add(component);
                  component.position.set(0, -componentHeight / 2, 0); 
                  component.rotation.set(0,0,0);
              }, "lift")
              .to(craneHook.position, { y: 25, duration: 2, ease: 'power1.out' }, 'lift');
              
            // Add camera animation for placement, starting when the lift begins.
            addCameraAnimationToTimeline(tl, finalWorldPos, 4, new THREE.Vector3(-15, 12, 20), "lift");
            
            // 4. Move hook to placement
            tl.set(infoDisplay, { textContent: `Placing: ${infoText}` })
              .to(crane.userData.operator.rotation, { y: Math.atan2(finalWorldPos.x - craneBasePosition.x, finalWorldPos.z - craneBasePosition.z), duration: 3, ease: 'power2.inOut' }, 'place')
              .to(craneHook.position, { x: finalWorldPos.x, z: finalWorldPos.z, duration: 3, ease: 'power2.inOut' }, 'place');

            // 5. Lower and detach
            tl.to(craneHook.position, { y: finalWorldPos.y + componentHeight / 2 + 0.5, duration: 2, ease: 'power2.in' })
              .add(() => {
                  craneHook.remove(component);
                  moduleGroup.add(component);
                  component.position.copy(component.userData.finalPosition);
                  component.rotation.copy(component.userData.initialRotation);
              })
              .to(craneHook.position, { y: 35, duration: 1.5, ease: 'power1.out' });

            return tl;
        }

        function createInteriorFocusAction(moduleGroup) {
            const tl = gsap.timeline({
                onStart: () => { controls.enabled = false; },
                onComplete: () => { controls.enabled = true; }
            });
            const windowPosition = new THREE.Vector3(0, 1.5, MODULE_DEPTH/2 - 0.5);
            moduleGroup.localToWorld(windowPosition);
            
            const cameraTargetPos = windowPosition.clone().add(new THREE.Vector3(0, 0, 3));
            
            tl.set(infoDisplay, {textContent: `Inspecting ${moduleGroup.name}`})
              .to(camera.position, { x: cameraTargetPos.x, y: cameraTargetPos.y, z: cameraTargetPos.z, duration: 2, ease: 'power3.inOut' })
              .to(controls.target, { x: windowPosition.x, y: windowPosition.y, z: windowPosition.z - 2, duration: 2, ease: 'power3.inOut' }, "<")
              .to({}, {duration: 2})
              
            return tl;
        }

        function setupAnimationTimeline() {
            animationTimeline = gsap.timeline({ 
                paused: true, 
                onUpdate: () => {
                    progressSlider.value = animationTimeline.progress() * 100;
                    updateCable();
                },
                onComplete: () => {
                    infoDisplay.textContent = 'Assembly Complete!';
                    playPauseBtn.innerHTML = '<i class="fas fa-redo"></i> Replay';
                    addCameraAnimationToTimeline(animationTimeline, buildingCenter, 2, new THREE.Vector3(30,18,35));
                }
            });

            // Phase 1: Site Prep Timeline
            animationTimeline.addLabel('SitePrep')
                .set(infoDisplay, { textContent: 'Phase 1: Preparing Site' })
                .set(fabricationArea, { visible: true }, "+=0.5");

            // Phase 2: Assembly Timeline
            animationTimeline.addLabel('Assembly', "+=1");
            modules.forEach((moduleComponents, index) => {
                const m_id = `Module ${index + 1}`;
                const moduleGroup = moduleGroups[index];
                const placementOrder = [
                    { comp: moduleComponents.floor, info: `${m_id} Floor` },
                    { comp: moduleComponents.wall_back, info: `${m_id} Back Wall` },
                    { comp: moduleComponents.wall_left, info: `${m_id} Left Wall` },
                    { comp: moduleComponents.wall_right, info: `${m_id} Right Wall` },
                    { comp: moduleComponents.wall_front_frame, info: `${m_id} Front Frame` },
                    { comp: moduleComponents.window_glass, info: `${m_id} Window` },
                    { comp: moduleComponents.door, info: `${m_id} Door` },
                    { comp: moduleComponents.roof, info: `${m_id} Roof` },
                ];
                placementOrder.forEach(item => {
                    animationTimeline.add(createFabricationAndPlacementAction(item.comp, moduleGroup, item.info));
                });
            });

            // Phase 3: Utilities
            animationTimeline.addLabel('Utilities', "+=1")
                .set(infoDisplay, {textContent: 'Phase 3: Connecting Utilities'});
            addCameraAnimationToTimeline(animationTimeline, waterPipe.position, 1.5, new THREE.Vector3(5, 5, 10), 'Utilities');
            animationTimeline.to(waterPipe.scale, {y: 150, duration: 1, ease: 'none'})
                .to(waterPipe.position, {y: 7.5, duration: 1, ease: 'none'}, "<")
                .to(electricCable.scale, {y: 160, duration: 1, ease: 'none'}, "-=0.5")
                .to(electricCable.position, {y: 8, duration: 1, ease: 'none'}, "<");

            // Phase 4: Furnishing Timeline
            animationTimeline.addLabel('Furnishing', "+=1")
                .set(infoDisplay, { textContent: 'Phase 4: Delivering Furniture' })
                .set(truck, {visible: true});
            addCameraAnimationToTimeline(animationTimeline, truckStopPosition, 3, new THREE.Vector3(-15, 8, -15), 'Furnishing');
            animationTimeline.to(truck.position, {x: truckStopPosition.x, duration: 3, ease: 'power2.inOut'});
            
            furnitureGroups.forEach((group) => {
                animationTimeline.fromTo(group.position, 
                    {...truckStopPosition, y: 1}, 
                    {...group.position, duration: 2, ease: 'power2.out'}
                )
                .set(group, {visible: true}, "<")
                .to(group.children.find(c => c.material.emissive).material, {emissiveIntensity: 1, duration: 0.5});
            });

            animationTimeline.to(truck.position, {x: 60, duration: 3, ease: 'power2.in'}, "+=1");

            // Phase 5: Final Inspection Zooms
            animationTimeline.addLabel('Inspection', "+=1");
            moduleGroups.forEach(group => {
                animationTimeline.add(createInteriorFocusAction(group));
            });

            animationTimeline.set(infoDisplay, { textContent: 'Finalizing Structure...' });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('threejs-container');
            if (container && renderer) {
                const w = container.clientWidth;
                const h = container.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            }
        }

        function setupUI() {
            playPauseBtn = document.getElementById('playPauseBtn');
            resetBtn = document.getElementById('resetBtn');
            progressSlider = document.getElementById('progressSlider');
            speedSlider = document.getElementById('speedSlider');
            speedDisplay = document.getElementById('speedDisplay');
            infoDisplay = document.getElementById('info-display');
            toggleControlsBtn = document.getElementById('toggle-controls-btn');
            controlsWrapper = document.getElementById('controls-wrapper');
        }

        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            
            playPauseBtn.addEventListener('click', () => {
                if (animationTimeline.progress() === 1) {
                    resetScene();
                    setTimeout(() => animationTimeline.play(), 100);
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    return;
                }
                animationTimeline.paused(!animationTimeline.paused());
                playPauseBtn.innerHTML = animationTimeline.paused() ? '<i class="fas fa-play"></i> Play' : '<i class="fas fa-pause"></i> Pause';
            });

            resetBtn.addEventListener('click', () => {
                gsap.globalTimeline.clear();
                resetScene();
            });

            progressSlider.addEventListener('input', () => {
                animationTimeline.progress(progressSlider.value / 100).pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                updateCable();
            });

            speedSlider.addEventListener('input', () => {
                const speed = speedSlider.value / 100;
                animationTimeline.timeScale(speed);
                speedDisplay.textContent = `${speed.toFixed(1)}x`;
            });
            speedDisplay.textContent = `${(speedSlider.value / 100).toFixed(1)}x`;

            toggleControlsBtn.addEventListener('click', () => {
                controlsWrapper.classList.toggle('hidden');
                const icon = toggleControlsBtn.querySelector('i');
                const tooltip = toggleControlsBtn.parentElement.querySelector('.tooltiptext');
                if (controlsWrapper.classList.contains('hidden')) {
                    icon.className = 'fas fa-eye';
                    tooltip.textContent = 'Show Controls';
                } else {
                    icon.className = 'fas fa-eye-slash';
                    tooltip.textContent = 'Hide Controls';
                }
            });
            
            const animateCameraView = (pos, target) => {
                gsap.killTweensOf(camera.position);
                gsap.killTweensOf(controls.target);
                controls.enabled = true;
                animationTimeline.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                gsap.to(camera.position, { ...pos, duration: 1.2, ease: 'power3.inOut'});
                gsap.to(controls.target, { ...target, duration: 1.2, ease: 'power3.inOut'});
            }
            document.getElementById('view-perspective').addEventListener('click', () => animateCameraView({ x: 30, y: 18, z: 35 }, buildingCenter));
            document.getElementById('view-top').addEventListener('click', () => animateCameraView({ x: buildingCenter.x, y: 50, z: buildingCenter.z }, buildingCenter));
            document.getElementById('view-side').addEventListener('click', () => animateCameraView({ x: 40, y: 6, z: 0 }, buildingCenter));
        }
        
        init();
    </script>
</body>
</html>
