<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wackybox Incorporated Desktop</title>
    
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        :root {
            /* default theme */
            --theme-bg-primary: #ffffff;
            --theme-bg-secondary: #f0f0f0;
            --theme-bg-tertiary: #e0e0e0;
            --theme-text-primary: #111111;
            --theme-text-secondary: #333333;
            --theme-border-color: rgba(0, 0, 0, 0.1);
            --theme-window-shadow: rgba(0,0,0,0.3);
            --theme-accent-primary: #0078d4;
            --theme-accent-text: #ffffff;
            --theme-icon-text-shadow: rgba(0, 0, 0, 0.8);
            
            /*glss */
            --glass-bg-primary: rgba(255, 255, 255, 0.95);
            --glass-bg-secondary: rgba(240, 240, 240, 0.7);
            --glass-bg-taskbar: rgba(255, 255, 255, 0.6);
            --glass-bg-startmenu: rgba(255, 255, 255, 0.8);
            --glass-blur: 15px;
        }

        .theme-dark {
            --theme-bg-primary: #2b2b2b;
            --theme-bg-secondary: #3c3c3c;
            --theme-bg-tertiary: #4a4a4a;
            --theme-text-primary: #f0f0f0;
            --theme-text-secondary: #e0e0e0;
            --theme-border-color: rgba(255, 255, 255, 0.1);
            --theme-window-shadow: rgba(0,0,0,0.5);
            --theme-accent-primary: #42a5f5;
            --theme-accent-text: #ffffff;
            --theme-icon-text-shadow: rgba(0, 0, 0, 0.9);
        }

        /* bort */
        .graphics-fancy {
            --glass-bg-primary: rgba(255, 255, 255, 0.5);
            --glass-bg-secondary: rgba(240, 240, 240, 0.4);
            --glass-bg-taskbar: rgba(255, 255, 255, 0.25);
            --glass-bg-startmenu: rgba(255, 255, 255, 0.5);
            --glass-blur: 25px;
        }
        .graphics-fancy.theme-dark {
            --glass-bg-primary: rgba(43, 43, 43, 0.5);
            --glass-bg-secondary: rgba(60, 60, 60, 0.4);
            --glass-bg-taskbar: rgba(30, 30, 30, 0.25);
            --glass-bg-startmenu: rgba(43, 43, 43, 0.5);
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100vh; /* Fallback */
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Tahoma', sans-serif;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            background: #2e7141; /* Fallback */
            position: fixed;
            /* NEW: Touch actions for mobile gestures */
            touch-action: pan-y; /* Allow vertical scroll in apps, but... */
        }
        /* ...disable pan-x globally to favor our edge swipe */
        #desktop-root, #mobile-homescreen {
            touch-action: pan-y;
        }

        /* yes*/
        #fancy-wallpaper-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }
        .graphics-fancy #fancy-wallpaper-canvas.visible {
            display: block;
            opacity: 1;
        }

        .desktop {
            height: 100%;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            transition: background 0.5s ease;
        }

        #desktop-icon-container {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            position: absolute;
            top: 0; left: 0;
            /* NEW: Dynamically calculated based on taskbar position */
            height: calc(100% - 30px);
            width: 100%;
            padding: 10px;
            padding-top: calc(10px + env(safe-area-inset-top, 0));
            box-sizing: border-box;
            gap: 10px;
            z-index: 10;
        }

        /* pee as */
        .taskbar-top #desktop-icon-container {
            top: 30px;
            height: calc(100% - 30px);
            padding-top: 10px;
        }
        .taskbar-left #desktop-icon-container {
            left: 70px;
            width: calc(100% - 70px);
        }

        .icon {
            width: 90px;
            height: 100px;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            padding: 5px 0;
            box-sizing: border-box;
            transition: all 0.1s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border-radius: 6px;
        }
        /* tord */
        .icon-size-small .icon { width: 70px; height: 85px; }
        .icon-size-large .icon { width: 110px; height: 120px; }

        .icon:hover, .icon.dragging, .icon.selected {
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px dotted #ffffff;
            transform: scale(1.03);
        }
        .theme-dark .icon:hover, .theme-dark .icon.dragging, .theme-dark .icon.selected {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .icon-img {
            width: 48px;
            height: 48px;
            margin: 5px auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
        }
        .icon-size-small .icon-img { width: 36px; height: 36px; }
        .icon-size-large .icon-img { width: 60px; height: 60px; }

        .icon-name {
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 2px var(--theme-icon-text-shadow);
            word-wrap: break-word;
            padding: 0 2px;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-align: center;
        }
        .icon-size-small .icon-name { font-size: 10px; }
        .icon-size-large .icon-name { font-size: 13px; }

        .window {
            position: absolute;
            width: 600px;
            height: 400px;
            /* NEW: Themed and "Fancy" glass background */
            background: var(--glass-bg-primary);
            box-shadow: 0 8px 32px var(--theme-window-shadow);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            resize: both;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            border-radius: 8px;
            min-width: 250px;
            min-height: 150px;
            border: 1px solid var(--theme-border-color);
            
            transform: scale(1);
            opacity: 1;
            /* new aminations */
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.15s ease-out, top 0.2s ease, left 0.2s ease, width 0.2s ease, height 0.2s ease;
        }
        .window.opening {
            transform: scale(0.9);
            opacity: 0;
        }
        .window.closing {
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.15s ease-in, opacity 0.15s ease-in;
        }
        /* Yours is better*/
        .graphics-fancy .window.minimizing {
            transform: scale(0.1) translate(0, 300px);
            opacity: 0;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: none;
        }

        .window.minimized { display: none; }
        .window.maximized { 
            /* Fancy*/
            top: env(safe-area-inset-top, 0) !important; 
            left: env(safe-area-inset-left, 0) !important; 
            width: calc(100vw - env(safe-area-inset-left, 0) - env(safe-area-inset-right, 0)) !important; 
            height: calc(100vh - 30px - env(safe-area-inset-top, 0) - env(safe-area-inset-bottom, 0)) !important; 
            resize: none; border-radius: 0; 
        }
        /* NEW: Adjust maximized window for taskbar position */
        .taskbar-top .window.maximized {
            top: calc(30px + env(safe-area-inset-top, 0)) !important;
            height: calc(100vh - 30px - env(safe-area-inset-top, 0) - env(safe-area-inset-bottom, 0)) !important; 
        }
        .taskbar-left .window.maximized {
            left: calc(70px + env(safe-area-inset-left, 0)) !important;
            width: calc(100vw - 70px - env(safe-area-inset-left, 0) - env(safe-area-inset-right, 0)) !important; 
        }
        
        .window.maximized .window-header { border-radius: 0; }

        .window-header {
            cursor: move;
            /* NEs */
            background: var(--glass-bg-secondary);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            color: var(--theme-text-secondary);
            padding: 6px 8px;
            font-size: 13px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            user-select: none; 
            border-top-left-radius: 8px; 
            border-top-right-radius: 8px;
            border-bottom: 1px solid var(--theme-border-color);
        }

        .window-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 3px; }
        .window-controls { display: flex; }
        
        .window-controls button {
            background: transparent;
            border: none;
            color: var(--theme-text-secondary);
            width: 28px; height: 28px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            font-weight: normal;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            margin-left: 2px;
            border-radius: 4px;
        }
        .window-controls button:hover { background: rgba(128, 128, 128, 0.2); }
        .window-controls .close-btn { font-weight: bold; font-size: 18px; line-height: 26px; }
        .window-controls .close-btn:hover { background: #e81123; color: white; }

        .window-content {
            flex-grow: 1; padding: 2px; 
            /* NEed */
            background-color: var(--theme-bg-primary);
            overflow: auto; font-size: 12px; 
            color: var(--theme-text-primary);
            border: none;
        }

        .taskbar {
            position: absolute; bottom: 0; left: 0; 
            width: 100%; height: 30px;
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            height: calc(30px + env(safe-area-inset-bottom, 0));
            /*  and "Fa */
            background: var(--glass-bg-taskbar);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-top: 1px solid var(--theme-border-color);
            z-index: 9000; display: flex;
            align-items: center; padding: 0 5px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        /* Nns */
        .taskbar-top .taskbar {
            top: 0; bottom: auto;
            border-top: none;
            border-bottom: 1px solid var(--theme-border-color);
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: 0;
            height: calc(30px + env(safe-area-inset-top, 0));
        }
        .taskbar-left .taskbar {
            top: 0; left: 0;
            width: 70px;
            height: 100%;
            flex-direction: column;
            padding: 5px 0;
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            border-top: none;
            border-right: 1px solid var(--theme-border-color);
        }

        .start-button {
            background: #479e2c;
            color: white; font-weight: bold; padding: 2px 12px; border-radius: 4px;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 14px; font-style: italic;
            transition: background 0.1s;
        }
        .start-button:hover { background: #5ac03a; }
        .start-button:active { background: #3f8a26; }

        .task-items { flex-grow: 1; height: 100%; display: flex; align-items: center; margin-left: 10px; gap: 4px; }
        .taskbar-left .task-items { flex-direction: column; margin-left: 0; margin-top: 10px; width: 100%; height: auto; }

        .task-item {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--theme-text-secondary);
            padding: 2px 8px;
            height: 22px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
            white-space: nowrap; font-size: 12px; cursor: pointer;
            border-radius: 4px;
        }
        .theme-dark .task-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .taskbar-left .task-item { max-width: 100%; width: 50px; height: 40px; writing-mode: vertical-rl; text-orientation: mixed; }

        .task-item.active { 
            background: rgba(255, 255, 255, 0.7);
            font-weight: bold;
            border-color: rgba(0, 0, 0, 0.2);
        }
        .theme-dark .task-item.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        #start-menu {
            position: absolute; 
            bottom: calc(30px + env(safe-area-inset-bottom, 0)); 
            left: env(safe-area-inset-left, 0); 
            width: 250px;
            /* NEW: Themed and "Fancy" glass */
            background: var(--glass-bg-startmenu);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--theme-border-color);
            border-bottom: none;
            border-top-right-radius: 6px;
            z-index: 8999;
            color: var(--theme-text-primary);
            
            display: block;
            visibility: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, visibility 0s 0.2s;
        }
        /* NEW PISS */
        .taskbar-top #start-menu {
            bottom: auto;
            top: calc(30px + env(safe-area-inset-top, 0));
            transform: translateY(-20px) scale(0.95);
        }
        .taskbar-left #start-menu {
            bottom: env(safe-area-inset-bottom, 0);
            left: calc(70px + env(safe-area-inset-left, 0));
            transform: translateX(20px) scale(0.95);
        }

        #start-menu.open {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .taskbar-top #start-menu.open { transform: translateY(0) scale(1); }
        .taskbar-left #start-menu.open { transform: translateX(0) scale(1); }

        #start-menu-content { padding: 5px; }
        .menu-section { border-top: 1px solid var(--theme-border-color); margin-top: 5px; padding-top: 5px; }
        .menu-item { 
            padding: 5px 10px; cursor: pointer; display: flex; 
            align-items: center; gap: 8px; border-radius: 4px; 
        }
        .menu-item:hover { background: var(--theme-accent-primary); color: var(--theme-accent-text); }
        .menu-icon { width: 24px; height: 24px; }

        .password-modal, .app-launch-prompt {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            text-align: center;
            height: 100%;
            justify-content: center;
            box-sizing: border-box;
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
        }
        .password-modal input[type="password"] {
            padding: 8px;
            border: 1px solid var(--theme-border-color);
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            border-radius: 4px;
            width: 90%;
            text-align: center;
        }
        .password-modal button, .app-launch-prompt-buttons button {
            padding: 8px 16px;
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            border: 1px solid var(--theme-border-color);
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .password-modal button:active, .app-launch-prompt-buttons button:active {
            background: var(--theme-bg-tertiary);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .error-message {
            color: red;
            font-weight: bold;
            height: 15px;
            font-size: 11px;
        }
        .app-launch-prompt p { margin: 0 0 15px 0; font-size: 13px; }
        .app-launch-prompt-buttons { display: flex; justify-content: center; gap: 15px; }
        .app-launch-prompt-buttons button { min-width: 100px; }

        .folder-grid { display: flex; flex-wrap: wrap; padding: 5px; gap: 5px; }
        .folder-grid .icon { position: static; padding: 2px; }
        .folder-grid .icon:hover { background-color: rgba(0, 85, 255, 0.3); border: 1px dotted #ffffff; }
        
        /* Fucking Icons SVG --- */
        .icon-img.folder { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFD700' d='M10 4H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16c1.11 0 2-.89 2-2V8a2 2 0 00-2-2h-8l-2-2z'/%3E%3C/svg%3E"); }
        .icon-img.locked-folder { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000000' d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E"); }
        .icon-img.document { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFFFFF' stroke='%233B76CC' stroke-width='1.5' d='M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm4 18H6V4h7v4h4v12z'/%3E%3C/svg%3E"); }
        .icon-img.code { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%236C757D' d='M14.6 16.6l-1.2-1.2 3.4-3.4-3.4-3.4 1.2-1.2 4.6 4.6zm-5.2 0l-4.6-4.6 4.6-4.6 1.2 1.2-3.4 3.4 3.4 3.4-1.2 1.2z'/%3E%3C/svg%3E"); }
        .icon-img.audio { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234CAF50' d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'/%3E%3C/svg%3E"); }
        .icon-img.video { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23F44336' d='M18 10l4-4v12l-4-4H4a2 2 0 01-2-2v-4a2 2 0 012-2h14z'/%3E%3C/svg%3E"); }
        .icon-img.image { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%232196F3' d='M19 5v14H5V5h14m0-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zM8.5 10.5l2.5 3.01L14.5 9L19 16.5V19H5v-2.5l3.5-4.5z'/%3E%3C/svg%3E"); }
        .icon-img.zip { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000000' d='M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2M18 20H6V4H13V9H18V20M11 19H13V18H11V19M11 17H13V16H11V17M11 15H13V14H11V15M11 13H13V12H11V13M15 13V12H13V11H15V10H13V9H15V8H13C11.9 8 11 8.9 11 10V11H9V10H7V11H9V12H7V13H9V14H7V15H9V16H7V17H9V18H7V19H9V20H11C11 21.1 11.9 22 13 22H15V21H13V20H15V19H13V18H15V17H13V16H15V15H13V14H15V13Z'/%3E%3C/svg%3E"); }
        .icon-img.unknown { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23AAAAAA' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-chat { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2342A5F5' d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-draw { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FF7043' d='M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-globe { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2326C6DA' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-present { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFA726' d='M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zM5 15h2v-2H5v2zm0-4h2V9H5v2zm0-4h2V5H5v2zm4 8h10V5H9v10z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-computer { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%238BC34A' d='M20 18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-space { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%237E57C2' d='M12 2c-3.97 0-7.65 1.58-10.33 4.21.34.05.68.08 1.03.08 3.4 0 6.34-2.02 7.8-5.02.43-.88 1.3-1.42 2.27-1.42.4 0 .78.1.13.29C15.89 2.1 19.53 4.22 22 7.55c-1.39-2.04-3.5-3.53-5.83-4.44-.31-.11-.5-.41-.5-.75 0-.55-.45-1-1-1-1.34 0-2.61.34-3.77.95zM4.26 8.33C4.09 9.17 4 10.07 4 11c0 4.41 3.59 8 8 8s8-3.59 8-8c0-1.99-.74-3.8-1.97-5.26C16.92 6.53 14.59 7 12 7c-2.05 0-4.14-.3-5.85-.92-.61-.22-1.28.26-1.28.92.01.2.06.39.14.57zM12 9c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5 2.24-5 5-5z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-notepad { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFFFFF' stroke='%23333' stroke-width='1.5' d='M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z'/%3E%3Cpath fill='%23B0BEC5' d='M13 3.5V9h5.5L13 3.5z'/%3E%3Cpath fill='%23546E7A' d='M6 14h12v1H6zM6 16h12v1H6zM6 12h12v1H6zM6 10h8v1H6z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-settings { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23607D8B' d='M19.4 12.9c.1-.3.1-.6.1-.9s0-.6-.1-.9l2.1-1.6c.2-.1.2-.4.1-.6l-2-3.5c-.1-.2-.4-.2-.6-.1l-2.5 1c-.5-.4-1-.7-1.5-.9l-.4-2.7c0-.2-.2-.4-.4-.4h-4c-.2 0-.4.2-.4.4l-.4 2.7c-.5.2-1 .5-1.5.9l-2.5-1c-.2-.1-.5 0-.6.1l-2 3.5c-.1.2-.1.5.1.6l2.1 1.6c-.1.3-.1.6-.1.9s0 .6.1.9l-2.1 1.6c-.2.1-.2.4-.1.6l2 3.5c.1.2.4.2.6.1l2.5-1c.5.4 1 .7 1.5.9l.4 2.7c0 .2.2.4.4.4h4c.2 0 .4-.2.4.4l.4-2.7c-.5-.2 1-.5 1.5-.9l2.5 1c.2.1.5 0 .6-.1l2-3.5c.1-.2.1-.5-.1-.6l-2.1-1.6zM12 15.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z'/%3E%3C/svg%3E"); }
        /* NEW: Icons for 5 new apps */
        .icon-img.webapp-browser { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2303A9F4' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3Cpath fill='%2303A9F4' d='M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z'/%3E%3Cpath fill='%23FFFFFF' d='M12 12m-2 0a2 2 0 104 0 2 2 0 10-4 0'/%3E%3C/svg%3E"); }
        .icon-img.webapp-explorer { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFC107' d='M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z'/%3E%3Cpath fill='%23FFFFFF' d='M19.5 17h-11c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h11c.28 0 .5.22.5.5s-.22.5-.5.5zm0-3h-11c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h11c.28 0 .5.22.5.5s-.22.5-.5.5zm0-3h-11c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h11c.28 0 .5.22.5.5s-.22.5-.5.5z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-about { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%239C27B0' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-terminal { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234CAF50' d='M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm1 4l4 4-4 4V8zm5 0v1.5l2.5 2.5L10 14.5V16l4-4-4-4z'/%3E%3C/svg%3E"); }
        .icon-img.webapp-themes { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23E91E63' d='M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-1.1-1.12-1.8-2.61-1.97-4.22-.2-.2-.37-.43-.51-.68-.35-.63-.53-1.35-.53-2.11 0-1.03.32-1.97.87-2.73.6-.81 1.4-1.42 2.37-1.72-.11-.47-.17-.96-.17-1.47 0-2.03.62-3.89 1.69-5.39C14.73 3.2 13.4 3 12 3zm1.13 3.02c-.36-.08-.74-.13-1.13-.13-.97 0-1.89.21-2.73.58.53.84.87 1.83.96 2.9.22.25.48.47.76.66.8.52 1.77.82 2.82.82.7 0 1.37-.15 1.99-.41-.19-.89-.59-1.7-1.16-2.39-.23-.28-.48-.53-.75-.75-.24-.19-.49-.36-.76-.5zM18 13c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E"); }


        /* mobel ui */
        #mobile-homescreen {
            display: none;
            height: 100%;
            width: 100%;
            position: relative;
        }
        #mobile-icon-pages {
            width: 100%;
            height: 100%;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0)); /* Space for dots */
            box-sizing: border-box;
        }
        #mobile-icon-pages::-webkit-scrollbar { display: none; }

        .mobile-page {
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            scroll-snap-align: start;
            display: grid;
            /* NEW: Icon size classes for mobile */
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            grid-auto-rows: 95px;
            gap: 10px;
            padding: 15px;
            box-sizing: border-box;
            align-content: flex-start;
        }
        .icon-size-small .mobile-page {
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
            grid-auto-rows: 85px;
        }
        .icon-size-large .mobile-page {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            grid-auto-rows: 115px;
        }

        .mobile-page .icon { 
            position: static;
            width: auto;
            height: 100%; /* Fill the grid row hieeeeeght*/
        }
        .mobile-page .icon:hover, .mobile-page .icon:active {
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px dotted #ffffff;
            transform: scale(1.03);
        }

        #mobile-page-dots {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0) + 5px);
            box-sizing: border-box;
            z-index: 20;
        }
        .dot {
            width: 8px; height: 8px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transition: background 0.3s;
        }
        .dot.active { background: white; }

        #mobile-top-bar {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: calc(30px + env(safe-area-inset-top, 0));
            padding-top: env(safe-area-inset-top, 0);
            padding-left: calc(10px + env(safe-area-inset-left, 0));
            padding-right: calc(10px + env(safe-area-inset-right, 0));
            /* shit glass */
            background: var(--glass-bg-taskbar);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            z-index: 10000;
            display: none;
            color: var(--theme-text-primary);
            align-items: center;
            justify-content: space-between;
            box-sizing: border-box;
            border-bottom: 1px solid var(--theme-border-color);
        }
        /* Dark the text */
        .theme-dark #mobile-top-bar {
            color: var(--theme-text-primary);
        }

        #mobile-menu-btn {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        #mobile-clock {
            font-weight: 500;
        }
        
        #mobile-app-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: var(--theme-bg-primary);
            z-index: 9998;
            display: none;
            overflow: hidden;
            /* Respect all safe areas */
            padding-top: env(safe-area-inset-top, 0);
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            box-sizing: border-box;
        }

        .mobile-app-page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: absolute;
            /* Inset the page to account for container padding */
            top: 0; left: 0;
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            z-index: 1000;
        }
        .mobile-app-page.active {
            transform: translateX(0);
            z-index: 1001; /* Active page is on top */
        }
        .mobile-app-page.inactive-behind {
            transform: translateX(0);
            z-index: 999; /* Page behind the active one */
        }
        .mobile-app-page.closing {
            transform: translateX(100%);
            z-index: 1001; /* Keep on top while closing */
        }
        .mobile-app-page.opening {
            transform: translateX(100%);
        }

        .mobile-app-header {
            width: 100%;
            height: 40px;
            background: var(--theme-bg-secondary);
            border-bottom: 1px solid var(--theme-border-color);
            color: var(--theme-text-primary);
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .mobile-app-title {
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
            text-align: center;
        }
        .mobile-app-back-btn,
        .mobile-app-close-btn {
            font-size: 24px;
            font-weight: bold;
            color: var(--theme-text-secondary);
            cursor: pointer;
            padding: 0 8px;
        }
        .mobile-app-back-btn {
            font-size: 28px;
            font-weight: normal;
        }

        .mobile-app-content {
            flex-grow: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        .mobile-app-content > * {
            flex-grow: 1;
        }
        .mobile-app-content .window-content {
            padding: 0;
            height: 100%;
        }

        #mobile-sidebar {
            position: absolute;
            top: 0; left: 0;
            width: 250px;
            height: 100%;
            /* NEW: Glass and theme */
            background: var(--glass-bg-startmenu);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            z-index: 10001;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            color: var(--theme-text-primary);
            display: none;
            flex-direction: column;
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            box-sizing: border-box;
            border-right: 1px solid var(--theme-border-color);
        }
        #mobile-sidebar.open {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 10px;
            padding-left: calc(10px + env(safe-area-inset-left, 0));
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid var(--theme-border-color);
        }
        .sidebar-button {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            padding-left: calc(15px + env(safe-area-inset-left, 0));
            gap: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        .sidebar-button:hover, .sidebar-button:active {
            background: var(--theme-accent-primary);
            color: var(--theme-accent-text);
        }
        #mobile-task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }
        .mobile-task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            padding-left: calc(15px + env(safe-area-inset-left, 0));
            border-bottom: 1px solid var(--theme-border-color);
            font-size: 13px;
        }
        .mobile-task-item:hover {
            background: rgba(128, 128, 128, 0.2);
        }
        .mobile-task-item.active {
            background: var(--theme-accent-primary);
            color: var(--theme-accent-text);
            font-weight: bold;
        }
        .mobile-task-item-name {
            flex-grow: 1;
            padding-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .mobile-task-item-close {
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .mobile-task-item-close:hover {
            background: rgba(255, 0, 0, 0.7);
        }

        #mobile-sidebar-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        #mobile-sidebar-overlay.open {
            display: block;
            opacity: 1;
        }

        /* --- Built-in App Styles (Themed) --- */

        #calculator {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            font-family: 'Segoe UI', 'Tahoma', sans-serif;
        }
        #calc-display {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            text-align: right;
            padding: 20px;
            font-size: clamp(2em, 10vw, 3em);
            font-weight: 300;
            box-sizing: border-box;
            border: none;
            width: 100%;
            flex-shrink: 0;
        }
        #calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            flex-grow: 1;
        }
        .calc-btn {
            background: var(--theme-bg-tertiary);
            border: 1px solid var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            font-size: clamp(1.2em, 5vw, 1.8em);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calc-btn:active {
            filter: brightness(0.85);
        }
        .calc-btn.op { background: #ff9500; color: white; }
        .calc-btn.op:active { background: #e08400; }
        .calc-btn.func { background: var(--theme-bg-tertiary); filter: brightness(0.9); }
        .calc-btn.zero { grid-column: span 2; }

        #clock-app {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            font-family: 'DS-Digital', 'Lucida Console', monospace;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
        }
        #clock-time {
            font-size: clamp(3em, 20vw, 8em);
            letter-spacing: 2px;
            color: var(--theme-accent-primary);
        }
        #clock-date {
            font-size: clamp(1em, 5vw, 2em);
        }

        #notepad-app {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #notepad-textarea {
            flex-grow: 1;
            border: none;
            padding: 10px;
            font-family: 'Lucida Console', monospace;
            font-size: 14px;
            resize: none;
            box-sizing: border-box;
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
        }
        #notepad-textarea:focus {
            outline: none;
        }

        /* Settings App */
        #settings-app {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
        }
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-bottom: 1px solid var(--theme-border-color);
            padding-bottom: 15px;
        }
        .setting-group label {
            font-weight: bold;
            font-size: 16px;
        }
        .setting-group select, .setting-group button, .setting-group input[type="text"] {
            padding: 8px;
            font-size: 14px;
            border: 1px solid var(--theme-border-color);
            border-radius: 4px;
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
        }
        .setting-group input[type="checkbox"] {
            width: 18px; height: 18px;
        }
        .setting-group-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .setting-group small {
            font-size: 12px;
            color: var(--theme-text-secondary);
        }
        #add-custom-app-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
		/* --- NEW: Taskbar Autohide --- */
        .taskbar {
            transition: transform 0.2s ease-in-out;
        }
        /* Hide states */
        .taskbar-autohide.taskbar-bottom .taskbar { transform: translateY(calc(100% - 3px)); }
        .taskbar-autohide.taskbar-bottom .taskbar:hover { transform: translateY(0); }
        
        .taskbar-autohide.taskbar-top .taskbar { transform: translateY(calc(-100% + 3px)); }
        .taskbar-autohide.taskbar-top .taskbar:hover { transform: translateY(0); }

        .taskbar-autohide.taskbar-left .taskbar { transform: translateX(calc(-100% + 3px)); }
        .taskbar-autohide.taskbar-left .taskbar:hover { transform: translateX(0); }
        
        /* Adjust content when autohide is enabled */
        .taskbar-autohide #desktop-icon-container,
        .taskbar-autohide.taskbar-top #desktop-icon-container,
        .taskbar-autohide.taskbar-left #desktop-icon-container {
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            padding-top: calc(10px + env(safe-area-inset-top, 0)); /* Back to default */
        }
        
        .taskbar-autohide .window.maximized,
        .taskbar-autohide.taskbar-top .window.maximized,
        .taskbar-autohide.taskbar-left .window.maximized {
            top: env(safe-area-inset-top, 0) !important; 
            left: env(safe-area-inset-left, 0) !important; 
            width: calc(100vw - env(safe-area-inset-left, 0) - env(safe-area-inset-right, 0)) !important; 
            height: calc(100vh - env(safe-area-inset-top, 0) - env(safe-area-inset-bottom, 0)) !important; 
        }

        /* --- NEW: Custom App Management in Settings --- */
        #custom-apps-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--theme-border-color);
            border-radius: 4px;
            background: var(--theme-bg-secondary);
        }
        .custom-app-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--theme-border-color);
        }
        .custom-app-item:last-child {
            border-bottom: none;
        }
        .custom-app-item-name {
            font-size: 13px;
            font-weight: 500;
        }
        .custom-app-item-url {
            font-size: 11px;
            color: var(--theme-text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-left: 10px;
        }
        .custom-app-item-remove {
            background: #e81123;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 10px;
        }

        /* --- NEW: Theme Studio Customizations --- */
        #custom-gradient-creator {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 10px;
            border-top: 1px solid var(--theme-border-color);
            margin-top: 10px;
        }
        #custom-gradient-creator .setting-group-row {
            gap: 10px;
        }
        #custom-gradient-creator input[type="color"] {
            width: 50px;
            height: 35px;
            padding: 2px;
            border: 1px solid var(--theme-border-color);
        }
        #custom-gradient-creator select {
            flex-grow: 1;
        }
        #custom-gradient-creator button, 
        #wallpaper-upload-btn {
            padding: 8px;
            font-size: 14px;
            border: 1px solid var(--theme-border-color);
            border-radius: 4px;
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            cursor: pointer;
        }
        #wallpaper-upload {
            font-size: 12px;
            flex-grow: 1;
        }
        #wallpaper-upload::-webkit-file-upload-button {
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            border: 1px solid var(--theme-border-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        @media (min-width: 600px) {
            #add-custom-app-form {
                grid-template-columns: 1fr 1fr auto;
            }
        }
        
        /* --- NEW APP: Browser --- */
        #browser-app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #browser-nav {
            display: flex;
            padding: 5px;
            background: var(--theme-bg-secondary);
            border-bottom: 1px solid var(--theme-border-color);
            gap: 5px;
        }
        #browser-nav button {
            font-size: 16px;
            width: 30px;
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            border: 1px solid var(--theme-border-color);
            border-radius: 4px;
        }
        #browser-url {
            flex-grow: 1;
            border: 1px solid var(--theme-border-color);
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            border-radius: 4px;
            padding: 5px;
        }
        #browser-frame {
            flex-grow: 1;
            border: none;
        }

        /* --- NEW APP: File Explorer --- */
        #explorer-app {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            align-content: flex-start;
        }
        #explorer-app .icon {
            position: static;
        }
        #explorer-app .icon .icon-name {
            color: var(--theme-text-primary);
            text-shadow: none;
        }

        /* --- NEW APP: About --- */
        #about-app {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 15px;
            padding: 20px;
        }
        #about-app .icon-img {
            width: 80px;
            height: 80px;
        }

        /* --- NEW APP: Terminal --- */
        #terminal-app {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Lucida Console', monospace;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
        }
        #terminal-output {
            flex-grow: 1;
            white-space: pre-wrap;
            word-break: break-all;
        }
        #terminal-input-line {
            display: flex;
        }
        #terminal-prompt {
            white-space: pre;
        }
        #terminal-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Lucida Console', monospace;
        }
        #terminal-input:focus {
            outline: none;
        }

        /* --- NEW APP: Theme Studio --- */
        #theme-app {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #theme-mode-toggle {
            display: flex;
            gap: 10px;
        }
        .theme-mode-btn {
            flex-grow: 1;
            padding: 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .theme-mode-btn.light {
            background: #f0f0f0;
            color: #111;
        }
        .theme-mode-btn.dark {
            background: #3c3c3c;
            color: #f0f0f0;
        }
        .theme-mode-btn.active {
            border-color: var(--theme-accent-primary);
        }
        #wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .wallpaper-preview {
            height: 70px;
            border-radius: 6px;
            border: 2px solid var(--theme-border-color);
            cursor: pointer;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .wallpaper-preview:hover {
            transform: scale(1.05);
        }
        .wallpaper-preview.active {
            border-color: var(--theme-accent-primary);
            box-shadow: 0 0 10px var(--theme-accent-primary);
        }
        .wallpaper-preview .name {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 11px;
            text-align: center;
            padding: 2px 0;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* --- Media Query --- */
        @media (max-width: 768px), (max-height: 500px) and (orientation: landscape) {
            /* Hide Desktop UI */
            #desktop-icon-container { display: none; }
            .taskbar, #start-menu { display: none !important; }
            .window { display: none !important; } /* Hide all desktop-style windows */

            /* Show Mobile UI */
            #mobile-homescreen { display: block; }
            #mobile-top-bar { display: flex; }
            #mobile-sidebar { display: flex; }
        }
        
    </style>
</head>
<body class="theme-light"> <!-- a -->

<div class="desktop" id="desktop-root">
    
    <canvas id="fancy-wallpaper-canvas"></canvas>
    
    <div id="desktop-icon-container" class="icon-container icon-size-medium"></div>
    <div id="window-area"></div>
    <div id="start-menu">
        <div id="start-menu-content">
            <h4>Programs</h4>
            <div id="start-programs"></div>
            <div class="menu-section">
                <h4>Documents</h4>
                <div id="start-docs"></div>
            </div>
        </div>
    </div>
    <div class="taskbar taskbar-bottom">
        <div id="start-button" class="start-button">Start</div>
        <div id="task-items" class="task-items"></div>
    </div>
    
    <div id="mobile-top-bar">
        <span id="mobile-menu-btn">&#9776;</span>
        <span id="mobile-clock"></span>
    </div>
    
    <div id="mobile-homescreen">
        <div id="mobile-icon-pages" class="icon-size-medium"></div>
        <div id="mobile-page-dots"></div>
    </div>
    
    <div id="mobile-app-container">
        </div>
    
    <div id="mobile-sidebar">
        <div class="sidebar-header">wbOS!</div>
        <div class="sidebar-button" id="mobile-home-btn">
            <span style="font-size: 20px;">&#8962;</span> <span>Home</span>
        </div>
        <div class="sidebar-header" style="font-size: 14px; padding-top: 15px;">Open Apps</div>
        <ul id="mobile-task-list">
            </ul>
    </div>
    <div id="mobile-sidebar-overlay"></div>

</div>

<script>
    const BASE_URL = 'https://wackybox.org/';
    const MEDIA_PLAYER_APP_URL = `${BASE_URL}media?=`;

    let desktopItems = [];
    let customDesktopItems = []; // Neb apps
    let LOCKED_FOLDER = {};
    let highestZIndex = 1000;
    let openWindows = {}; // handles Both desktop windows and mobile apps
    let openMobileAppOrder = []; // Stack for mobile app history
    
    let audioCache = {}; // the: For preloaded UI sounds
    
    const isMobile = () => window.matchMedia("(max-width: 768px), (max-height: 500px) and (orientation: landscape)").matches;
    
    // the: Greatly expanded default settings
    let appSettings = {
        wallpaper: 'default',
        wallpaperCustom: null, // the: For base64 image or gradient
        theme: 'light',
        graphics: 'simple',
        taskbarPosition: 'bottom',
        iconSize: 'medium',
        alwaysOpenInWindow: false,
        taskbarAutohide: false, // the: Taskbar autohide
        uiSounds: { // the: UI Sound settings
            enabled: false,
            volume: 0.5,
            click: '',
            windowOpen: '',
            windowClose: '',
            error: ''
        }
    };
    const SETTINGS_KEY = 'wackybox_settings_v2';
    const CUSTOM_APPS_KEY = 'wackybox_custom_apps_v1'; // the: For custom apps

    // --- Settings Management ---
   // --- Settings Management ---
    function saveSettings() {
        try {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        } catch (e) {
            console.error("Failed to save settings:", e);
        }
    }
    
    // the: Function to save custom apps
    function saveCustomApps() {
        try {
            localStorage.setItem(CUSTOM_APPS_KEY, JSON.stringify(customDesktopItems));
        } catch (e) {
            console.error("Failed to save custom apps:", e);
        }
    }

    function loadSettings() {
        // Load main app settings
        try {
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) {
                appSettings = { ...appSettings, ...JSON.parse(savedSettings) }; // Merge defaults with saved
            }
        } catch (e) {
            console.error("Failed to load settings:", e);
            // appSettings remains default
        }
        
        // the: Load custom apps
        try {
            const savedCustomApps = localStorage.getItem(CUSTOM_APPS_KEY);
            if (savedCustomApps) {
                customDesktopItems = JSON.parse(savedCustomApps);
            }
        } catch (e) {
            console.error("Failed to load custom apps:", e);
            customDesktopItems = [];
        }
        
        // the: Preload UI sounds
        preloadUISounds();
        
        applySettings();
    }
    
    // the: Greatly expanded applySettings
    // the: Greatly expanded applySettings
    function applySettings() {
        const desktop = document.getElementById('desktop-root');
        const body = document.body;

        // 1. Theme (Light/Dark)
        body.className = `theme-${appSettings.theme}`;
        
        // 2. Graphics (Simple/Fancy)
        if (appSettings.graphics === 'fancy') {
            body.classList.add('graphics-fancy');
            initFancyWallpaper();
        } else {
            body.classList.remove('graphics-fancy');
            destroyFancyWallpaper();
        }
        
        // 3. Wallpaper
        const wallpaperCanvas = document.getElementById('fancy-wallpaper-canvas');
        switch(appSettings.wallpaper) {
            case 'ocean':
                desktop.style.background = 'radial-gradient(circle at 80% 80%, #a2d2ff 0%, #3a86ff 50%, #003566 100%)';
                break;
            case 'solid':
                desktop.style.background = '#4a5759';
                break;
            // the Themes
            case 'sunset':
                desktop.style.background = 'linear-gradient(to top, #f3904f, #3b4371)';
                break;
            case 'forest':
                desktop.style.background = 'linear-gradient(to bottom, #134e5e, #71b280)';
                break;
            case 'nebula':
                desktop.style.background = 'radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%)';
                break;
            // the: Custom wallpaper/gradient
            case 'custom':
                if (appSettings.wallpaperCustom) {
                    // Check if it's a base64 image or a gradient
                    if (appSettings.wallpaperCustom.startsWith('data:image')) {
                        desktop.style.background = `url(${appSettings.wallpaperCustom})`;
                        desktop.style.backgroundSize = 'cover';
                        desktop.style.backgroundPosition = 'center';
                    } else {
                        // Assume gradient
                        desktop.style.background = appSettings.wallpaperCustom;
                    }
                } else {
                    // Fallback if custom is selected but not set
                    desktop.style.background = 'radial-gradient(circle at 10% 90%, #6ec25d 0%, #3a8542 50%, #2e7141 100%)';
                }
                break;
            case 'default':
            default:
                desktop.style.background = 'radial-gradient(circle at 10% 90%, #6ec25d 0%, #3a8542 50%, #2e7141 100%)';
                break;
        }
        // Hide canvas if wallpaper is not 3D-compatible (or just hide it always for now)
        // wallpaperCanvas.classList.toggle('visible', appSettings.graphics === 'fancy');

        // 4. Taskbar Position
        const taskbar = document.querySelector('.taskbar');
        const startMenu = document.getElementById('start-menu');
        const container = document.getElementById('desktop-icon-container');
        
        // Reset classes
        taskbar.className = 'taskbar';
        startMenu.className = 'start-menu';
        container.style.top = ''; container.style.left = ''; container.style.width = ''; container.style.height = '';
        body.classList.remove('taskbar-top', 'taskbar-left', 'taskbar-autohide'); // Clear all taskbar classes
        
        taskbar.classList.add(`taskbar-${appSettings.taskbarPosition}`);
        body.classList.add(`taskbar-${appSettings.taskbarPosition}`); // For global rules
        
        // the: Apply autohide class
        if (appSettings.taskbarAutohide) {
            body.classList.add('taskbar-autohide');
        }
        
        // 5. Icon Size
        const iconContainers = [container, document.getElementById('mobile-icon-pages')];
        iconContainers.forEach(cont => {
            if (!cont) return;
            cont.classList.remove('icon-size-small', 'icon-size-medium', 'icon-size-large');
            cont.classList.add(`icon-size-${appSettings.iconSize}`);
        });
        
        // Re-render UI needed for icon size change on mobile
        if (isMobile()) {
            renderMobileIcons();
        }
    }
    // --- NEW: Fancy 3D Wallpaper ---
    let fancyWallpaper = {
        scene: null, camera: null, renderer: null, particles: null,
        animationFrameId: null, container: null
    };

    function initFancyWallpaper() {
        if (fancyWallpaper.renderer || appSettings.graphics !== 'fancy') return; // Already running or not allowed

        fancyWallpaper.container = document.getElementById('fancy-wallpaper-canvas');
        if (!fancyWallpaper.container) return;
        
        fancyWallpaper.container.classList.add('visible');
        fancyWallpaper.container.style.zIndex = '0';
        fancyWallpaper.scene = new THREE.Scene();
        fancyWallpaper.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        fancyWallpaper.renderer = new THREE.WebGLRenderer({ canvas: fancyWallpaper.container, alpha: true });
        fancyWallpaper.renderer.setSize(window.innerWidth, window.innerHeight);
        fancyWallpaper.renderer.setClearColor(0x000000, 0); // Transparent background

        const particleCount = 5000;
        const particles = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        const color = new THREE.Color();

        for (let i = 0; i < particleCount; i++) {
            positions[i * 3] = (Math.random() - 0.5) * 20;
            positions[i * 3 + 1] = (Math.random() - 0.5) * 20;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 20;
            
            color.setHSL(Math.random(), 0.7, 0.7);
            colors[i * 3] = color.r;
            colors[i * 3 + 1] = color.g;
            colors[i * 3 + 2] = color.b;
        }
        particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        
        const material = new THREE.PointsMaterial({
            size: 0.05,
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            transparent: true,
            opacity: 0.75
        });
        
        fancyWallpaper.particles = new THREE.Points(particles, material);
        fancyWallpaper.scene.add(fancyWallpaper.particles);
        fancyWallpaper.camera.position.z = 5;

        const onWindowResize = () => {
            if (!fancyWallpaper.renderer) return;
            fancyWallpaper.camera.aspect = window.innerWidth / window.innerHeight;
            fancyWallpaper.camera.updateProjectionMatrix();
            fancyWallpaper.renderer.setSize(window.innerWidth, window.innerHeight);
        };
        window.addEventListener('resize', onWindowResize, false);

        const animate = () => {
            fancyWallpaper.animationFrameId = requestAnimationFrame(animate);
            const time = Date.now() * 0.0001;
            fancyWallpaper.particles.rotation.x = time * 0.25;
            fancyWallpaper.particles.rotation.y = time * 0.5;
            fancyWallpaper.renderer.render(fancyWallpaper.scene, fancyWallpaper.camera);
        };
        animate();
    }

    function destroyFancyWallpaper() {
        if (fancyWallpaper.animationFrameId) {
            cancelAnimationFrame(fancyWallpaper.animationFrameId);
        }
        if (fancyWallpaper.renderer) {
            fancyWallpaper.renderer.dispose();
            fancyWallpaper.renderer.domElement.remove();
            fancyWallpaper.renderer = null;
        }
        if (fancyWallpaper.container) {
            fancyWallpaper.container.classList.remove('visible');
        }
        fancyWallpaper = { scene: null, camera: null, renderer: null, particles: null, animationFrameId: null, container: fancyWallpaper.container };
    }


    // --- Desktop Initialization ---
    // --- Desktop Initialization ---
    // --- Desktop Initialization ---
    async function initializeDesktop() {
        loadSettings();
        
        let rawDesktopItems = [];

        // --- FIXED: Fetch and parse desktop-items.json ---
        try {
            const response = await fetch('desktop-items.json');
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
            }
            rawDesktopItems = await response.json();
        } catch (e) {
            console.error("Failed to load desktop items:", e);
            openErrorWindow('desktop-items.json', 'Could not load desktop items. ' + e.message);
        }
        
        // This is the vaginal.
        const filteredDesktopItems = rawDesktopItems;
        
        
        LOCKED_FOLDER = {
            name: "Wackycom media vault",
            type: "locked_folder",
            class: "locked-folder",
            password: "wackycom600",
            contents: [
                { "name": "19-4.flac", "type": "file", "class": "audio" },
				{ "name": "Confusion.mp3", "type": "file", "class": "audio" },
				{ "name": "Grain (1).mp3", "type": "file", "class": "audio" },
				{ "name": "dawn comes ever closer.mp3", "type": "file", "class": "audio" },
				{ "name": "diamond in your soul.ogg", "type": "file", "class": "audio" },
				{ "name": "headlock.ogg", "type": "file", "class": "audio" },
				{ "name": "horn.wav", "type": "file", "class": "audio" },
				{ "name": "me when i'm an orange.flac", "type": "file", "class": "audio" },
				{ "name": "minecraft.ogg", "type": "file", "class": "audio" },
				{ "name": "smile sower.ogg", "type": "file", "class": "audio" },
				{ "name": "spitting images.ogg", "type": "file", "class": "audio" },
				{ "name": "the brown lane.ogg", "type": "file", "class": "audio" },
				{ "name": "wii all feel the same.ogg", "type": "file", "class": "audio" },
            ]
        };
        // ---------------------------------------------------

        const systemApps = [
            // Your original apps
            { name: 'Calculator', type: 'system_app', class: 'webapp-computer', action: 'openCalculator' },
            { name: 'Clock', type: 'system_app', class: 'webapp-globe', action: 'openClock' },
            { name: 'About', type: 'system_app', class: 'webapp-about', action: 'openAbout' },
            
            // I'm adding back the other system apps 
            { name: 'Notepad', type: 'system_app', class: 'webapp-notepad', action: 'openNotepad' },
            { name: 'Settings', type: 'system_app', class: 'webapp-settings', action: 'openSettings' },
            { name: 'Browser', type: 'system_app', class: 'webapp-browser', action: 'openBrowser' },
            { name: 'File Explorer', type: 'system_app', class: 'webapp-explorer', action: 'openExplorer' },
            { name: 'Terminal', type: 'system_app', class: 'webapp-terminal', action: 'openTerminal' },
            { name: 'Theme Studio', type: 'system_app', class: 'webapp-themes', action: 'openThemeApp' },
        ];

        // This is the corrected line, which will now work
        desktopItems = [...filteredDesktopItems, LOCKED_FOLDER, ...systemApps, ...customDesktopItems];

        renderUI();
        setupStartMenu(); // This was also missing
        setupMobileControls(); // This was also missing

        setupGlobalDragSelect();
        setupMobileGestures();
        
		// the: Add global click listener for UI sounds
        document.body.addEventListener('click', (e) => {
            // Play sound if clicking on a "clickable" element
            if (e.target.closest('button, .icon, .menu-item, .task-item, .sidebar-button, .dot')) {
                playUISound('click');
            }
        }, true); // Use capture to catch it early
    }

    // --- UI Rendering ---
    function renderUI() {
        renderDesktopIcons();
        renderMobileIcons();
    }

    function renderDesktopIcons() {
        const container = document.getElementById('desktop-icon-container');
        if (!container) return;
        container.innerHTML = '';

        desktopItems.forEach(item => {
            const iconDiv = createIconElement(item);
            iconDiv.addEventListener('dblclick', () => launchItem(item));
            iconDiv.addEventListener('mousedown', (e) => {
                // Select icon
                e.stopPropagation();
                document.querySelectorAll('.icon.selected').forEach(i => i.classList.remove('selected'));
                iconDiv.classList.add('selected');
            });
            dragElement(iconDiv);
            container.appendChild(iconDiv);
        });
    }

    function renderMobileIcons() {
        const pagesContainer = document.getElementById('mobile-icon-pages');
        const dotsContainer = document.getElementById('mobile-page-dots');
        if (!pagesContainer || !dotsContainer) return;

        pagesContainer.innerHTML = '';
        dotsContainer.innerHTML = '';

        // Recalculate icons per page based on new dynamic grid
        const page = document.createElement('div');
        page.className = 'mobile-page';
        page.style.visibility = 'hidden'; // Don't show, just for measurement
        pagesContainer.appendChild(page);
        
        const style = window.getComputedStyle(page);
        const gridRowHeight = parseFloat(style.getPropertyValue('grid-auto-rows'));
        const gridGap = parseFloat(style.getPropertyValue('gap'));
        const paddingTop = parseFloat(style.getPropertyValue('padding-top'));
        const paddingLeft = parseFloat(style.getPropertyValue('padding-left'));

        const pageHeight = pagesContainer.clientHeight - (paddingTop * 2);
        const pageWidth = pagesContainer.clientWidth - (paddingLeft * 2);
        
        // Get columns from computed style
        const gridCols = style.getPropertyValue('grid-template-columns').split(' ').length;
        
        const iconsPerCol = Math.floor(pageHeight / (gridRowHeight + gridGap));
        const iconsPerPage = Math.max(1, iconsPerCol * gridCols);
        
        pagesContainer.innerHTML = ''; // Clear measurement page
        
        const numPages = Math.ceil(desktopItems.length / iconsPerPage);

        for (let i = 0; i < numPages; i++) {
            const page = document.createElement('div');
            page.className = 'mobile-page';
            pagesContainer.appendChild(page);

            const dot = document.createElement('span');
            dot.className = 'dot';
            dotsContainer.appendChild(dot);
        }
        
        if (dotsContainer.firstChild) {
            dotsContainer.firstChild.classList.add('active');
        }

        pagesContainer.onscroll = () => {
            const pageIndex = Math.round(pagesContainer.scrollLeft / pagesContainer.clientWidth);
            document.querySelectorAll('.dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === pageIndex);
            });
        };

        desktopItems.forEach((item, index) => {
            const pageIndex = Math.floor(index / iconsPerPage);
            const currentPage = pagesContainer.children[pageIndex];
            if (currentPage) {
                const iconDiv = createIconElement(item);
                iconDiv.addEventListener('click', () => launchItem(item));
                currentPage.appendChild(iconDiv);
            }
        });
    }
    
    function createIconElement(item) {
        const iconDiv = document.createElement('div');
        iconDiv.className = 'icon';
        iconDiv.innerHTML = `<div class="icon-img ${item.class || 'folder'}"></div><div class="icon-name">${item.name}</div>`;
        iconDiv.setAttribute('data-item-name', item.name); // For finding it
        return iconDiv;
    }

    // --- Global Drag Select ---
    function setupGlobalDragSelect() {
        const container = document.getElementById('desktop-icon-container');
        if (!container) return;
        
        let selectionBox = document.createElement('div');
        selectionBox.style.position = 'absolute';
        selectionBox.style.border = '1px dotted #fff';
        selectionBox.style.background = 'rgba(255, 255, 255, 0.2)';
        selectionBox.style.zIndex = '999';
        selectionBox.style.display = 'none';
        document.getElementById('window-area').appendChild(selectionBox);
        
        let startX, startY;
        
        container.addEventListener('mousedown', (e) => {
            if (e.target !== container) return; // Only start on container itself
            
            document.querySelectorAll('.icon.selected').forEach(i => i.classList.remove('selected'));
            
            startX = e.clientX;
            startY = e.clientY;
            
            selectionBox.style.left = `${startX}px`;
            selectionBox.style.top = `${startY}px`;
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            selectionBox.style.display = 'block';
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
        
        function onMouseMove(e) {
            let x = Math.min(e.clientX, startX);
            let y = Math.min(e.clientY, startY);
            let w = Math.abs(e.clientX - startX);
            let h = Math.abs(e.clientY - startY);
            
            selectionBox.style.left = `${x}px`;
            selectionBox.style.top = `${y}px`;
            selectionBox.style.width = `${w}px`;
            selectionBox.style.height = `${h}px`;
            
            // Check for selection
            const icons = container.querySelectorAll('.icon');
            const boxRect = selectionBox.getBoundingClientRect();
            icons.forEach(icon => {
                const iconRect = icon.getBoundingClientRect();
                const isIntersecting = !(
                    iconRect.right < boxRect.left ||
                    iconRect.left > boxRect.right ||
                    iconRect.bottom < boxRect.top ||
                    iconRect.top > boxRect.bottom
                );
                icon.classList.toggle('selected', isIntersecting);
            });
        }
        
        function onMouseUp() {
            selectionBox.style.display = 'none';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
    }

    // --- Launch Logic ---
    function launchItem(item) {
        if (isMobile()) closeMobileSidebar();

        // the: Check for web app preference
        if (item.type === 'folder') {
            if (appSettings.alwaysOpenInWindow) {
                openIframeWindow(item.name, item.url);
            } else {
                openWebAppPrompt(item);
            }
            return;
        }
        
        if (item.type === 'locked_folder') {
            openPasswordModal(item.name, item.password, () => {
                openLockedFolderWindow(item.name, item.contents);
            });
            return;
        }

        if (item.type === 'system_app') {
            if (item.action === 'openCalculator') openCalculatorApp();
            if (item.action === 'openClock') openClockApp();
            if (item.action === 'openNotepad') openNotepadApp();
            if (item.action === 'openSettings') openSettingsApp();
            // the:
            if (item.action === 'openBrowser') openBrowserApp();
            if (item.action === 'openExplorer') openExplorerApp();
            if (item.action === 'openTerminal') openTerminalApp();
            if (item.action === 'openThemeApp') openThemeApp();
            if (item.action === 'openAbout') openAboutApp();
            return;
        }

        if (item.action === 'newTab') { openFileInNewTab(item.name); return; }

        switch (item.class) {
            case 'audio': openMediaPlayerWindow(item.name); break;
            case 'video': openVideoPlayerWindow(item.name); break;
            case 'image': openImageViewWindow(item.name); break;
            case 'document': case 'code': case 'unknown': openTextViewWindow(item.name); break;
            case 'zip': default: openErrorWindow(item.name, 'No program is associated with this file type.'); break;
        }
    }

    // --- Window Management ---
    function openWindow(title, contentHTML, options = {}) {
        const windowId = `win-${Date.now()}`;
        
        if (isMobile()) {
            return openMobileWindow(windowId, title, contentHTML, options);
        } else {
            return openDesktopWindow(windowId, title, contentHTML, options);
        }
    }

    function openDesktopWindow(windowId, title, contentHTML, options = {}) {
		playUISound('windowOpen');
        highestZIndex++;
        const windowDiv = document.createElement('div');
        windowDiv.className = 'window opening';
        windowDiv.style.zIndex = highestZIndex;
        windowDiv.id = windowId;

        if (options.width) windowDiv.style.width = options.width;
        if (options.height) windowDiv.style.height = options.height;
        if (options.minWidth) windowDiv.style.minWidth = options.minWidth;
        if (options.minHeight) windowDiv.style.minHeight = options.minHeight;

        windowDiv.innerHTML = `
            <div class="window-header">
                <span class="window-title">${title}</span>
                <div class="window-controls">
                    ${options.hideMinimize ? '' : '<button class="minimize-btn" title="Minimize">_</button>'}
                    ${options.hideMaximize ? '' : '<button class="maximize-btn" title="Maximize">&#9633;</button>'}
                    <button class="close-btn" title="Close">&#10006;</button>
                </div>
            </div>
            <div class="window-content">${contentHTML}</div>
        `;
        
        document.getElementById('window-area').appendChild(windowDiv);
        
        const winWidth = windowDiv.offsetWidth;
        const winHeight = windowDiv.offsetHeight;
        
        // Adjust for taskbar
        const taskbar = document.querySelector('.taskbar');
        const taskbarRect = taskbar.getBoundingClientRect();
        let viewWidth = window.innerWidth;
        let viewHeight = window.innerHeight;
        let viewTop = 0;
        let viewLeft = 0;
        
        if (appSettings.taskbarPosition === 'bottom') viewHeight -= taskbarRect.height;
        if (appSettings.taskbarPosition === 'top') { viewHeight -= taskbarRect.height; viewTop = taskbarRect.height; }
        if (appSettings.taskbarPosition === 'left') { viewWidth -= taskbarRect.width; viewLeft = taskbarRect.width; }

        windowDiv.style.left = `${viewLeft + Math.max(5, (viewWidth - winWidth) / 2)}px`;
        windowDiv.style.top = `${viewTop + Math.max(5, (viewHeight - winHeight) / 2)}px`;
        
        requestAnimationFrame(() => {
            windowDiv.classList.remove('opening');
        });
        
        const header = windowDiv.querySelector('.window-header');
        windowDiv.addEventListener('mousedown', () => bringWindowToFront(windowId));
        windowDiv.querySelector('.close-btn').addEventListener('click', () => closeWindow(windowId));
        
        if (!options.hideMinimize) { windowDiv.querySelector('.minimize-btn').addEventListener('click', () => minimizeWindow(windowId)); }
        if (!options.hideMaximize) { 
            const maximizeBtn = windowDiv.querySelector('.maximize-btn');
            maximizeBtn.addEventListener('click', () => maximizeWindow(windowId));
            header.addEventListener('dblclick', (e) => {
                if (e.target.closest('button')) return; // Don't maximize on control click
                maximizeWindow(windowId);
            });
        }

        dragElement(windowDiv);
        add_taskbar_item(windowId, title);
        openWindows[windowId] = windowDiv;
        
        bringWindowToFront(windowId);
        
        return windowDiv;
    }
    
    function openMobileWindow(windowId, title, contentHTML, options = {}) {
		playUISound('windowOpen');
        const appPage = document.createElement('div');
        // the: Opening class for animation
        appPage.className = 'mobile-app-page opening';
        appPage.id = windowId;
        
        // the: Back button logic
        const hasBack = openMobileAppOrder.length > 0;
        
        appPage.innerHTML = `
            <div class="mobile-app-header">
                <span class="mobile-app-back-btn">${hasBack ? '&#8249;' : '&times;'}</span>
                <span class="mobile-app-title">${title}</span>
                <span class="mobile-app-close-btn">&times;</span>
            </div>
            <div class="mobile-app-content">${contentHTML}</div>
        `;
        
        // the: Hide close button if back is shown, to look more like native
        if(hasBack) appPage.querySelector('.mobile-app-close-btn').style.display = 'none';
        
        document.getElementById('mobile-app-container').appendChild(appPage);
        appPage.querySelector('.mobile-app-back-btn').addEventListener('click', () => {
            // the: Back button goes back, close button always closes
            if (hasBack) {
                closeWindow(windowId, true); // true = go back
            } else {
                closeWindow(windowId); // Close completely
            }
        });
        appPage.querySelector('.mobile-app-close-btn').addEventListener('click', () => closeWindow(windowId));
        
        openWindows[windowId] = appPage;
        
        bringWindowToFront(windowId);
        
        // the: Force layout and animate in
        requestAnimationFrame(() => {
            appPage.classList.remove('opening');
        });

        return appPage;
    }

    function closeWindow(windowId, isMobileBack = false) {
        playUISound('windowClose');
		const win = openWindows[windowId];
        if (!win) return;
        
        if (isMobile()) {
            // Remove from stack
            const appIndex = openMobileAppOrder.indexOf(windowId);
            if (appIndex > -1) {
                openMobileAppOrder.splice(appIndex, 1);
            }
            
            //Animation
            win.classList.add('closing');
            win.addEventListener('transitionend', () => {
                win.remove();
                delete openWindows[windowId];
                updateMobileTaskList();
            }, { once: true });
            
            // Show the next app or home screen
            const nextAppId = openMobileAppOrder[openMobileAppOrder.length - 1];
            if (nextAppId) {
                bringWindowToFront(nextAppId, true); // True = skip animation
            } else {
                showMobileHome(false);
            }
            
        } else {
            // Desktop
            // the: Fancy minimize animation
            if (win.classList.contains('minimized') && appSettings.graphics === 'fancy') {
                win.classList.add('minimizing');
            } else {
                win.classList.add('closing');
            }
            
            win.addEventListener('transitionend', () => {
                win.remove();
                delete openWindows[windowId];
                remove_taskbar_item(windowId);
            }, { once: true });
        }
    }
    
    function minimizeWindow(windowId) {
        if (isMobile()) {
            // On mobile, "minimize" just means go home, but keep the app in the stack
            showMobileHome(true); // true = is minimizing
        } else {
            // Desktop
            const win = document.getElementById(windowId);
            if (win) {
                if (appSettings.graphics === 'fancy') {
                    win.classList.add('minimizing');
                    win.addEventListener('transitionend', () => {
                        win.classList.add('minimized');
                        win.classList.remove('minimizing');
                    }, { once: true });
                } else {
                    win.classList.add('minimized');
                }
                document.querySelector(`.task-item[data-window-id="${windowId}"]`).classList.remove('active');
            }
        }
    }
    
    function maximizeWindow(windowId) {
        if (isMobile()) return;
        const win = document.getElementById(windowId);
        win?.classList.toggle('maximized');
    }
    
    function bringWindowToFront(windowId, skipMobileAnimation = false) {
        const win = openWindows[windowId];
        if (!win) return;
        
        if (isMobile()) {
            document.getElementById('mobile-homescreen').style.display = 'none';
            document.getElementById('mobile-app-container').style.display = 'block';
            
            // Update app stack
            const appIndex = openMobileAppOrder.indexOf(windowId);
            if (appIndex > -1) {
                openMobileAppOrder.splice(appIndex, 1);
            }
            openMobileAppOrder.push(windowId);
            
            // the: Improved animation logic
            Object.values(openWindows).forEach(appPage => {
                if (appPage.id === windowId) {
                    appPage.classList.remove('inactive-behind');
                    appPage.classList.add('active');
                } else {
                    appPage.classList.remove('active');
                    // Check if this page is the one right behind the new active one
                    const justBehindId = openMobileAppOrder[openMobileAppOrder.length - 2];
                    if (appPage.id === justBehindId) {
                        appPage.classList.add('inactive-behind');
                    } else {
                        appPage.classList.remove('inactive-behind');
                    }
                }
            });
            
            if (skipMobileAnimation) {
                // If skipping, just snap it
                win.classList.remove('opening');
            }
            
            updateMobileTaskList();

        } else {
            // Desktop logic
            highestZIndex++;
            win.style.zIndex = highestZIndex;
            win.classList.remove('minimized', 'minimizing');
            
            document.querySelectorAll('.task-item').forEach(item => item.classList.remove('active'));
            const taskItem = document.querySelector(`.task-item[data-window-id="${windowId}"]`);
            if (taskItem) taskItem.classList.add('active');
        }
    }

    // --- App Launchers ---
    function openIframeWindow(title, url) {
        const content = `<iframe src="${url}" style="width:100%; height:100%; border:none;" title="${title}" sandbox="allow-scripts allow-same-origin"></iframe>`;
        const win = openWindow(title, content, { width: '80vw', height: '75vh' });
        
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
    }

    function openWebAppPrompt(item) {
        const promptContent = `
            <div class="app-launch-prompt">
                <p>How would you like to open <strong>${item.name}</strong>?</p>
                <div class="app-launch-prompt-buttons">
                    <button id="open-in-tab">New Tab</button>
                    <button id="open-in-window">In App</button>
                </div>
            </div>
        `;
        const modalWin = openWindow(`Launch App`, promptContent, {
            width: '350px',
            height: '160px',
            minWidth: '300px',
            minHeight: '150px',
            hideMaximize: true,
            hideMinimize: true
        });

        modalWin.querySelector('#open-in-tab').addEventListener('click', () => {
            window.open(item.url, '_blank');
            closeWindow(modalWin.id);
        });

        modalWin.querySelector('#open-in-window').addEventListener('click', () => {
            openIframeWindow(item.name, item.url);
            closeWindow(modalWin.id);
        });
    }

    function openPasswordModal(folderName, expectedPassword, onSuccessCallback) {
        const modalContent = `
            <div class="password-modal">
                <p>Enter password to unlock <strong>${folderName}</strong>:</p>
                <input type="password" id="password-input" placeholder="Password" autofocus>
                <div id="password-error" class="error-message"></div>
                <button id="submit-password">Unlock</button>
            </div>
        `;

        const modalWin = openWindow('Security', modalContent, {
            width: '300px',
            height: '180px',
            minWidth: '250px',
            minHeight: '150px',
            hideMaximize: true,
            hideMinimize: true
        });

        const input = modalWin.querySelector('#password-input');
        const submitBtn = modalWin.querySelector('#submit-password');
        const errorDiv = modalWin.querySelector('#password-error');

        const checkPassword = () => {
            if (input.value === expectedPassword) {
                closeWindow(modalWin.id);
                onSuccessCallback();
            } else {
			    playUISound('error'); // the: Add this line
                errorDiv.textContent = 'Incorrect password.';
                input.value = '';
                input.focus();
                // the: Shake animation
                modalWin.style.transition = 'transform 0.1s ease-in-out';
                modalWin.style.transform = 'translateX(10px)';
                setTimeout(() => modalWin.style.transform = 'translateX(-10px)', 100);
                setTimeout(() => modalWin.style.transform = 'translateX(0px)', 200);
            }
        };

        submitBtn.addEventListener('click', checkPassword);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
        
        setTimeout(() => input.focus(), 100);
    }

    function openLockedFolderWindow(folderName, contents) {
        const folderGridDiv = document.createElement('div');
        folderGridDiv.className = 'folder-grid';
        
        contents.forEach(item => {
            const iconDiv = createIconElement(item);
            const eventType = isMobile() ? 'click' : 'dblclick';
            iconDiv.addEventListener(eventType, (e) => {
                e.stopPropagation();
                launchItem(item);
            });
            folderGridDiv.appendChild(iconDiv);
        });
        
        const win = openWindow(`${folderName} - Explorer`, '', {width: '400px', height: '300px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        contentArea.style.padding = '5px';
        contentArea.appendChild(folderGridDiv);
    }
    
    function openVideoPlayerWindow(fileName) { 
        const videoUrl = `${BASE_URL}${encodeURIComponent(fileName)}`; 
        const content = `<video src="${videoUrl}" controls autoplay style="width:100%; height:100%; background:#000;"></video>`; 
        const win = openWindow(`Video Player - ${fileName}`, content); 
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0'; 
    }
    
    function openMediaPlayerWindow(fileName) {
        const mediaFileUrl = `${BASE_URL}${encodeURIComponent(fileName)}`;
        const playerLink = `${MEDIA_PLAYER_APP_URL}%22${mediaFileUrl}%22`;
        const content = `<iframe src="${playerLink}" style="width:100%; height:100%; border:none;" title="Media Player"></iframe>`;
        const win = openWindow(`Media Player - ${fileName}`, content, {width: '350px', height: '200px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
    }

    function openImageViewWindow(fileName) { 
        const imageUrl = `${BASE_URL}${encodeURIComponent(fileName)}`; 
        const isHdr = fileName.toLowerCase().endsWith('.hdr'); 
        const content = isHdr 
            ? `<div id="hdr-container-${Date.now()}" style="width:100%; height:100%; background:#000;"></div>` 
            : `<img src="${imageUrl}" style="width:100%; height:100%; object-fit:contain; display:block; margin:auto; background:var(--theme-bg-tertiary);" alt="${fileName}">`; 
        
        const win = openWindow(`Image Viewer - ${fileName}`, content, {width: '70vw', height: '70vh'}); 
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
        
        if (isHdr) { 
            setTimeout(() => {
                const containerId = win.querySelector('div[id^="hdr-container"]').id; 
                initHdrViewer(containerId, imageUrl); 
            }, 10);
        } 
    }
    
    function initHdrViewer(containerId, imageUrl) { 
        const container = document.getElementById(containerId);
        if (!container || container.clientWidth === 0 || container.clientHeight === 0) {
            setTimeout(() => initHdrViewer(containerId, imageUrl), 50);
            return;
        }
        const width = container.clientWidth;
        const height = container.clientHeight;
        const scene = new THREE.Scene(); 
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000); 
        camera.position.set(0, 0, 0.1);
        const renderer = new THREE.WebGLRenderer({ antialias: true }); 
        renderer.setSize(width, height); 
        renderer.toneMapping = THREE.ACESFilmicToneMapping; 
        renderer.toneMappingExposure = 1.5;
        container.innerHTML = '';
        container.appendChild(renderer.domElement); 
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.target.set(0, 0, 0);
        new THREE.RGBELoader().load(imageUrl, function (texture) { 
            texture.mapping = THREE.EquirectangularReflectionMapping; 
            scene.background = texture; 
            scene.environment = texture; 
            renderer.render(scene, camera); 
            animate(); 
        },
        undefined,
        (error) => {
            console.error('An error occurred while loading the HDR file:', error);
            container.innerHTML = '<div style="color:white; padding: 20px;">Error loading HDR file. Check console for details.</div>';
        });
        const resizeHandler = (entries) => {
            const entry = entries[0];
            const w = entry.contentRect.width;
            const h = entry.contentRect.height;
            if (w > 0 && h > 0) {
                renderer.setSize(w, h);
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
            }
        };
        new ResizeObserver(resizeHandler).observe(container);
        function animate() {
            if(!document.getElementById(containerId)) return; // Stop animation if window is closed
            requestAnimationFrame(animate);
            controls.update(); 
            renderer.render(scene, camera);
        }
    }

    async function openTextViewWindow(fileName) { 
        const content = `<textarea style="width: 100%; height: 100%; box-sizing: border-box; border: none; padding: 5px; font-family: 'Lucida Console', monospace; resize: none; background: var(--theme-bg-primary); color: var(--theme-text-primary);" readonly>Loading content for ${fileName}...</textarea>`; 
        const win = openWindow(`Viewer - ${fileName}`, content); 
        const textarea = win.querySelector('textarea'); 
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
        try { 
            const response = await fetch(`${BASE_URL}${encodeURIComponent(fileName)}`); 
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); 
            const text = await response.text(); 
            textarea.value = text; 
        } catch (error) { 
            textarea.value = `--- ERROR ---\n\nCould not fetch file content for "${fileName}".\n\nReason: ${error.message}`; 
        } 
    }
    
    function openFileInNewTab(fileName) { window.open(`${BASE_URL}${fileName}`, '_blank'); }
    
    function openErrorWindow(fileName, message) { 
		playUISound('error'); 
        const content = `<div style="padding:10px;"><h3 style="color: red;">Error</h3><p><strong>File:</strong> ${fileName}</p><p><strong>Reason:</strong> ${message}</p></div>`; 
        openWindow('System Error', content); 
    }

    // --- Taskbar & Start Menu ---
    function add_taskbar_item(windowId, title) { 
        if (isMobile()) return;
        const item = document.createElement('div'); 
        item.className = 'task-item'; 
        item.textContent = title; 
        item.setAttribute('data-window-id', windowId); 
        item.onclick = () => {
            const win = document.getElementById(windowId);
            if (win.classList.contains('minimized') || !win.classList.contains('active')) {
                bringWindowToFront(windowId);
            } else {
                minimizeWindow(windowId);
            }
        }; 
        document.getElementById('task-items').appendChild(item); 
    }
    
    function remove_taskbar_item(windowId) { 
        if (isMobile()) return;
        const item = document.querySelector(`.task-item[data-window-id="${windowId}"]`); 
        if (item) item.remove(); 
    }
    
    function setupStartMenu() { 
        const startBtn = document.getElementById('start-button'); 
        const startMenu = document.getElementById('start-menu'); 
        const programsContainer = document.getElementById('start-programs'); 
        const docsContainer = document.getElementById('start-docs'); 
        
        programsContainer.innerHTML = '';
        docsContainer.innerHTML = '';
        
        // Get all system apps from desktopItems
        const apps = desktopItems.filter(i => i.type === 'system_app');
        
        apps.forEach(app => { 
            const item = document.createElement('div'); 
            item.className = 'menu-item'; 
            item.innerHTML = `<div class="icon-img ${app.class}" style="width:24px; height:24px;"></div> <span>${app.name}</span>`; 
            item.onclick = () => { launchItem(app); startMenu.classList.remove('open'); }; 
            programsContainer.appendChild(item); 
        }); 
        
        desktopItems.filter(i => i.type === 'file' && ['document', 'image', 'code'].includes(i.class)).slice(0, 5).forEach(doc => { 
            const item = document.createElement('div'); 
            item.className = 'menu-item'; 
            item.innerHTML = `<div class="icon-img ${doc.class}" style="width:24px; height:24px;"></div> <span>${doc.name}</span>`; 
            item.onclick = () => { launchItem(doc); startMenu.classList.remove('open'); }; 
            docsContainer.appendChild(item); 
        }); 
        
        startBtn.addEventListener('click', (e) => { e.stopPropagation(); startMenu.classList.toggle('open'); }); 
        document.addEventListener('click', () => startMenu.classList.remove('open')); 
        startMenu.addEventListener('click', e => e.stopPropagation()); 
    }

    // --- Mobile Controls ---
    function setupMobileControls() {
        const clockEl = document.getElementById('mobile-clock');
        function updateClock() {
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        updateClock();
        setInterval(updateClock, 1000);
        
        const menuBtn = document.getElementById('mobile-menu-btn');
        const homeBtn = document.getElementById('mobile-home-btn');
        const sidebar = document.getElementById('mobile-sidebar');
        const overlay = document.getElementById('mobile-sidebar-overlay');
        
        menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.add('open');
            overlay.classList.add('open');
        });
        
        homeBtn.addEventListener('click', () => {
            showMobileHome(false); // false = not minimizing, just going home
            closeMobileSidebar();
        });
        
        overlay.addEventListener('click', closeMobileSidebar);
    }
    
    // the: Mobile edge swipe gestures
    function setupMobileGestures() {
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.body.addEventListener('touchstart', e => {
            if (!isMobile()) return;
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        document.body.addEventListener('touchend', e => {
            if (!isMobile()) return;
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });
        
        function handleSwipe() {
            // Swipe from left edge to open sidebar
            if (touchStartX < 30 && touchEndX > (touchStartX + 70)) {
                document.getElementById('mobile-sidebar').classList.add('open');
                document.getElementById('mobile-sidebar-overlay').classList.add('open');
            }
        }
    }
    
    function closeMobileSidebar() {
        document.getElementById('mobile-sidebar').classList.remove('open');
        document.getElementById('mobile-sidebar-overlay').classList.remove('open');
    }
    
    function showMobileHome(isMinimizing) {
        document.getElementById('mobile-homescreen').style.display = 'block';
        document.getElementById('mobile-app-container').style.display = 'none';
        
        // If not minimizing, we are clearing the stack
        if (!isMinimizing) {
            openMobileAppOrder = [];
        }
        updateMobileTaskList();
    }
    
    function updateMobileTaskList() {
        const taskList = document.getElementById('mobile-task-list');
        if (!taskList) return;
        taskList.innerHTML = '';
        
        const activeAppId = openMobileAppOrder[openMobileAppOrder.length - 1];

        // the: Show apps in the order they are in the stack (most recent at top)
        [...openMobileAppOrder].reverse().forEach(windowId => {
            const win = openWindows[windowId];
            if (!win) return;
            const title = win.querySelector('.mobile-app-title, .window-title')?.textContent || 'Untitled';
            
            const item = document.createElement('li');
            item.className = 'mobile-task-item';
            if (windowId === activeAppId) {
                item.classList.add('active');
            }
            item.innerHTML = `
                <span class="mobile-task-item-name">${title}</span>
                <span class="mobile-task-item-close">&times;</span>
            `;
            
            item.querySelector('.mobile-task-item-name').addEventListener('click', () => {
                bringWindowToFront(windowId);
                closeMobileSidebar();
            });
            
            item.querySelector('.mobile-task-item-close').addEventListener('click', () => {
                closeWindow(windowId);
            });
            
            taskList.appendChild(item);
        });
    }

    // --- Built-in Apps ---
    
    // the: Calculator - REBUILT
    function openCalculatorApp() {
        const calcHTML = `
            <div id="calculator">
                <input type="text" id="calc-display" value="0" readonly>
                <div id="calc-buttons">
                    <button class="calc-btn func" data-key="clear">AC</button>
                    <button class="calc-btn func" data-key="sign">+/-</button>
                    <button class="calc-btn func" data-key="percent">%</button>
                    <button class="calc-btn op" data-key="divide">&divide;</button>
                    
                    <button class="calc-btn" data-key="7">7</button>
                    <button class="calc-btn" data-key="8">8</button>
                    <button class="calc-btn" data-key="9">9</button>
                    <button class="calc-btn op" data-key="multiply">&times;</button>
                    
                    <button class="calc-btn" data-key="4">4</button>
                    <button class="calc-btn" data-key="5">5</button>
                    <button class="calc-btn" data-key="6">6</button>
                    <button class="calc-btn op" data-key="subtract">&minus;</button>
                    
                    <button class="calc-btn" data-key="1">1</button>
                    <button class="calc-btn" data-key="2">2</button>
                    <button class="calc-btn" data-key="3">3</button>
                    <button class="calc-btn op" data-key="add">+</button>
                    
                    <button class="calc-btn zero" data-key="0">0</button>
                    <button class="calc-btn" data-key="decimal">.</button>
                    <button class="calc-btn op" data-key="equals">=</button>
                </div>
            </div>
        `;
        const win = openWindow('Calculator', calcHTML, {width: '300px', height: '450px', minWidth: '250px', minHeight: '350px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
        
        const calculator = win.querySelector('#calculator');
        if (!calculator) return;
        
        const display = calculator.querySelector('#calc-display');
        const buttons = calculator.querySelector('#calc-buttons');
        
        let state = {
            displayValue: '0',
            firstOperand: null,
            operator: null,
            waitingForSecondOperand: false,
        };

        function performCalculation(a, b, op) {
            if (op === 'add') return a + b;
            if (op === 'subtract') return a - b;
            if (op === 'multiply') return a * b;
            if (op === 'divide') {
                if (b === 0) return 'Error';
                return a / b;
            }
            return b;
        }

        buttons.addEventListener('click', (e) => {
            const key = e.target.dataset.key;
            if (!key || e.target.tagName !== 'BUTTON') return;

            if (/\d/.test(key)) {
                if (state.displayValue === 'Error') state.displayValue = '0';
                if (state.waitingForSecondOperand) {
                    state.displayValue = key;
                    state.waitingForSecondOperand = false;
                } else {
                    state.displayValue = state.displayValue === '0' ? key : state.displayValue + key;
                }
            } else if (key === 'decimal') {
                if (state.displayValue === 'Error') state.displayValue = '0';
                if (state.waitingForSecondOperand) {
                    state.displayValue = '0.';
                    state.waitingForSecondOperand = false;
                } else if (!state.displayValue.includes('.')) {
                    state.displayValue += '.';
                }
            } else if (key === 'clear') {
                state = { displayValue: '0', firstOperand: null, operator: null, waitingForSecondOperand: false };
            } else if (key === 'sign') {
                if (state.displayValue === 'Error' || state.displayValue === '0') return;
                state.displayValue = (parseFloat(state.displayValue) * -1).toString();
            } else if (key === 'percent') {
                if (state.displayValue === 'Error') return;
                state.displayValue = (parseFloat(state.displayValue) / 100).toString();
            } else if (key === 'equals') {
                if (state.operator && state.firstOperand !== null) {
                    const result = performCalculation(state.firstOperand, parseFloat(state.displayValue), state.operator);
                    state.displayValue = String(result);
                    state.firstOperand = null; // Clear after equals
                    state.operator = null;
                    state.waitingForSecondOperand = true;
                }
            } else if (['add', 'subtract', 'multiply', 'divide'].includes(key)) {
                if (state.displayValue === 'Error') return;
                const inputValue = parseFloat(state.displayValue);
                
                if (state.operator && !state.waitingForSecondOperand) {
                    // Chained operation (e.g., 5 + 5 +)
                    const result = performCalculation(state.firstOperand, inputValue, state.operator);
                    state.displayValue = String(result);
                    state.firstOperand = result;
                } else {
                    // First operation
                    state.firstOperand = inputValue;
                }
                
                state.operator = key;
                state.waitingForSecondOperand = true;
            }
            
            display.value = state.displayValue.length > 14 ? parseFloat(state.displayValue).toExponential(9) : state.displayValue;
        });
    }
    
    function openClockApp() {
        const clockHTML = `
            <div id="clock-app">
                <div id="clock-time"></div>
                <div id="clock-date"></div>
            </div>
        `;
        const win = openWindow('Clock', clockHTML, {width: '400px', height: '250px', minWidth: '300px', minHeight: '200px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
        
        const timeEl = win.querySelector('#clock-time');
        const dateEl = win.querySelector('#clock-date');
        let clockInterval;
        
        function updateAppClock() {
            if (!document.body.contains(win)) {
                clearInterval(clockInterval);
                return;
            }
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        updateAppClock();
        clockInterval = setInterval(updateAppClock, 1000);
    }
    
    function openNotepadApp() {
        const notepadHTML = `
            <div id="notepad-app">
                <textarea id="notepad-textarea" placeholder="Start typing..."></textarea>
            </div>
        `;
        const win = openWindow('Notepad', notepadHTML, {width: '500px', height: '400px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
    }
    
    // the: Greatly expanded Settings app
    // the: Greatly expanded Settings app
    function openSettingsApp() {
        const settingsHTML = `
            <div id="settings-app">
                <div class="setting-group">
                    <label>Appearance</label>
                    <small>Go to the <strong>Theme Studio</strong> app to change themes and wallpapers!</small>
                    <button id="open-sound-settings-btn" style="margin-top: 10px;">Configure UI Sounds</button>
                </div>

                <div class="setting-group">
                    <label for="graphics-select">Graphics</label>
                    <select id="graphics-select">
                        <option value="simple">Simple (Fast)</option>
                        <option value="fancy">Fancy (Aero)</option>
                    </select>
                    <small>Fancy mode enables glass effects and animations. May impact performance.</small>
                </div>
                
                <div class="setting-group">
                    <label for="taskbar-select">Taskbar Position</label>
                    <select id="taskbar-select">
                        <option value="bottom">Bottom</option>
                        <option value="top">Top</option>
                        <option value="left">Left</option>
                    </select>
                    <div class="setting-group-row" style="margin-top: 8px;">
                        <input type="checkbox" id="taskbar-autohide-check">
                        <label for="taskbar-autohide-check">Auto-hide taskbar</label>
                    </div>
                    <small>Only affects desktop mode.</small>
                </div>

                <div class="setting-group">
                    <label for="icon-size-select">Icon Size</label>
                    <select id="icon-size-select">
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label>Web App Integration</label>
                    <div class="setting-group-row">
                        <input type="checkbox" id="always-open-in-window-check">
                        <label for="always-open-in-window-check">Always open web apps in-window</label>
                    </div>
                    <small>Skips the "New Tab / In App" prompt.</small>
                </div>
                
                <div class="setting-group">
                    <label>Add Custom Web App</label>
                    <div id="add-custom-app-form">
                        <input type="text" id="custom-app-name" placeholder="App Name (e.g., Google)">
                        <input type="text" id="custom-app-url" placeholder="App URL (e.g., https://google.com)">
                        <button id="add-custom-app-btn">Add to Desktop</button>
                    </div>
                </div>

                <div class="setting-group">
                    <label>Manage Custom Apps</label>
                    <div id="custom-apps-list">
                        </div>
                </div>
            </div>
        `;
        const win = openWindow('Settings', settingsHTML, {width: '450px', height: '650px', minWidth: '400px'});
        
        // Load current settings into controls
        const graphicsSelect = win.querySelector('#graphics-select');
        const taskbarSelect = win.querySelector('#taskbar-select');
        const taskbarAutohideCheck = win.querySelector('#taskbar-autohide-check'); // the
        const iconSizeSelect = win.querySelector('#icon-size-select');
        const alwaysOpenCheck = win.querySelector('#always-open-in-window-check');
        
        graphicsSelect.value = appSettings.graphics;
        taskbarSelect.value = appSettings.taskbarPosition;
        taskbarAutohideCheck.checked = appSettings.taskbarAutohide; // the
        iconSizeSelect.value = appSettings.iconSize;
        alwaysOpenCheck.checked = appSettings.alwaysOpenInWindow;
        
        // Add event listeners
        graphicsSelect.addEventListener('change', (e) => {
            appSettings.graphics = e.target.value;
            applySettings();
            saveSettings();
        });
        
        taskbarSelect.addEventListener('change', (e) => {
            appSettings.taskbarPosition = e.target.value;
            applySettings();
            saveSettings();
        });
        
        // the: Autohide listener
        taskbarAutohideCheck.addEventListener('change', (e) => {
            appSettings.taskbarAutohide = e.target.checked;
            applySettings();
            saveSettings();
        });
        
        iconSizeSelect.addEventListener('change', (e) => {
            appSettings.iconSize = e.target.value;
            applySettings();
            saveSettings();
        });
        
        alwaysOpenCheck.addEventListener('change', (e) => {
            appSettings.alwaysOpenInWindow = e.target.checked;
            saveSettings();
        });
        
        // the: Sound settings button
        win.querySelector('#open-sound-settings-btn').addEventListener('click', openSoundSettings);

        // --- NEW: Custom App Management ---
        const customAppListDiv = win.querySelector('#custom-apps-list');

        function renderCustomAppList() {
            customAppListDiv.innerHTML = '';
            if (customDesktopItems.length === 0) {
                customAppListDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: var(--theme-text-secondary);">No custom apps added.</div>';
                return;
            }
            
            customDesktopItems.forEach((app, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'custom-app-item';
                itemDiv.innerHTML = `
                    <span class="custom-app-item-name">${app.name}</span>
                    <span class="custom-app-item-url">${app.url}</span>
                    <button class="custom-app-item-remove" data-index="${index}" title="Remove App">&times;</button>
                `;
                
                itemDiv.querySelector('.custom-app-item-remove').addEventListener('click', (e) => {
                    const appIndex = parseInt(e.target.dataset.index);
                    customDesktopItems.splice(appIndex, 1); // Remove from array
                    saveCustomApps(); // Save to localStorage
                    renderCustomAppList(); // Re-render this list
                    
                    // Re-build master desktop list and re-render icons
                    // This is a bit heavy, but ensures consistency
                    const systemApps = desktopItems.filter(i => i.type === 'system_app');
                    const builtInItems = desktopItems.filter(i => i.type !== 'system_app' && i.type !== 'webapp');
                    desktopItems = [...builtInItems, ...systemApps, ...customDesktopItems];
                    
                    renderUI();
                    setupStartMenu();
                });
                
                customAppListDiv.appendChild(itemDiv);
            });
        }
        
        // Initial render
        renderCustomAppList();
        
        // Custom App Button
        win.querySelector('#add-custom-app-btn').addEventListener('click', () => {
            const nameInput = win.querySelector('#custom-app-name');
            const urlInput = win.querySelector('#custom-app-url');
            const name = nameInput.value;
            let url = urlInput.value;
            
            if (!name || !url) {
                alert('Please enter both a name and a URL.');
                return;
            }
            
            if (!url.startsWith('http')) {
                url = `https://${url}`;
            }
            
            const newApp = {
                name: name,
                type: 'webapp',
                class: 'webapp-browser', // Use generic browser icon
                url: url
            };
            
            // the: Save to persistent list
            customDesktopItems.push(newApp);
            saveCustomApps();
            
            // Add to live desktopItems list
            desktopItems.push(newApp);
            
            renderUI(); // Re-render icons
            setupStartMenu(); // Re-build start menu
            renderCustomAppList(); // Re-render settings list
            
            nameInput.value = '';
            urlInput.value = '';
        });
    }

    // --- NEW: 5 New Apps ---

    function openBrowserApp() {
        const browserHTML = `
            <div id="browser-app">
                <div id="browser-nav">
                    <button id="browser-back" disabled>&#8249;</button>
                    <button id="browser-forward" disabled>&#8250;</button>
                    <button id="browser-reload">&#8635;</button>
                    <input type="text" id="browser-url" placeholder="Enter URL">
                    <button id="browser-go">Go</button>
                </div>
                <iframe id="browser-frame" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
            </div>
        `;
        const win = openWindow('Browser', browserHTML, {width: '800px', height: '600px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';

        const iframe = win.querySelector('#browser-frame');
        const urlInput = win.querySelector('#browser-url');
        const goBtn = win.querySelector('#browser-go');
        const reloadBtn = win.querySelector('#browser-reload');
        
        const loadUrl = () => {
            let url = urlInput.value.trim();
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = `https://${url}`;
            }
            iframe.src = url;
            urlInput.value = url;
        };
        
        goBtn.addEventListener('click', loadUrl);
        urlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') loadUrl();
        });
        reloadBtn.addEventListener('click', () => {
            if (iframe.src !== 'about:blank') iframe.src = iframe.src;
        });
        
        // Note: Back/Forward are complex due to iframe security.
    }

    function openExplorerApp() {
        const explorerHTML = `<div id="explorer-app"></div>`;
        const win = openWindow('File Explorer', explorerHTML, {width: '500px', height: '400px'});
        const contentArea = win.querySelector('#explorer-app');
        
        desktopItems.forEach(item => {
            const iconDiv = createIconElement(item);
            iconDiv.addEventListener('dblclick', () => {
                launchItem(item);
                if (item.type !== 'system_app' && item.type !== 'webapp') {
                    closeWindow(win.id); // Close explorer if launching a file
                }
            });
            contentArea.appendChild(iconDiv);
        });
    }

    function openAboutApp() {
        const aboutHTML = `
            <div id="about-app">
                <div class="icon-img webapp-space" style="filter: hue-rotate(180deg);"></div>
                <h2>wbOS! v2</h2>
                <p>welcome to this particular nonsense!</p>
                <p>features in this update:
                <ul style="text-align: left; max-width: 300px; margin: auto;">
                    <li>new graphics mode!</li>
                    <li>custom themes, and more included!</li>
                    <li>new apps and utilities!</li>
                    <li>movable taskbar!</li>
                    <li>all kinds of useful improvements!</li>
                </ul>
                </p>
                <p>wackybox incorporated. technology of tomorrow, on the technology of today <3</p>
            </div>
        `;
        openWindow('About wbOS', aboutHTML, {width: '400px', height: '450px', hideMaximize: true, hideMinimize: true});
    }

    function openTerminalApp() {
        const terminalHTML = `
            <div id="terminal-app">
                <div id="terminal-output">Welcome to wbOS Terminal v1.0. Type 'help' for commands.</div>
                <div id="terminal-input-line">
                    <span id="terminal-prompt">user@wackybox:~$ </span>
                    <input type="text" id="terminal-input" autofocus>
                </div>
            </div>
        `;
        const win = openWindow('Terminal', terminalHTML, {width: '500px', height: '350px'});
        const contentArea = win.querySelector('.window-content, .mobile-app-content');
        if (contentArea) contentArea.style.padding = '0';
        
        const output = win.querySelector('#terminal-output');
        const input = win.querySelector('#terminal-input');
        
        win.addEventListener('click', () => input.focus());
        
        input.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            
            const command = input.value.trim();
            output.textContent += `\nuser@wackybox:~$ ${command}\n`;
            
            handleTerminalCommand(command, output);
            
            input.value = '';
            // Scroll to bottom
            output.parentElement.scrollTop = output.parentElement.scrollHeight;
        });
    }
    
    function handleTerminalCommand(cmd, output) {
        const args = cmd.split(' ');
        const command = args[0].toLowerCase();
        
        switch(command) {
            case 'help':
                output.textContent += "Available commands:\n  help    - Shows this message\n  ls      - Lists items on the desktop\n  date    - Shows the current date and time\n  clear   - Clears the terminal screen\n  echo    - Prints text to the terminal\n  poo    - Stinks\n  theme   - Change theme. Usage: theme [light|dark]";
                break;
            case 'ls':
                output.textContent += "Desktop Items:\n" + desktopItems.map(item => `  - ${item.name} (${item.type})`).join('\n');
                break;
			case 'poo':
                output.textContent += "\n";
                break;
            case 'date':
                output.textContent += new Date().toString();
                break;
            case 'clear':
                output.textContent = "Welcome to wbOS Terminal v1.0. Type 'help' for commands.";
                break;
            case 'echo':
                output.textContent += args.slice(1).join(' ');
                break;
            case 'theme':
                const newTheme = args[1];
                if (newTheme === 'light' || newTheme === 'dark') {
                    appSettings.theme = newTheme;
                    applySettings();
                    saveSettings();
                    output.textContent += `Theme set to ${newTheme}.`;
                } else {
                    output.textContent += "Usage: theme [light|dark]";
                }
                break;
            case '':
                break;
            default:
                output.textContent += `Command not found: ${command}`;
        }
    }

    function openThemeApp() {
        const wallpapers = [
            { id: 'default', name: 'Wacky Green' },
            { id: 'ocean', name: 'Ocean Blue' },
            { id: 'solid', name: 'Solid Gray' },
            { id: 'sunset', name: 'Sunset' },
            { id: 'forest', name: 'Forest' },
            { id: 'nebula', name: 'Nebula' },
        ];
        
        const themeHTML = `
            <div id="theme-app">
                <div class="setting-group">
                    <label>Color Mode</label>
                    <div id="theme-mode-toggle">
                        <button class="theme-mode-btn light ${appSettings.theme === 'light' ? 'active' : ''}" data-theme="light">Light</button>
                        <button class="theme-mode-btn dark ${appSettings.theme === 'dark' ? 'active' : ''}" data-theme="dark">Dark</button>
                    </div>
                </div>
                <div class="setting-group">
                    <label>Wallpaper</label>
                    <div id="wallpaper-grid">
                        ${wallpapers.map(wp => `
                            <div class="wallpaper-preview ${appSettings.wallpaper === wp.id ? 'active' : ''}" data-wallpaper-id="${wp.id}">
                                <span class="name">${wp.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="setting-group">
                    <label>Custom Wallpaper</label>
                    <small>Upload an image from your device.</small>
                    <div class="setting-group-row" style="gap: 5px; margin-top: 5px;">
                        <input type="file" id="wallpaper-upload" accept="image/*">
                        <button id="wallpaper-upload-btn">&#10514; Upload</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div id="custom-gradient-creator">
                        <label>Or create a custom gradient:</label>
                        <div class="setting-group-row">
                            <input type="color" id="gradient-color1" value="#f3904f">
                            <input type="color" id="gradient-color2" value="#3b4371">
                            <select id="gradient-direction">
                                <option value="to top">To Top</option>
                                <option value="to bottom">To Bottom</option>
                                <option value="to left">To Left</option>
                                <option value="to right">To Right</option>
                                <option value="to top right">To Top-Right</option>
                                <option value="to bottom left">To Bottom-Left</option>
                                <option value="45deg">Diagonal (45)</option>
                                <option value="radial-gradient">Radial</option>
                            </select>
                        </div>
                        <button id="gradient-apply-btn">Apply Gradient</button>
                    </div>
                </div>
            </div>
        `;
        const win = openWindow('Theme Studio', themeHTML, {width: '400px', height: '600px'});
        
        // Apply preview styles
        const wpStyles = {
            'default': 'radial-gradient(circle at 10% 90%, #6ec25d 0%, #3a8542 50%, #2e7141 100%)',
            'ocean': 'radial-gradient(circle at 80% 80%, #a2d2ff 0%, #3a86ff 50%, #003566 100%)',
            'solid': '#4a5759',
            'sunset': 'linear-gradient(to top, #f3904f, #3b4371)',
            'forest': 'linear-gradient(to bottom, #134e5e, #71b280)',
            'nebula': 'radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%)'
        };
        win.querySelectorAll('.wallpaper-preview').forEach(div => {
            div.style.background = wpStyles[div.dataset.wallpaperId];
        });
        
        // Light/Dark mode buttons
        win.querySelectorAll('.theme-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                appSettings.theme = btn.dataset.theme;
                applySettings();
                saveSettings();
                
                win.querySelectorAll('.theme-mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        // Wallpaper previews
        win.querySelectorAll('.wallpaper-preview').forEach(div => {
            div.addEventListener('click', () => {
                appSettings.wallpaper = div.dataset.wallpaperId;
                appSettings.wallpaperCustom = null; // Clear custom wallpaper
                applySettings();
                saveSettings();
                
                win.querySelectorAll('.wallpaper-preview').forEach(d => d.classList.remove('active'));
                div.classList.add('active');
            });
        });
        
        // the: Custom wallpaper upload
        win.querySelector('#wallpaper-upload-btn').addEventListener('click', () => {
            const fileInput = win.querySelector('#wallpaper-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first.');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File is too large (Max 5MB). Please choose a smaller image.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                appSettings.wallpaperCustom = e.target.result; // base64 string
                appSettings.wallpaper = 'custom'; // Set mode to custom
                applySettings();
                saveSettings();
                // Update active state in theme app
                win.querySelectorAll('.wallpaper-preview.active').forEach(d => d.classList.remove('active'));
            };
            reader.readAsDataURL(file);
        });
        
        // the: Custom gradient apply
        win.querySelector('#gradient-apply-btn').addEventListener('click', () => {
            const c1 = win.querySelector('#gradient-color1').value;
            const c2 = win.querySelector('#gradient-color2').value;
            const dir = win.querySelector('#gradient-direction').value;
            
            let gradient;
            if (dir === 'radial-gradient') {
                gradient = `radial-gradient(circle, ${c1}, ${c2})`;
            } else {
                gradient = `linear-gradient(${dir}, ${c1}, ${c2})`;
            }
            
            appSettings.wallpaperCustom = gradient; // Re-use this setting
            appSettings.wallpaper = 'custom'; // Set mode to custom
            applySettings();
            saveSettings();
            // Update active state in theme app
            win.querySelectorAll('.wallpaper-preview.active').forEach(d => d.classList.remove('active'));
        });
    }
// --- NEW: UI Sound Functions ---
    
    /**
     * Plays a UI sound if it's enabled and configured.
     * @param {string} soundName - The key from appSettings.uiSounds (e.g., 'click', 'windowOpen')
     */
    function playUISound(soundName) {
        if (!appSettings.uiSounds.enabled) return;
        
        const url = appSettings.uiSounds[soundName];
        if (!url) return; // No URL configured for this sound
        
        try {
            let audio = audioCache[soundName];
            if (audio) {
                audio.currentTime = 0;
                audio.volume = appSettings.uiSounds.volume;
                audio.play().catch(e => {
                    // This error often happens if user hasn't interacted with the page
                    console.warn(`Audio play failed for '${soundName}'. User interaction might be required.`, e.message);
                });
            } else {
                console.warn(`Sound '${soundName}' was not preloaded or failed to load.`);
            }
        } catch (e) {
            console.error(`Error playing sound '${soundName}':`, e);
        }
    }

    /**
     * Preloads all configured UI sounds into the audioCache.
     */
    function preloadUISounds() {
        if (!appSettings.uiSounds.enabled) return;
        
        const soundsToLoad = ['click', 'windowOpen', 'windowClose', 'error'];
        audioCache = {}; // Clear cache
        
        console.log("Preloading UI sounds...");
        soundsToLoad.forEach(soundName => {
            const url = appSettings.uiSounds[soundName];
            if (url) {
                try {
                    const audio = new Audio(url);
                    audio.preload = 'auto';
                    audio.load(); // Start loading
                    
                    audio.addEventListener('canplaythrough', () => {
                        console.log(`Sound '${soundName}' preloaded.`);
                    });
                    audio.addEventListener('error', (e) => {
                         console.error(`Failed to load sound '${soundName}' from ${url}`, e);
                    });
                    
                    audioCache[soundName] = audio;
                } catch (e) {
                    console.error(`Failed to create audio for ${soundName} from ${url}`, e);
                }
            }
        });
    }

    /**
     * Opens the UI Sound Settings window.
     */
    function openSoundSettings() {
        const soundSettingsHTML = `
            <div id="settings-app" style="padding: 15px;"> <div class="setting-group">
                    <div class="setting-group-row">
                        <input type="checkbox" id="sounds-enabled-check">
                        <label for="sounds-enabled-check"><strong>Enable UI Sounds</strong></label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label for="sounds-volume-slider">Volume</label>
                    <input type="range" id="sounds-volume-slider" min="0" max="1" step="0.1" style="width: 100%;">
                </div>
                
                <div class="setting-group">
                    <label>Sound URLs</label>
                    <small>Provide direct links to .mp3, .wav, or .ogg files.</small>
                    
                    <label for="sound-url-click" style="font-size: 13px; margin-top: 10px;">General Click</label>
                    <input type="text" id="sound-url-click" class="sound-url-input" placeholder="https://example.com/click.mp3">
                    
                    <label for="sound-url-windowOpen" style="font-size: 13px; margin-top: 10px;">Window Open</label>
                    <input type="text" id="sound-url-windowOpen" class="sound-url-input" placeholder="https://example.com/open.wav">
                    
                    <label for="sound-url-windowClose" style="font-size: 13px; margin-top: 10px;">Window Close</label>
                    <input type="text" id="sound-url-windowClose" class="sound-url-input" placeholder="https://example.com/close.ogg">
                    
                    <label for="sound-url-error" style="font-size: 13px; margin-top: 10px;">Error</label>
                    <input type="text" id="sound-url-error" class="sound-url-input" placeholder="https://example.com/error.mp3">
                </div>
                
                <button id="save-sounds-btn" style="padding: 10px; background: var(--theme-accent-primary); color: var(--theme-accent-text); width: 100%; border: none; border-radius: 4px; cursor: pointer;">Save and Preload Sounds</button>
            </div>
        `;
        const win = openWindow('UI Sound Settings', soundSettingsHTML, {width: '400px', height: '520px', minWidth: '350px'});
        
        // Load current settings
        const enabledCheck = win.querySelector('#sounds-enabled-check');
        const volumeSlider = win.querySelector('#sounds-volume-slider');
        const clickInput = win.querySelector('#sound-url-click');
        const openInput = win.querySelector('#sound-url-windowOpen');
        const closeInput = win.querySelector('#sound-url-windowClose');
        const errorInput = win.querySelector('#sound-url-error');
        
        enabledCheck.checked = appSettings.uiSounds.enabled;
        volumeSlider.value = appSettings.uiSounds.volume;
        clickInput.value = appSettings.uiSounds.click;
        openInput.value = appSettings.uiSounds.windowOpen;
        closeInput.value = appSettings.uiSounds.windowClose;
        errorInput.value = appSettings.uiSounds.error;
        
        // Save button
        win.querySelector('#save-sounds-btn').addEventListener('click', () => {
            appSettings.uiSounds.enabled = enabledCheck.checked;
            appSettings.uiSounds.volume = parseFloat(volumeSlider.value);
            appSettings.uiSounds.click = clickInput.value.trim();
            appSettings.uiSounds.windowOpen = openInput.value.trim();
            appSettings.uiSounds.windowClose = closeInput.value.trim();
            appSettings.uiSounds.error = errorInput.value.trim();
            
            preloadUISounds(); // Preload new sounds
            saveSettings();
            closeWindow(win.id);
        });
    }
    // --- Drag and Drop ---
    // --- Drag and Drop ---
    function dragElement(elmnt) { 
        if (isMobile()) return; // No dragging on mobile

        // the: pos1/pos2 are the offset from the cursor to the element's top-left corner
        let pos1 = 0, pos2 = 0; 
        let header = elmnt.classList.contains('window') ? elmnt.querySelector('.window-header') : elmnt; 
        
        if (header) { header.onmousedown = dragMouseDown; } 
        
        function dragMouseDown(e) { 
            if (e.button !== 0 || (e.target.tagName === 'BUTTON')) return; 
            e.preventDefault(); 
            if (elmnt.classList.contains('window')) bringWindowToFront(elmnt.id); 
            
            // the: Record the cursor's offset from the element's top-left corner
            pos1 = e.clientX - elmnt.offsetLeft;
            pos2 = e.clientY - elmnt.offsetTop;
            
            document.onmouseup = closeDragElement; 
            document.onmousemove = elementDrag; 
            elmnt.classList.add('dragging'); 

            elmnt.querySelectorAll('iframe, canvas').forEach(el => el.style.pointerEvents = 'none');
        } 
        
        function elementDrag(e) { 
            e.preventDefault(); 
            if (elmnt.classList.contains('maximized')) return; 
            
            // the: Set the element's new position based on cursor, adjusted by the initial offset
            let newTop = e.clientY - pos2;
            let newLeft = e.clientX - pos1;
            
            // Constrain dragging to viewport
            const taskbar = document.querySelector('.taskbar');
            const taskbarRect = taskbar.getBoundingClientRect();
            
            let minTop = 0;
            let minLeft = 0;
            // Use window.innerHeight/Width to get viewport size
            let maxTop = window.innerHeight - elmnt.offsetHeight;
            let maxLeft = window.innerWidth - elmnt.offsetWidth;
            
            // Adjust for taskbar *unless* it's autohidden
            if (!appSettings.taskbarAutohide) {
                if (appSettings.taskbarPosition === 'top') minTop = taskbarRect.height;
                if (appSettings.taskbarPosition === 'bottom') maxTop = taskbarRect.top - elmnt.offsetHeight;
                if (appSettings.taskbarPosition === 'left') minLeft = taskbarRect.width;
            }
            
            // Constrain header to be visible
            if (elmnt.classList.contains('window')) {
                // Allow dragging off top, but keep header visible
                let headerHeight = header ? header.offsetHeight : 40;
                maxTop = window.innerHeight - headerHeight; 
            }
            
            elmnt.style.top = `${Math.max(minTop, Math.min(newTop, maxTop))}px`; 
            elmnt.style.left = `${Math.max(minLeft, Math.min(newLeft, maxLeft))}px`; 
        } 
        
        function closeDragElement() { 
            document.onmouseup = null; 
            document.onmousemove = null; 
            elmnt.classList.remove('dragging'); 
            
            elmnt.querySelectorAll('iframe, canvas').forEach(el => el.style.pointerEvents = 'auto');
        } 
    }

    // --- Init ---
    window.onload = initializeDesktop;
    const resizeObserver = new ResizeObserver(() => {
        // Don't re-render everything, just what's needed
        if (isMobile()) {
            renderMobileIcons();
        }
    });
    resizeObserver.observe(document.body);

</script>

</body>
</html>