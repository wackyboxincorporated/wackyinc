<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>merlin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            background-color: #222; /* Dark background for the page */
            color: #fff;
            font-family: 'Press Start 2P', cursive, sans-serif; /* Pixel font */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scrollbars from page elements */
        }

        /* Import a pixel font */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        #gameContainer {
            width: 90vmin; /* Use vmin to fit in smallest dimension */
            height: calc(90vmin * 0.75); /* 4:3 aspect ratio (480/640) */
            max-width: 1280px; /* Max reasonable width */
            max-height: 960px; /* Max reasonable height */
            margin: auto;
            position: relative; /* For potential absolute positioning of UI elements */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            border: 5px solid #4a4a4a; /* SNES-like chunky border */
            background-color: #000; /* Default, overridden by level */
            box-sizing: border-box;
        }

        #gameTitle {
            font-size: clamp(1.5rem, 5vmin, 3rem);
            margin-bottom: 20px;
            text-shadow: 3px 3px 0px #0000AA; /* Retro shadow */
        }
        #controlsInfo {
            font-size: clamp(0.8rem, 2vmin, 1.2rem);
            margin-top: 10px;
            color: #ccc;
        }

        /* Placeholder for music */
        audio {
            display: none;
        }

        /* Message overlay for game states */
        #messageOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: clamp(1rem, 4vmin, 2rem);
            z-index: 10; /* Ensure it's on top of the canvas */
            padding: 20px;
            box-sizing: border-box;
        }
        #messageOverlay h2 {
            font-size: clamp(1.5rem, 5vmin, 2.5rem);
            margin-bottom: 15px;
        }
        #messageOverlay p {
            font-size: clamp(0.9rem, 3vmin, 1.5rem);
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <h1 id="gameTitle">merlin</h1>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="messageOverlay" style="display: none;">
            <h2 id="messageTitle"></h2>
            <p id="messageText"></p>
            <p id="messagePrompt" style="margin-top: 20px; font-size: clamp(0.8rem, 2.5vmin, 1.2rem);"></p>
        </div>
    </div>
    <p id="controlsInfo">Controls: Left/Right Arrows to Move, Up Arrow to Jump</p>
    <audio id="bgm" loop src="https://file.garden/ZMbUnW5nmTe-x54m/nasa.mp3"></audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const CANVAS_WIDTH = 640;
        const CANVAS_HEIGHT = 480;
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;

        const TILE_SIZE = 32; // For a 20x15 grid on 640x480
        const LEVEL_COLS = CANVAS_WIDTH / TILE_SIZE; // 20
        const LEVEL_ROWS = CANVAS_HEIGHT / TILE_SIZE; // 15

        // Game constants
        const GRAVITY = 0.5;
        const PLAYER_SPEED = 2.5;
        const JUMP_FORCE = -12; // Negative for upward movement

        // Player object
        const player = {
            x: TILE_SIZE * 2,
            y: CANVAS_HEIGHT - TILE_SIZE * 3,
            width: TILE_SIZE * 0.8,
            height: TILE_SIZE * 1.4, // Merlin is a bit taller
            vx: 0, // Velocity x
            vy: 0, // Velocity y
            onGround: false,
            color: '#3A5FCD', // Merlin's robe blue
            hatColor: '#27408B', // Darker blue for hat
            faceColor: '#FFDAB9', // Peach for face
            lives: 3,
            score: 0,
            invincibleTimer: 0 // Timer for invincibility after being hit
        };

        let currentLevelIndex = 0;
        let gameState = 'MENU'; // MENU, LOADING, PLAYING, LEVEL_COMPLETE, GAME_OVER, GAME_WON

        const keys = {
            left: false,
            right: false,
            up: false
        };

        // Message Overlay Elements
        const messageOverlay = document.getElementById('messageOverlay');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const messagePrompt = document.getElementById('messagePrompt');
        
        // Sound Manager (simple version using HTML Audio and Tone.js for effects)
        const soundManager = {
            music: document.getElementById('bgm'),
            userInteracted: false, // Flag to ensure music plays only after user interaction
            jumpSynth: null,
            collectSynth: null,
            hitSynth: null,

            init() {
                // Initialize Tone.js synths for sound effects
                if (typeof Tone !== 'undefined') {
                    // Set volume for each synth to 65% of original (approx -3.7 dB for linear reduction, -4dB for simplicity)
                    this.jumpSynth = new Tone.Synth().toDestination();
                    this.jumpSynth.volume.value = -4; 

                    this.collectSynth = new Tone.Synth().toDestination();
                    this.collectSynth.volume.value = -4;

                    this.hitSynth = new Tone.NoiseSynth().toDestination(); // Noise for hit
                    this.hitSynth.volume.value = -4;
                }
            },
            playMusic() {
                if (this.userInteracted && this.music && this.music.paused) {
                    this.music.play().catch(e => console.warn("Music play failed. User interaction might be required.", e));
                }
            },
            stopMusic() {
                if (this.music) this.music.pause();
            },
            playSound(type) {
                if (typeof Tone === 'undefined') {
                    console.log(`Sound: ${type} (Tone.js not loaded)`);
                    return;
                }
                try {
                    switch (type) {
                        case 'jump':
                            if (this.jumpSynth) this.jumpSynth.triggerAttackRelease("C5", "8n");
                            break;
                        case 'collect':
                            if (this.collectSynth) this.collectSynth.triggerAttackRelease("E5", "16n");
                            break;
                        case 'hit':
                            if (this.hitSynth) this.hitSynth.triggerAttackRelease("8n"); // Short noise burst
                            break;
                        case 'level_complete':
                            // More complex sound for level complete, e.g., a short melody
                            const melodySynth = new Tone.PolySynth(Tone.Synth).toDestination();
                            melodySynth.volume.value = -4; // Apply volume reduction to this synth too
                            const now = Tone.now();
                            melodySynth.triggerAttackRelease(["C4", "E4", "G4"], "8n", now);
                            melodySynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now + 0.15);
                            break;
                        // Add more cases for other sound effects
                    }
                } catch (e) {
                    console.error(`Error playing sound ${type}:`, e);
                }
            }
        };
        soundManager.init();


        // Level Definitions
        // 'G': Ground/Wall, 'P': Player Start, 'E': Exit, 'B': Platform Block, 'O': Obstacle/Hazard
        // 'C': Collectible
        const levelDefinitions = [
            { // Level 0: MS-DOS Prompt - SIMPLIFIED FOR EASY COMPLETION
                name: "MS-DOS Prompt",
                bgColor: "#0A0A0A",
                platformColor: "#00FF00", // Green text
                platformBorderColor: "#008000",
                textColor: "#00FF00",
                goalText: "Walk to the Floppy Disk!",
                tiles: [
                    "                   ",
                    " P                  ",
                    " GG                 ",
                    "   G                ",
                    "    G               ",
                    "                    ",
                    "           G        ",
                    "          G         ",
                    "         G          ",
                    "        G           ",
                    "       G            ",
                    "GG                  ",
                    "  GG               E", // Player and Exit on the same ground level
                    "GGGGGGGGGGGGGGGGGGGG",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'text', content: 'C:\\>', x: 1, y: 1, color: '#00FF00', font: '16px "Press Start 2P"' },
                    { type: 'text', content: 'VER', x: 1, y: 13, color: '#00FF00', font: '16px "Press Start 2P"' }
                ]
            },
            { // Level 1: Windows 3.1 - Program Manager
                name: "Windows 3.1 - Program Manager",
                bgColor: "#C0C0C0", // Windows grey
                platformColor: "#000080", // Window title bar blue
                platformBorderColor: "#FFFFFF", // White border
                textColor: "#000000",
                goalText: "Find the File Manager!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB", // Ceiling
                    "B                  B",
                    "B P   CCCC         B", // C for collectible
                    "BBBBBBBBB          B",
                    "B                  B",
                    "B          BBBB    B",
                    "B                  B",
                    "B  BBBB            B",
                    "B                  B",
                    "B O      BBBBBB    B",
                    "B                  B",
                    "B                  B",
                    "B    BBBBBB     E  ", // Path to exit is now clear
                    "B                  B",
                    "BBBBBBBBBBBBBBBBBBBB"
                ],
                themeObjects: [
                    { type: 'rect', x: 5, y: 5, w: 2, h: 1, color: '#000080', borderColor: '#FFFFFF', text: 'App', textColor: '#FFFFFF'}, // Program Manager like window
                    { type: 'rect', x: 12, y: 8, w: 3, h: 1, color: '#000080', borderColor: '#FFFFFF', text: 'Util', textColor: '#FFFFFF'}
                ]
            },
            { // Level 2: Windows 95 - The Start! (FIXED for clear path and accessible exit)
                name: "Windows 95 - The Start!",
                bgColor: "#008080", // Teal
                platformColor: "#C0C0C0", // Standard grey button
                platformBorderColor: "#808080", // Darker grey for 3D effect
                textColor: "#FFFFFF",
                goalText: "Hit the Start Button!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB", // row 0: Ceiling
                    "B                  B", // row 1: Empty
                    "B                  B", // row 2: Empty
                    "B P                B", // row 3: Player start
                    "GGGGGGGGGGGGG    GGB", // row 4: Solid Ground, with E on the ground
                    "B                  B", // row 5
                    "B  BBBB            B", // row 6: Platform
                    "B                  B", // row 7
                    "B        O         B", // row 8: Obstacle (can jump over)
                    "B    BBBB          B", // row 9: Platform
                    "B  E               B", // row 10
                    "BBBBBBBBBBBBBBBBBBBB", // row 11
                    "BBBBBBBBBBBBBBBBBBBB", // row 12
                    "BBBBBBBBBBBBBBBBBBBB", // row 13
                    "BBBBBBBBBBBBBBBBBBBB"  // row 14
                ],
                themeObjects: [
                    { type: 'text', content: 'My Computer', x: 1, y: 1, color: '#FFFFFF', font: '12px "Press Start 2P"' },
                    { type: 'text', content: 'Recycle Bin', x: 15, y: 1, color: '#FFFFFF', font: '12px "Press Start 2P"' }
                ]
            },
            { // Level 3: Windows 98 - Active Desktop
                name: "Windows 98 - Active Desktop",
                bgColor: "#008080", // Teal (similar to Win95)
                platformColor: "#C0C0C0",
                platformBorderColor: "#808080",
                textColor: "#FFFFFF",
                goalText: "Connect to the Internet!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B                  B",
                    "B P                B",
                    "B        BBBB      B",
                    "B                  B",
                    "B            BBBB  B",
                    "B                  B",
                    "B      BBBB        B",
                    "B                  B",
                    "B  O               B",
                    "B        C         B",
                    "B          BBBB    B",
                    "B                  B",
                    "B               E  B",
                    "BBBBBBBBBBBBBBBBBBBB"
                ],
                themeObjects: [
                    { type: 'text', content: 'Internet Explorer', x: 1, y: 1, color: '#FFFFFF', font: '12px "Press Start 2P"' },
                    { type: 'text', content: 'Outlook Express', x: 13, y: 1, color: '#FFFFFF', font: '12px "Press Start 2P"' },
                    { type: 'rect', x: 8, y: 10, w: 2, h: 1, color: '#0000FF', borderColor: '#FFFFFF', text: 'Pop-up', textColor: '#FFFFFF'} // Pop-up ad block
                ]
            },
            { // Level 4: Windows XP - Bliss Hill
                name: "Windows XP - Bliss Hill",
                bgColor: "#3366CC", // XP blue sky
                platformColor: "#008000", // Green hill
                platformBorderColor: "#004000",
                textColor: "#FFFFFF",
                goalText: "Find the Bliss!",
                tiles: [
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "          GG        ",
                    "      GGG           ",
                    " P  G               ",
                    "GGGGGGGGGGGG       G",
                    "G                C G",
                    "G              GGGOG",
                    "GCCC           GG  G",
                    "G    GGGOGOGGGGG   G",
                    "GGG                G",
                    "G     CCC        E G",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'text', content: 'My Computer', x: 1, y: 1, color: '#FFFFFF', font: '12px "Press Start 2P"' },
                    { type: 'text', content: 'My Pictures', x: 14, y: 1, color: '#FFFFFF', font: '12px "Press Start 2P"' },
                    { type: 'rect', x: 7, y: 10, w: 1, h: 1, color: '#0000FF', borderColor: '#FFFFFF', text: 'BSOD', textColor: '#FFFFFF'} // Blue Screen of Death obstacle
                ]
            },
            { // Level 5: Windows Vista - Aero Glass
                name: "Windows Vista - Aero Glass",
                bgColor: "#336699", // Vista blue/grey
                platformColor: "rgba(150, 200, 255, 0.5)", // Semi-transparent platforms
                platformBorderColor: "#FFFFFF",
                textColor: "#FFFFFF",
                goalText: "Navigate the UAC!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B                  B",
                    "B  P               B",
                    "BOOBBBBBBBB        B",
                    "B                  B",
                    "B            BBBB  B",
                    "B                  B",
                    "B      BBBB        B",
                    "B                  B",
                    "B  O               B",
                    "B        C         B",
                    "B          BBBB    B",
                    "B                  B",
                    "B               E  B",
                    "BBBBBBBBBBBBBBBBBBBB"
                ],
                themeObjects: [
                    { type: 'rect', x: 3, y: 3, w: 4, h: 2, color: 'rgba(200, 220, 255, 0.3)', borderColor: '#FFFFFF', text: 'Window', textColor: '#FFFFFF'},
                    { type: 'rect', x: 12, y: 6, w: 3, h: 1, color: 'rgba(200, 220, 255, 0.3)', borderColor: '#FFFFFF', text: 'Gadget', textColor: '#FFFFFF'}
                ]
            },
            { // Level 6: Windows 7 - Taskbar Jump
                name: "Windows 7 - Taskbar Jump",
                bgColor: "#0078D7", // Win7 blue
                platformColor: "#C0C0C0",
                platformBorderColor: "#808080",
                textColor: "#FFFFFF",
                goalText: "Pin to Taskbar!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B                  B",
                    "B P                B",
                    "BBBBBBBBB          B",
                    "B          C       B",
                    "B        BBBB      B",
                    "B                  B",
                    "B            BBBB  B",
                    "B                  B",
                    "BOOOOOO            B",
                    "B                  B",
                    "B          BBBB    B",
                    "B                  B",
                    "B       E          B",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'rect', x: 1, y: 14, w: 3, h: 1, color: '#404040', borderColor: '#FFFFFF', text: 'Start', textColor: '#FFFFFF'},
                    { type: 'rect', x: 5, y: 14, w: 2, h: 1, color: '#404040', borderColor: '#FFFFFF', text: 'IE', textColor: '#FFFFFF'},
                    { type: 'rect', x: 8, y: 14, w: 2, h: 1, color: '#404040', borderColor: '#FFFFFF', text: 'Folder', textColor: '#FFFFFF'}
                ]
            },
            { // Level 7: Windows 8 - Metro UI
                name: "Windows 8 - Metro UI",
                bgColor: "#008C95", // Win8 Teal
                platformColor: "#222222", // Dark tiles
                platformBorderColor: "#FFFFFF",
                textColor: "#FFFFFF",
                goalText: "Swipe to the Desktop!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B            O     B",
                    "B P            O   B",
                    "BBBBBBB     BBBB   B",
                    "B     O            B",
                    "B     O            B",
                    "B     O            B",
                    "B     OOOBBBBBBBB  B",
                    "B          B       B",
                    "B          B       B",
                    "B          B       B",
                    "B          BBBBBB  B",
                    "B  E               B",
                    "B                  B",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'rect', x: 1, y: 1, w: 3, h: 2, color: '#FF0000', text: 'Live Tile', textColor: '#FFFFFF'},
                    { type: 'rect', x: 5, y: 3, w: 2, h: 1, color: '#00FF00', text: 'App', textColor: '#FFFFFF'},
                    { type: 'rect', x: 8, y: 1, w: 4, h: 3, color: '#0000FF', text: 'Weather', textColor: '#FFFFFF'}
                ]
            },
            { // Level 8: Windows 10 - Start Menu Revival
                name: "Windows 10 - Start Menu Revival",
                bgColor: "#0078D7", // Win10 Blue
                platformColor: "#404040", // Darker grey
                platformBorderColor: "#808080",
                textColor: "#FFFFFF",
                goalText: "Find the Edge!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B                  B",
                    "B                  B",
                    "B         GGGGG    B",
                    "B      GGG     G   B",
                    "B              G E B",
                    "B GGGG         GGGGB",
                    "B  O  GGGG         B",
                    "B    O  O GGGG     B",
                    "B                  B",
                    "B             GGGG B",
                    "B         GGGG     B",
                    "B     GGG          B",
                    "B P GG             B",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'rect', x: 0, y: 1, w: 4, h: 13, color: '#222222', borderColor: '#FFFFFF', text: 'Start Menu', textColor: '#FFFFFF'}, // Start Menu sidebar
                    { type: 'rect', x: 1, y: 2, w: 2, h: 2, color: '#008000', text: 'Tile', textColor: '#FFFFFF'},
                    { type: 'rect', x: 1, y: 5, w: 2, h: 1, color: '#FF0000', text: 'App', textColor: '#FFFFFF'}
                ]
            },
            { // Level 9: Windows 11 - Centered Start
                name: "Windows 11 - Centered Start",
                bgColor: "#002030", // Dark blue/grey
                platformColor: "#505050",
                platformBorderColor: "#A0A0A0",
                textColor: "#FFFFFF",
                goalText: "Reach the Cloud!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B                E B",
                    "B             C    B",
                    "B              BBBB",
                    "B             B    B",
                    "B         C  B     B",
                    "B           B      B",
                    "B          B       B",
                    "B       C B        B",
                    "B        B         B",
                    "B       B          B",
                    "B    C B           B",
                    "B     B            B",
                    "B  P B             B",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'rect', x: 8, y: 14, w: 4, h: 1, color: '#303030', borderColor: '#FFFFFF', text: 'Taskbar', textColor: '#FFFFFF'},
                    { type: 'rect', x: 9, y: 13, w: 2, h: 1, color: '#0078D7', text: 'Start', textColor: '#FFFFFF'} // Centered Start button
                ]
            },
            { // Level 10: The Cloud - Abstract
                name: "The Cloud",
                bgColor: "#99CCFF", // Light blue sky
                platformColor: "#FFFFFF", // White clouds
                platformBorderColor: "#DDDDDD",
                textColor: "#000000",
                goalText: "Float to Data!",
                tiles: [
                    "                    ",
                    "                    ",
                    " P                  ",
                    " G                  ",
                    "         BBBB       ",
                    "                    ",
                    "   BBBB             ",
                    "                    ",
                    "         BBBB       ",
                    "                    ",
                    "   BBBB             ",
                    "                    ",
                    "         BBBB     E ",
                    "              GGGG  ",
                    "                    "
                ],
                themeObjects: [
                    { type: 'text', content: 'Data', x: 15, y: 1, color: '#000000', font: '16px "Press Start 2P"' },
                    { type: 'text', content: 'Server', x: 2, y: 10, color: '#000000', font: '12px "Press Start 2P"' }
                ]
            },
            { // Level 11: Mobile Age - Vertical Scrolling
                name: "Mobile Age",
                bgColor: "#333333", // Dark grey phone background
                platformColor: "#555555", // App icons
                platformBorderColor: "#AAAAAA",
                textColor: "#FFFFFF",
                goalText: "Tap and Scroll!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B        O         B",
                    "B P       O        B",
                    "B B        O       B",
                    "B           O      B",
                    "B   B        O     B",
                    "B O           O    B",
                    "B  O           OOOOB",
                    "B  O               B",
                    "B O                B",
                    "B  O               B",
                    "B   O              B",
                    "B  O               B",
                    "B O          E     B",
                    "BBBBBBBBBBBBBBBBBBBB"
                ],
                themeObjects: [
                    { type: 'rect', x: 2, y: 2, w: 2, h: 2, color: '#FF0000', text: 'App1', textColor: '#FFFFFF'},
                    { type: 'rect', x: 5, y: 4, w: 2, h: 2, color: '#00FF00', text: 'App2', textColor: '#FFFFFF'},
                    { type: 'rect', x: 8, y: 6, w: 2, h: 2, color: '#0000FF', text: 'App3', textColor: '#FFFFFF'},
                    { type: 'rect', x: 11, y: 8, w: 2, h: 2, color: '#FFFF00', text: 'App4', textColor: '#FFFFFF'},
                    { type: 'rect', x: 14, y: 10, w: 2, h: 2, color: '#00FFFF', text: 'App5', textColor: '#FFFFFF'}
                ]
            },
            { // Level 12: AI & Future - Neon Grid
                name: "AI & Future",
                bgColor: "#000000",
                platformColor: "#00FF00", // Neon green
                platformBorderColor: "#008000",
                textColor: "#00FF00",
                goalText: "Achieve Singularity!",
                tiles: [
                    "BBBBBBBBBBBBBBBBBBBB",
                    "B                  B",
                    "B P                B",
                    "B             B B B",
                    "B                  B",
                    "B B B B            B",
                    "B OOOOO            B",
                    "B         B B B B  B",
                    "B           OOOOOO B",
                    "B B B B            B",
                    "B                  B",
                    "B  B B B       B B B",
                    "B                  B",
                    "B         E        B",
                    "BBBBBBBBBBBBBBBBBBBB"
                ],
                themeObjects: [
                    { type: 'text', content: 'AI CORE', x: 8, y: 1, color: '#00FFFF', font: '18px "Press Start 2P"', align: 'center' },
                    { type: 'text', content: 'CODE', x: 1, y: 5, color: '#00FF00', font: '10px "Press Start 2P"' },
                    { type: 'text', content: 'DATA', x: 15, y: 8, color: '#FF00FF', font: '10px "Press Start 2P"' }
                ]
            },
            { // Level 13: Reality Check (End) - Simple Exit (FIXED)
                name: "Reality Check (End)",
                bgColor: "#CCCCCC", // Light grey
                platformColor: "#888888",
                platformBorderColor: "#444444",
                textColor: "#000000",
                goalText: "Back to the real world!",
                tiles: [
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    "                    ",
                    " P                 E", // Player and Exit on the same ground level, now with clear path
                    "GGGGGGGGGGGGGGGGGGGG",
                    "GGGGGGGGGGGGGGGGGGGG"
                ],
                themeObjects: [
                    { type: 'text', content: 'THE END', x: 8, y: 5, color: '#000000', font: '24px "Press Start 2P"', align: 'center' }
                ]
            }
        ];

        function createPlaceholderLevel() {
            // This function is now only used for the levels that haven't been explicitly designed yet.
            // It creates a simple box level with a start and end.
            const placeholder = [];
            for (let r = 0; r < LEVEL_ROWS; r++) {
                let rowStr = "";
                for (let c = 0; c < LEVEL_COLS; c++) {
                    if (r === 0 || r === LEVEL_ROWS - 1 || c === 0 || c === LEVEL_COLS - 1) rowStr += "G"; // Walls and floor
                    else if (r === LEVEL_ROWS - 2 && c === 2) rowStr += "P"; // Player start
                    else if (r === 2 && c === LEVEL_COLS - 3) rowStr += "E"; // Exit
                    else rowStr += " "; // Empty space
                }
                placeholder.push(rowStr);
            }
            return placeholder;
        }
        
        let currentLevelData = {};
        let currentTiles = [];
        let collectibles = []; // To store collectible objects for the current level

        function loadLevel(levelIndex) {
            if (levelIndex >= levelDefinitions.length) {
                gameState = 'GAME_WON';
                return;
            }
            currentLevelIndex = levelIndex;
            currentLevelData = levelDefinitions[levelIndex];
            currentTiles = currentLevelData.tiles.map(row => row.split(''));
            collectibles = []; // Reset collectibles

            // Find player start position 'P' and place collectibles 'C'
            let playerPlaced = false;
            for (let r = 0; r < LEVEL_ROWS; r++) {
                for (let c = 0; c < LEVEL_COLS; c++) {
                    if (currentTiles[r][c] === 'P') {
                        player.x = c * TILE_SIZE + (TILE_SIZE - player.width) / 2;
                        // Calculate the y-position based on the ground tile below 'P'
                        // Assuming 'P' is always one tile above the actual ground.
                        player.y = (r + 1) * TILE_SIZE - player.height; 
                        player.vx = 0;
                        player.vy = 0;
                        player.onGround = false;
                        playerPlaced = true;
                    }
                    if (currentTiles[r][c] === 'C') {
                        collectibles.push({
                            x: c * TILE_SIZE,
                            y: r * TILE_SIZE,
                            width: TILE_SIZE,
                            height: TILE_SIZE,
                            collected: false,
                            type: currentLevelData.name.includes("Windows 3.1") ? 'icon' : 
                                  currentLevelData.name.includes("Windows 95") ? 'solitaire' :
                                  currentLevelData.name.includes("Windows 98") ? 'shortcut' : // New collectible type
                                  currentLevelData.name.includes("Windows XP") ? 'recyclebin' : // New collectible type
                                  currentLevelData.name.includes("Windows Vista") ? 'sidebar_gadget' : 'generic' // New collectible type
                        });
                    }
                }
            }
            if (!playerPlaced) { // Default placement if 'P' not found
                player.x = TILE_SIZE * 2;
                player.y = CANVAS_HEIGHT - player.height; // Default to bottom ground
            }
            player.invincibleTimer = 0; // Reset invincibility
            gameState = 'PLAYING';
            soundManager.playMusic(); // Try to play music when level starts
        }

        function drawPlayer(pCtx) {
            // Flicker effect if invincible
            if (player.invincibleTimer > 0 && Math.floor(Date.now() / 100) % 2 === 0) {
                return; // Skip drawing to create flicker
            }

            const baseX = player.x;
            const baseY = player.y;
            const merlinWidth = player.width;
            const merlinHeight = player.height;

            // Robe
            pCtx.fillStyle = player.color;
            pCtx.fillRect(baseX, baseY + merlinHeight * 0.3, merlinWidth, merlinHeight * 0.7);

            // Hat
            pCtx.fillStyle = player.hatColor;
            pCtx.beginPath();
            pCtx.moveTo(baseX + merlinWidth * 0.5, baseY); // Tip of hat
            pCtx.lineTo(baseX, baseY + merlinHeight * 0.4);
            pCtx.lineTo(baseX + merlinWidth, baseY + merlinHeight * 0.4);
            pCtx.closePath();
            pCtx.fill();

            // Face
            pCtx.fillStyle = player.faceColor;
            pCtx.fillRect(baseX + merlinWidth * 0.25, baseY + merlinHeight * 0.2, merlinWidth * 0.5, merlinHeight * 0.15);
            
            // Staff (simple line)
            pCtx.strokeStyle = '#8B4513'; // Brown
            pCtx.lineWidth = 4;
            pCtx.beginPath();
            pCtx.moveTo(baseX + merlinWidth * 0.9, baseY + merlinHeight * 0.3);
            pCtx.lineTo(baseX + merlinWidth * 0.9, baseY + merlinHeight * 0.9);
            pCtx.stroke();
        }

        function drawLevel(lCtx) {
            lCtx.fillStyle = currentLevelData.bgColor || "#000000";
            lCtx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Draw theme objects (background elements)
            if (currentLevelData.themeObjects) {
                currentLevelData.themeObjects.forEach(obj => {
                    if (obj.type === 'text') {
                        lCtx.fillStyle = obj.color || currentLevelData.textColor;
                        lCtx.font = obj.font || '12px "Press Start 2P"';
                        lCtx.textAlign = obj.align || 'left';
                        lCtx.fillText(obj.content, obj.x * TILE_SIZE, obj.y * TILE_SIZE + TILE_SIZE * 0.8);
                    } else if (obj.type === 'rect') { // Themed rectangles (like mini windows)
                        lCtx.fillStyle = obj.color;
                        lCtx.fillRect(obj.x * TILE_SIZE, obj.y * TILE_SIZE, obj.w * TILE_SIZE, obj.h * TILE_SIZE);
                        if(obj.borderColor) {
                            lCtx.strokeStyle = obj.borderColor;
                            lCtx.lineWidth = 2;
                            lCtx.strokeRect(obj.x * TILE_SIZE, obj.y * TILE_SIZE, obj.w * TILE_SIZE, obj.h * TILE_SIZE);
                        }
                        if(obj.text) {
                            lCtx.fillStyle = obj.textColor || '#FFFFFF';
                            lCtx.font = '10px "Press Start 2P"';
                            lCtx.textAlign = 'center';
                            lCtx.fillText(obj.text, (obj.x + obj.w/2) * TILE_SIZE, (obj.y + obj.h/2 + 0.1) * TILE_SIZE );
                        }
                    }
                });
            }


            for (let r = 0; r < LEVEL_ROWS; r++) {
                for (let c = 0; c < LEVEL_COLS; c++) {
                    const tile = currentTiles[r][c];
                    const tileX = c * TILE_SIZE;
                    const tileY = r * TILE_SIZE;

                    if (tile === 'G' || tile === 'B') { // Ground or Platform Block
                        lCtx.fillStyle = currentLevelData.platformColor || "#888";
                        // Handle rgba colors for platforms (e.g., Vista's Aero Glass)
                        if (typeof currentLevelData.platformColor === 'string' && currentLevelData.platformColor.startsWith('rgba')) {
                            lCtx.fillStyle = currentLevelData.platformColor;
                        } else {
                            lCtx.fillStyle = currentLevelData.platformColor || "#888";
                        }
                        lCtx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
                        if (currentLevelData.platformBorderColor) {
                            lCtx.strokeStyle = currentLevelData.platformBorderColor;
                            lCtx.lineWidth = 2;
                            lCtx.strokeRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
                        }
                        // Simple 3D effect for 'B' blocks if distinct
                        if (tile === 'B' && currentLevelData.platformBorderColor) {
                             // Ensure lighten/darken work with hex only for now, or adapt for rgba
                             const baseColor = typeof currentLevelData.platformColor === 'string' && currentLevelData.platformColor.startsWith('#') ? currentLevelData.platformColor : '#888';
                             lCtx.fillStyle = lightenColor(baseColor, 20); // Top highlight
                             lCtx.fillRect(tileX + 2, tileY + 2, TILE_SIZE - 4, 2);
                             lCtx.fillStyle = darkenColor(baseColor, 20); // Bottom shadow
                             lCtx.fillRect(tileX + 2, tileY + TILE_SIZE - 4, TILE_SIZE - 4, 2);
                        }

                    } else if (tile === 'E') { // Exit
                        lCtx.fillStyle = "#FFD700"; // Gold
                        lCtx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
                        // Draw a simple E or icon for Exit
                        lCtx.fillStyle = "#000";
                        lCtx.font = 'bold 20px "Press Start 2P"';
                        lCtx.textAlign = 'center';
                        lCtx.fillText("E", tileX + TILE_SIZE / 2, tileY + TILE_SIZE * 0.75);
                        
                        // Specific goal icons
                        if (currentLevelData.name.includes("MS-DOS")) { // Floppy
                            drawFloppyDisk(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 3.1")) { // File Manager Icon
                            drawFileManagerIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 95")) { // Start Button
                            drawStartButton(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 98")) { // Internet Explorer
                            drawInternetExplorerIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows XP")) { // Bliss Hill Icon
                            drawBlissHillIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows Vista")) { // UAC Shield
                            drawUACShieldIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 7")) { // Jump List Icon
                            drawJumpListIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 8")) { // Desktop Tile
                            drawDesktopTileIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 10")) { // Edge Icon
                            drawEdgeIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 11")) { // Cloud Icon
                            drawCloudIcon(lCtx, tileX, tileY);
                        }


                    } else if (tile === 'O') { // Obstacle
                        lCtx.fillStyle = "red";
                        lCtx.fillRect(tileX + TILE_SIZE * 0.2, tileY + TILE_SIZE * 0.2, TILE_SIZE * 0.6, TILE_SIZE * 0.6);
                        // MS-DOS Blinking Cursor Obstacle
                        if (currentLevelData.name.includes("MS-DOS")) {
                            lCtx.fillStyle = currentLevelData.textColor;
                            if (Math.floor(Date.now() / 500) % 2 === 0) { // Blink
                                lCtx.fillRect(tileX, tileY + TILE_SIZE * 0.8, TILE_SIZE, TILE_SIZE * 0.2);
                            }
                        } else if (currentLevelData.name.includes("Windows XP")) { // Blue Screen of Death (BSOD)
                            drawBSOD(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows Vista")) { // UAC Prompt
                            drawUACPrompt(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 7")) { // Windows Update
                            drawWindowsUpdateIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 8")) { // Charms Bar
                            drawCharmsBarIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 10")) { // Cortana
                            drawCortanaIcon(lCtx, tileX, tileY);
                        } else if (currentLevelData.name.includes("Windows 11")) { // Teams Icon
                            drawTeamsIcon(lCtx, tileX, tileY);
                        }
                        else { // Generic hazard
                             lCtx.fillStyle = "red";
                             lCtx.font = 'bold 20px "Press Start 2P"';
                             lCtx.textAlign = 'center';
                             lCtx.fillText("!", tileX + TILE_SIZE / 2, tileY + TILE_SIZE * 0.75);
                        }
                    }
                }
            }
            // Draw collectibles
            collectibles.forEach(collectible => {
                if (!collectible.collected) {
                    lCtx.fillStyle = "#FFFF00"; // Yellow for generic collectible
                    if (collectible.type === 'icon' && currentLevelData.name.includes("Windows 3.1")) { // Program Manager Icon
                        drawProgmanIcon(lCtx, collectible.x, collectible.y);
                    } else if (currentLevelData.name.includes("Windows 95")){ // Solitaire Card
                        drawSolitaireCard(lCtx, collectible.x, collectible.y);
                    } else if (currentLevelData.name.includes("Windows 98")){ // Shortcut Icon
                        drawShortcutIcon(lCtx, collectible.x, collectible.y);
                    } else if (currentLevelData.name.includes("Windows XP")){ // Recycle Bin
                        drawRecycleBinIcon(lCtx, collectible.x, collectible.y);
                    } else if (currentLevelData.name.includes("Windows Vista")){ // Sidebar Gadget
                        drawSidebarGadgetIcon(lCtx, collectible.x, collectible.y);
                    } else if (collectible.type === 'jump_list_item' && currentLevelData.name.includes("Windows 7")) { // Jump List Item
                        drawJumpListItem(lCtx, collectible.x, collectible.y);
                    } else if (collectible.type === 'app_tile' && currentLevelData.name.includes("Windows 8")) { // App Tile
                        drawAppTile(lCtx, collectible.x, collectible.y);
                    } else if (collectible.type === 'search_bar' && currentLevelData.name.includes("Windows 10")) { // Search Bar
                        drawSearchBar(lCtx, collectible.x, collectible.y);
                    } else if (collectible.type === 'widget' && currentLevelData.name.includes("Windows 11")) { // Widget
                        drawWidget(lCtx, collectible.x, collectible.y);
                    }
                     else {
                        lCtx.beginPath();
                        lCtx.arc(collectible.x + TILE_SIZE / 2, collectible.y + TILE_SIZE / 2, TILE_SIZE / 3, 0, Math.PI * 2);
                        lCtx.fill();
                    }
                }
            });
        }
        
        // Helper drawing functions for themed items
        function hexToRgb(hex) {
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            return [r, g, b];
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        function lightenColor(hex, percent) {
            const [r, g, b] = hexToRgb(hex);
            const newR = Math.min(255, r + (255 - r) * percent / 100);
            const newG = Math.min(255, g + (255 - g) * percent / 100);
            const newB = Math.min(255, b + (255 - b) * percent / 100);
            return rgbToHex(Math.round(newR), Math.round(newG), Math.round(newB));
        }

        function darkenColor(hex, percent) {
            const [r, g, b] = hexToRgb(hex);
            const newR = Math.max(0, r - r * percent / 100);
            const newG = Math.max(0, g - g * percent / 100);
            const newB = Math.max(0, b - b * percent / 100);
            return rgbToHex(Math.round(newR), Math.round(newG), Math.round(newB));
        }

        function drawFloppyDisk(fCtx, x, y) {
            fCtx.fillStyle = "#5555DD"; // Dark blue floppy
            fCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            fCtx.fillStyle = "#CCCCCC"; // Silver shutter
            fCtx.fillRect(x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.15, TILE_SIZE * 0.4, TILE_SIZE * 0.5);
            fCtx.fillStyle = "#FFFFFF"; // Label
            fCtx.fillRect(x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.7, TILE_SIZE * 0.6, TILE_SIZE * 0.15);
        }

        function drawFileManagerIcon(fmCtx, x, y) { // Simplified File Manager Cabinet
            fmCtx.fillStyle = "#FFDF00"; // Yellow folder color
            fmCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.2, TILE_SIZE * 0.8, TILE_SIZE * 0.6); // Main body
            fmCtx.fillStyle = "#D4B000"; // Darker yellow for handle/detail
            fmCtx.fillRect(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.1, TILE_SIZE * 0.2, TILE_SIZE * 0.1); // Top tab
            fmCtx.fillRect(x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.4, TILE_SIZE * 0.6, TILE_SIZE * 0.05); // Drawer line
        }
        
        function drawStartButton(sCtx, x, y) {
            sCtx.fillStyle = "#C0C0C0"; // Grey button
            sCtx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
            // Add 3D effect
            sCtx.fillStyle = "#FFFFFF"; // Highlight
            sCtx.beginPath();
            sCtx.moveTo(x, y + TILE_SIZE);
            sCtx.lineTo(x, y);
            sCtx.lineTo(x + TILE_SIZE, y);
            sCtx.lineTo(x + TILE_SIZE - 2, y + 2);
            sCtx.lineTo(x + 2, y + 2);
            sCtx.lineTo(x + 2, y + TILE_SIZE -2);
            sCtx.closePath();
            sCtx.fill();

            sCtx.fillStyle = "#808080"; // Shadow
            sCtx.beginPath();
            sCtx.moveTo(x + TILE_SIZE, y);
            sCtx.lineTo(x + TILE_SIZE, y + TILE_SIZE);
            sCtx.lineTo(x, y + TILE_SIZE);
            sCtx.lineTo(x + 2, y + TILE_SIZE - 2);
            sCtx.lineTo(x + TILE_SIZE - 2, y + TILE_SIZE - 2);
            sCtx.lineTo(x + TILE_SIZE - 2, y + 2);
            sCtx.closePath();
            sCtx.fill();

            // Windows Flag (simplified)
            const flagX = x + TILE_SIZE * 0.15;
            const flagY = y + TILE_SIZE * 0.15;
            const flagSize = TILE_SIZE * 0.2;
            sCtx.fillStyle = "#FF0000"; sCtx.fillRect(flagX, flagY, flagSize, flagSize); // Red
            sCtx.fillStyle = "#00FF00"; sCtx.fillRect(flagX + flagSize + 1, flagY, flagSize, flagSize); // Green
            sCtx.fillStyle = "#0000FF"; sCtx.fillRect(flagX, flagY + flagSize + 1, flagSize, flagSize); // Blue
            sCtx.fillStyle = "#FFFF00"; sCtx.fillRect(flagX + flagSize + 1, flagY + flagSize + 1, flagSize, flagSize); // Yellow
            
            sCtx.fillStyle = "#000000";
            sCtx.font = 'bold 8px "Press Start 2P"';
            sCtx.textAlign = 'left';
            sCtx.fillText("Start", x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.85);
        }

        function drawProgmanIcon(pCtx, x, y) { // Simplified Program Manager icon (e.g., a blue square with white dots)
            pCtx.fillStyle = "#0000A0"; // Dark blue
            pCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            pCtx.fillStyle = "#FFFFFF"; // White dots
            pCtx.fillRect(x + TILE_SIZE * 0.3, y + TILE_SIZE * 0.3, TILE_SIZE * 0.1, TILE_SIZE * 0.1);
            pCtx.fillRect(x + TILE_SIZE * 0.6, y + TILE_SIZE * 0.3, TILE_SIZE * 0.1, TILE_SIZE * 0.1);
            pCtx.fillRect(x + TILE_SIZE * 0.3, y + TILE_SIZE * 0.6, TILE_SIZE * 0.1, TILE_SIZE * 0.1);
            pCtx.fillRect(x + TILE_SIZE * 0.6, y + TILE_SIZE * 0.6, TILE_SIZE * 0.1, TILE_SIZE * 0.1);
        }

        function drawSolitaireCard(sCtx, x, y) {
            sCtx.fillStyle = "#FFFFFF"; // White card
            sCtx.fillRect(x + TILE_SIZE * 0.15, y + TILE_SIZE * 0.1, TILE_SIZE * 0.7, TILE_SIZE * 0.8);
            sCtx.strokeStyle = "#000000";
            sCtx.lineWidth = 1;
            sCtx.strokeRect(x + TILE_SIZE * 0.15, y + TILE_SIZE * 0.1, TILE_SIZE * 0.7, TILE_SIZE * 0.8);
            // Simple red diamond
            sCtx.fillStyle = "#FF0000";
            sCtx.beginPath();
            sCtx.moveTo(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.3);
            sCtx.lineTo(x + TILE_SIZE * 0.6, y + TILE_SIZE * 0.5);
            sCtx.lineTo(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.7);
            sCtx.lineTo(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.5);
            sCtx.closePath();
            sCtx.fill();
        }

        function drawInternetExplorerIcon(ieCtx, x, y) {
            ieCtx.fillStyle = "#0000FF"; // Blue 'e'
            ieCtx.beginPath();
            ieCtx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.4, 0, Math.PI * 2);
            ieCtx.fill();
            ieCtx.fillStyle = "#FFFFFF"; // White highlight
            ieCtx.beginPath();
            ieCtx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.3, 0, Math.PI * 2);
            ieCtx.fill();
            ieCtx.fillStyle = "#0000FF"; // Smaller blue 'e'
            ieCtx.font = 'bold ' + (TILE_SIZE * 0.6) + 'px Arial'; // Use Arial for 'e'
            ieCtx.textAlign = 'center';
            ieCtx.textBaseline = 'middle';
            ieCtx.fillText("e", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }

        function drawBlissHillIcon(bhCtx, x, y) {
            bhCtx.fillStyle = "#3366CC"; // Sky blue
            bhCtx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
            bhCtx.fillStyle = "#008000"; // Green hill
            bhCtx.beginPath();
            bhCtx.moveTo(x, y + TILE_SIZE);
            bhCtx.lineTo(x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.5);
            bhCtx.lineTo(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.8);
            bhCtx.lineTo(x + TILE_SIZE * 0.8, y + TILE_SIZE * 0.4);
            bhCtx.lineTo(x + TILE_SIZE, y + TILE_SIZE);
            bhCtx.closePath();
            bhCtx.fill();
            bhCtx.fillStyle = "#FFFFFF"; // Cloud
            bhCtx.beginPath();
            bhCtx.arc(x + TILE_SIZE * 0.7, y + TILE_SIZE * 0.2, TILE_SIZE * 0.15, 0, Math.PI * 2);
            bhCtx.arc(x + TILE_SIZE * 0.8, y + TILE_SIZE * 0.3, TILE_SIZE * 0.1, 0, Math.PI * 2);
            bhCtx.fill();
        }

        function drawUACShieldIcon(uacCtx, x, y) {
            uacCtx.fillStyle = "#0000FF"; // Blue shield
            uacCtx.beginPath();
            uacCtx.moveTo(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.1);
            uacCtx.lineTo(x + TILE_SIZE * 0.9, y + TILE_SIZE * 0.3);
            uacCtx.lineTo(x + TILE_SIZE * 0.9, y + TILE_SIZE * 0.7);
            uacCtx.lineTo(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.9);
            uacCtx.lineTo(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.7);
            uacCtx.lineTo(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.3);
            uacCtx.closePath();
            uacCtx.fill();
            uacCtx.fillStyle = "#FFFFFF"; // White checkmark
            uacCtx.font = 'bold ' + (TILE_SIZE * 0.5) + 'px Arial';
            uacCtx.textAlign = 'center';
            uacCtx.textBaseline = 'middle';
            uacCtx.fillText("✓", x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.5);
        }

        function drawBSOD(bsodCtx, x, y) {
            bsodCtx.fillStyle = "#0000AA"; // Dark blue background
            bsodCtx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
            bsodCtx.fillStyle = "#FFFFFF"; // White text
            bsodCtx.font = 'bold ' + (TILE_SIZE * 0.2) + 'px "Press Start 2P"';
            bsodCtx.textAlign = 'left';
            bsodCtx.fillText("ERROR", x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.3);
            bsodCtx.fillText("CRITICAL", x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.6);
        }

        function drawUACPrompt(uacpCtx, x, y) {
            uacpCtx.fillStyle = "rgba(0,0,0,0.7)"; // Dark overlay
            uacpCtx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
            uacpCtx.fillStyle = "#FFFFFF";
            uacpCtx.font = 'bold ' + (TILE_SIZE * 0.2) + 'px "Press Start 2P"';
            uacpCtx.textAlign = 'center';
            uacpCtx.fillText("UAC", x + TILE_SIZE / 2, y + TILE_SIZE * 0.4);
            uacpCtx.fillText("?", x + TILE_SIZE / 2, y + TILE_SIZE * 0.7);
        }

        function drawShortcutIcon(scCtx, x, y) {
            scCtx.fillStyle = "#00AA00"; // Green arrow
            scCtx.beginPath();
            scCtx.moveTo(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.5);
            scCtx.lineTo(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.2);
            scCtx.lineTo(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.4);
            scCtx.lineTo(x + TILE_SIZE * 0.8, y + TILE_SIZE * 0.4);
            scCtx.lineTo(x + TILE_SIZE * 0.8, y + TILE_SIZE * 0.6);
            scCtx.lineTo(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.6);
            scCtx.lineTo(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.8);
            scCtx.closePath();
            scCtx.fill();
        }

        function drawRecycleBinIcon(rbCtx, x, y) {
            rbCtx.fillStyle = "#CCCCCC"; // Grey bin
            rbCtx.fillRect(x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.3, TILE_SIZE * 0.6, TILE_SIZE * 0.5);
            rbCtx.fillStyle = "#888888"; // Lid
            rbCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.2, TILE_SIZE * 0.8, TILE_SIZE * 0.1);
            rbCtx.fillStyle = "#FF0000"; // Red circle for 'empty'
            rbCtx.beginPath();
            rbCtx.arc(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.55, TILE_SIZE * 0.15, 0, Math.PI * 2);
            rbCtx.fill();
        }

        function drawSidebarGadgetIcon(sgCtx, x, y) {
            sgCtx.fillStyle = "rgba(255,255,255,0.2)"; // Transparent background
            sgCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            sgCtx.strokeStyle = "#FFFFFF";
            sgCtx.lineWidth = 1;
            sgCtx.strokeRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            sgCtx.fillStyle = "#00AAFF"; // Blue icon
            sgCtx.beginPath();
            sgCtx.arc(x + TILE_SIZE * 0.5, y + TILE_SIZE * 0.5, TILE_SIZE * 0.2, 0, Math.PI * 2);
            sgCtx.fill();
        }

        function drawJumpListIcon(jlCtx, x, y) {
            jlCtx.fillStyle = "#0078D7"; // Windows 7 blue
            jlCtx.fillRect(x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.2, TILE_SIZE * 0.6, TILE_SIZE * 0.6);
            jlCtx.fillStyle = "#FFFFFF"; // White document icon
            jlCtx.fillRect(x + TILE_SIZE * 0.3, y + TILE_SIZE * 0.3, TILE_SIZE * 0.4, TILE_SIZE * 0.4);
            jlCtx.fillRect(x + TILE_SIZE * 0.4, y + TILE_SIZE * 0.25, TILE_SIZE * 0.2, TILE_SIZE * 0.05); // Folded corner
        }

        function drawWindowsUpdateIcon(wuCtx, x, y) {
            wuCtx.fillStyle = "#FF0000"; // Red X
            wuCtx.font = 'bold ' + (TILE_SIZE * 0.6) + 'px Arial';
            wuCtx.textAlign = 'center';
            wuCtx.textBaseline = 'middle';
            wuCtx.fillText("X", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
            wuCtx.strokeStyle = "#FFFF00"; // Yellow circle
            wuCtx.lineWidth = 2;
            wuCtx.beginPath();
            wuCtx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.4, 0, Math.PI * 2);
            wuCtx.stroke();
        }

        function drawDesktopTileIcon(dtCtx, x, y) {
            dtCtx.fillStyle = "#008C95"; // Windows 8 Teal
            dtCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            dtCtx.fillStyle = "#FFFFFF";
            dtCtx.font = 'bold ' + (TILE_SIZE * 0.3) + 'px "Press Start 2P"';
            dtCtx.textAlign = 'center';
            dtCtx.textBaseline = 'middle';
            dtCtx.fillText("APP", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }

        function drawCharmsBarIcon(cbCtx, x, y) {
            cbCtx.fillStyle = "rgba(0,0,0,0.5)"; // Semi-transparent
            cbCtx.fillRect(x + TILE_SIZE * 0.7, y, TILE_SIZE * 0.3, TILE_SIZE); // Right side bar
            cbCtx.fillStyle = "#FFFFFF";
            cbCtx.font = 'bold ' + (TILE_SIZE * 0.2) + 'px "Press Start 2P"';
            cbCtx.textAlign = 'center';
            cbCtx.fillText("...", x + TILE_SIZE * 0.85, y + TILE_SIZE * 0.5);
        }

        function drawEdgeIcon(eCtx, x, y) {
            eCtx.fillStyle = "#0078D7"; // Microsoft Edge blue
            eCtx.beginPath();
            eCtx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.4, 0, Math.PI * 2);
            eCtx.fill();
            eCtx.fillStyle = "#FFFFFF"; // White 'e'
            eCtx.font = 'bold ' + (TILE_SIZE * 0.6) + 'px Arial';
            eCtx.textAlign = 'center';
            eCtx.textBaseline = 'middle';
            eCtx.fillText("e", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }

        function drawCortanaIcon(cCtx, x, y) {
            cCtx.fillStyle = "#0078D7"; // Cortana blue
            cCtx.beginPath();
            cCtx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.3, 0, Math.PI * 2);
            cCtx.fill();
            cCtx.fillStyle = "#FFFFFF";
            cCtx.font = 'bold ' + (TILE_SIZE * 0.2) + 'px "Press Start 2P"';
            cCtx.textAlign = 'center';
            cCtx.textBaseline = 'middle';
            cCtx.fillText("C", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }

        function drawCloudIcon(cCtx, x, y) {
            cCtx.fillStyle = "#FFFFFF"; // White cloud
            cCtx.beginPath();
            cCtx.arc(x + TILE_SIZE * 0.3, y + TILE_SIZE * 0.6, TILE_SIZE * 0.2, 0, Math.PI * 2);
            cCtx.arc(x + TILE_SIZE * 0.6, y + TILE_SIZE * 0.4, TILE_SIZE * 0.3, 0, Math.PI * 2);
            cCtx.arc(x + TILE_SIZE * 0.8, y + TILE_SIZE * 0.6, TILE_SIZE * 0.2, 0, Math.PI * 2);
            cCtx.fill();
        }

        function drawTeamsIcon(tCtx, x, y) {
            tCtx.fillStyle = "#6264A7"; // Teams purple
            tCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            tCtx.fillStyle = "#FFFFFF";
            tCtx.font = 'bold ' + (TILE_SIZE * 0.4) + 'px Arial';
            tCtx.textAlign = 'center';
            tCtx.textBaseline = 'middle';
            tCtx.fillText("T", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }

        function drawAppTile(atCtx, x, y) {
            atCtx.fillStyle = "#00AA00"; // Example app tile color
            atCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            atCtx.fillStyle = "#FFFFFF";
            atCtx.font = 'bold ' + (TILE_SIZE * 0.3) + 'px "Press Start 2P"';
            atCtx.textAlign = 'center';
            atCtx.textBaseline = 'middle';
            atCtx.fillText("APP", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }

        function drawSearchBar(sbCtx, x, y) {
            sbCtx.fillStyle = "#FFFFFF";
            sbCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.3, TILE_SIZE * 0.8, TILE_SIZE * 0.4);
            sbCtx.strokeStyle = "#888888";
            sbCtx.lineWidth = 1;
            sbCtx.strokeRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.3, TILE_SIZE * 0.8, TILE_SIZE * 0.4);
            sbCtx.fillStyle = "#000000";
            sbCtx.font = 'bold ' + (TILE_SIZE * 0.2) + 'px Arial';
            sbCtx.textAlign = 'left';
            sbCtx.fillText("Search...", x + TILE_SIZE * 0.2, y + TILE_SIZE * 0.55);
        }

        function drawWidget(wCtx, x, y) {
            wCtx.fillStyle = "rgba(255,255,255,0.1)"; // Transparent background
            wCtx.fillRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            wCtx.strokeStyle = "#FFFFFF";
            wCtx.lineWidth = 1;
            wCtx.strokeRect(x + TILE_SIZE * 0.1, y + TILE_SIZE * 0.1, TILE_SIZE * 0.8, TILE_SIZE * 0.8);
            wCtx.fillStyle = "#00AAFF"; // Example widget content
            wCtx.font = 'bold ' + (TILE_SIZE * 0.3) + 'px Arial';
            wCtx.textAlign = 'center';
            wCtx.textBaseline = 'middle';
            wCtx.fillText("W", x + TILE_SIZE / 2, y + TILE_SIZE / 2);
        }


        function isSolid(tileType) {
            return tileType === 'G' || tileType === 'B';
        }

        function updatePlayer() {
            // Decrease invincibility timer
            if (player.invincibleTimer > 0) {
                player.invincibleTimer--;
            }

            // Horizontal movement
            if (keys.left) player.vx = -PLAYER_SPEED;
            else if (keys.right) player.vx = PLAYER_SPEED;
            else player.vx = 0;

            // Apply gravity
            player.vy += GRAVITY;
            player.onGround = false;

            // Proposed new position
            let nextX = player.x + player.vx;
            let nextY = player.y + player.vy;

            // Store original position for collision resolution
            const originalX = player.x;
            const originalY = player.y;

            // --- Horizontal Collision Detection ---
            player.x = nextX; // Temporarily move player horizontally for collision check
            let playerRect = { x: player.x, y: player.y, width: player.width, height: player.height };

            // Check collision with all solid tiles
            for (let r = 0; r < LEVEL_ROWS; r++) {
                for (let c = 0; c < LEVEL_COLS; c++) {
                    const tile = currentTiles[r][c];
                    if (isSolid(tile)) {
                        const tileRect = { x: c * TILE_SIZE, y: r * TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE };
                        if (checkCollision(playerRect, tileRect)) {
                            // Collision detected horizontally
                            if (player.vx < 0) { // Moving left
                                player.x = tileRect.x + tileRect.width; // Push player to the right of the tile
                            } else if (player.vx > 0) { // Moving right
                                player.x = tileRect.x - player.width; // Push player to the left of the tile
                            }
                            player.vx = 0; // Stop horizontal movement
                            playerRect.x = player.x; // Update playerRect for vertical check
                        }
                    }
                }
            }

            // --- Vertical Collision Detection ---
            player.y = nextY; // Temporarily move player vertically for collision check
            playerRect = { x: player.x, y: player.y, width: player.width, height: player.height }; // Recreate rect with new x and proposed y

            for (let r = 0; r < LEVEL_ROWS; r++) {
                for (let c = 0; c < LEVEL_COLS; c++) {
                    const tile = currentTiles[r][c];
                    if (isSolid(tile)) {
                        const tileRect = { x: c * TILE_SIZE, y: r * TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE };
                        if (checkCollision(playerRect, tileRect)) {
                            // Collision detected vertically
                            if (player.vy < 0) { // Moving up
                                player.y = tileRect.y + tileRect.height; // Push player to the bottom of the tile
                            } else if (player.vy > 0) { // Falling down
                                player.y = tileRect.y - player.height; // Push player to the top of the tile
                                player.onGround = true; // Player landed
                            }
                            player.vy = 0; // Stop vertical movement
                            playerRect.y = player.y; // Update playerRect
                        }
                    }
                }
            }

            // Prevent falling through bottom of canvas (failsafe)
            if (player.y + player.height > CANVAS_HEIGHT) {
                player.y = CANVAS_HEIGHT - player.height;
                player.vy = 0;
                player.onGround = true;
                handlePlayerFall();
            }
            // Prevent going off top
            if (player.y < 0) {
                player.y = 0;
                player.vy = 0;
            }
            // Prevent going off sides
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > CANVAS_WIDTH) player.x = CANVAS_WIDTH - player.width;


            // Check for goal collision (using player's final position)
            const playerCenterTileX = Math.floor((player.x + player.width / 2) / TILE_SIZE);
            const playerCenterTileY = Math.floor((player.y + player.height / 2) / TILE_SIZE);

            if (playerCenterTileY >= 0 && playerCenterTileY < LEVEL_ROWS &&
                playerCenterTileX >= 0 && playerCenterTileX < LEVEL_COLS) {
                
                const currentTileType = currentTiles[playerCenterTileY][playerCenterTileX];

                if (currentTileType === 'E') { // Exit
                    gameState = 'LEVEL_COMPLETE';
                    soundManager.playSound('level_complete');
                } else if (currentTileType === 'O' && player.invincibleTimer <= 0) { // Obstacle
                    handlePlayerHit();
                }
            }

            // Check for collectible collision
            collectibles.forEach(collectible => {
                if (!collectible.collected && checkCollision(playerRect, collectible)) {
                    collectible.collected = true;
                    player.score += 10;
                    soundManager.playSound('collect');
                }
            });
        }

        // Simple AABB collision detection
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function handlePlayerFall() {
            if (player.invincibleTimer <= 0) {
                player.lives--;
                soundManager.playSound('hit');
                if (player.lives <= 0) {
                    gameState = 'GAME_OVER';
                } else {
                    loadLevel(currentLevelIndex); // Respawn at start of level
                    player.invincibleTimer = 120; // 2 seconds of invincibility (60 frames/sec)
                }
            }
        }

        function handlePlayerHit() {
            if (player.invincibleTimer <= 0) {
                player.lives--;
                soundManager.playSound('hit');
                if (player.lives <= 0) {
                    gameState = 'GAME_OVER';
                } else {
                    player.invincibleTimer = 120; // 2 seconds of invincibility
                }
            }
        }

        function drawUI() {
            ctx.fillStyle = "#FFFFFF"; // White text for UI
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            ctx.fillText(`Lives: ${player.lives}`, 10, 20);
            ctx.fillText(`Score: ${player.score}`, 10, 40);
            ctx.fillText(`Level: ${currentLevelIndex + 1} - ${currentLevelData.name}`, 10, 60);
        }

        function showMessageOverlay(title, text, prompt) {
            messageTitle.textContent = title;
            messageText.innerHTML = text.replace(/\n/g, '<br>'); // Support newlines in text
            messagePrompt.textContent = prompt;
            messageOverlay.style.display = 'flex';
        }

        function hideMessageOverlay() {
            messageOverlay.style.display = 'none';
        }

        // Game Loop
        let lastTime = 0;
        function gameLoop(currentTime) {
            const deltaTime = currentTime - lastTime; // Not strictly needed for fixed framerate, but good practice
            lastTime = currentTime;

            if (gameState === 'PLAYING') {
                updatePlayer();
            }

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT); // Clear canvas
            drawLevel(ctx); // Draw level elements
            drawPlayer(ctx); // Draw player
            drawUI(); // Draw UI

            // Handle message overlays
            if (gameState === 'MENU') {
                showMessageOverlay(
                    "Merlin's Windows Journey",
                    "Help Merlin navigate through the ages of Windows! \nCollect items and reach the exit to progress.",
                    "Press any key to start"
                );
            } else if (gameState === 'LEVEL_COMPLETE') {
                showMessageOverlay(
                    `Level ${currentLevelIndex + 1} Complete!`,
                    currentLevelData.goalText + `\nScore: ${player.score}`,
                    "Press any key for next level"
                );
                soundManager.stopMusic();
            } else if (gameState === 'GAME_OVER') {
                showMessageOverlay(
                    "GAME OVER",
                    `Merlin failed his journey!\nFinal Score: ${player.score}`,
                    "Press any key to restart"
                );
                soundManager.stopMusic();
            } else if (gameState === 'GAME_WON') {
                showMessageOverlay(
                    "CONGRATULATIONS!",
                    `Merlin has mastered the Windows Ages!\nFinal Score: ${player.score}`,
                    "Press any key to play again"
                );
                soundManager.stopMusic();
            } else {
                hideMessageOverlay(); // Hide overlay during PLAYING state
            }

            requestAnimationFrame(gameLoop);
        }

        // Event Listeners
        document.addEventListener('keydown', (e) => {
            // Prevent repeated key presses from triggering multiple actions
            if (e.repeat) return;

            // Handle game controls when playing
            if (gameState === 'PLAYING') {
                if (e.key === 'ArrowLeft') keys.left = true;
                if (e.key === 'ArrowRight') keys.right = true;
                if (e.key === 'ArrowUp') {
                    if (player.onGround) {
                        player.vy = JUMP_FORCE;
                        player.onGround = false;
                        soundManager.playSound('jump');
                    }
                }
            }

            // Handle state transitions for message screens (any key press)
            if (gameState === 'MENU' || gameState === 'LEVEL_COMPLETE' || gameState === 'GAME_OVER' || gameState === 'GAME_WON') {
                soundManager.userInteracted = true; // User has interacted, allow music to play

                // Advance game state based on current state
                if (gameState === 'MENU') {
                    gameState = 'PLAYING';
                    soundManager.playMusic();
                } else if (gameState === 'LEVEL_COMPLETE') {
                    currentLevelIndex++;
                    loadLevel(currentLevelIndex);
                } else if (gameState === 'GAME_OVER' || gameState === 'GAME_WON') {
                    player.lives = 3;
                    player.score = 0;
                    currentLevelIndex = 0;
                    loadLevel(currentLevelIndex);
                    gameState = 'MENU'; // Go back to menu
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') keys.left = false;
            if (e.key === 'ArrowRight') keys.right = false;
        });

        // Touch controls (basic implementation for mobile responsiveness)
        let touchStartX = 0;
        let touchStartY = 0;
        let touchThreshold = 30; // Minimum distance for a swipe

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            soundManager.userInteracted = true; // User has interacted, allow music to play
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;

            // Handle interaction for menu/game state transitions on touch
            if (gameState === 'MENU' || gameState === 'LEVEL_COMPLETE' || gameState === 'GAME_OVER' || gameState === 'GAME_WON') {
                if (gameState === 'MENU') {
                    gameState = 'PLAYING';
                    soundManager.playMusic();
                } else if (gameState === 'LEVEL_COMPLETE') {
                    currentLevelIndex++;
                    loadLevel(currentLevelIndex);
                } else if (gameState === 'GAME_OVER' || gameState === 'GAME_WON') {
                    player.lives = 3;
                    player.score = 0;
                    currentLevelIndex = 0;
                    loadLevel(currentLevelIndex);
                    gameState = 'MENU'; // Go back to menu
                }
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevent scrolling
            if (gameState !== 'PLAYING') return;

            const touchCurrentX = e.touches[0].clientX;
            const touchCurrentY = e.touches[0].clientY;

            const diffX = touchCurrentX - touchStartX;
            const diffY = touchCurrentY - touchStartY;

            // Determine if it's a horizontal or vertical swipe
            if (Math.abs(diffX) > Math.abs(diffY)) { // Horizontal swipe
                if (diffX > touchThreshold) { // Swipe right
                    keys.right = true;
                    keys.left = false;
                } else if (diffX < -touchThreshold) { // Swipe left
                    keys.left = true;
                    keys.right = false;
                } else { // No significant horizontal movement
                    keys.left = false;
                    keys.right = false;
                }
            } else { // Vertical swipe (for jump)
                if (diffY < -touchThreshold && player.onGround) { // Swipe up
                    player.vy = JUMP_FORCE;
                    player.onGround = false;
                    soundManager.playSound('jump');
                }
            }
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault(); // Prevent scrolling
            keys.left = false;
            keys.right = false;
        });


        // Start the game loop on window load
        window.onload = function () {
            loadLevel(currentLevelIndex); // Load the first level
            requestAnimationFrame(gameLoop); // Start the animation loop
        };
    </script>
</body>
</html>
