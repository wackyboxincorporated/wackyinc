<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wChat 2</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Dark mode scrollbar styles */
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #333;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #666;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">

    <!-- Header section -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-md rounded-b-xl flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-white">wChat 2</h1>
        <div class="flex items-center space-x-4">
            <!-- User ID display for collaborative purposes -->
            <span id="userIdDisplay" class="text-sm text-white font-medium bg-blue-500 py-1 px-3 rounded-full shadow-inner">
                Your ID: Loading...
            </span>
            <!-- Nickname input -->
            <input
                type="text"
                id="nicknameInput"
                placeholder="Set your nickname"
                class="p-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-200 focus:outline-none focus:ring-2 focus:ring-white transition-all duration-300 w-32 md:w-48"
                maxlength="20"
            />
        </div>
    </header>

    <!-- Channel Management Section -->
    <section class="bg-white dark:bg-gray-800 p-4 shadow-md flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0 md:space-x-4 rounded-b-xl">
        <div class="flex items-center space-x-2 w-full md:w-auto">
            <label for="channelInput" class="text-gray-700 dark:text-gray-300 font-semibold text-sm">Channel:</label>
            <input
                type="text"
                id="channelInput"
                placeholder="Enter channel name (password)"
                class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-all duration-300"
                value="general-chat"
            />
        </div>
        <button
            id="joinChannelButton"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 w-full md:w-auto"
        >
            Join/Create Channel
        </button>
        <span id="currentChannelDisplay" class="text-blue-700 dark:text-blue-300 font-semibold text-sm w-full text-center md:text-right">
            Current: #general-chat
        </span>
    </section>

    <!-- Main Content Area: Sidebar + Chat Window -->
    <main class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar toggle button moved here to stay visible -->
        <button id="sidebarToggle" class="absolute top-4 left-4 p-1 rounded-full bg-blue-500 text-white shadow-md z-10 transition-transform duration-300 hover:scale-110">
            <!-- Chevron right icon for collapse, left for expand -->
            <svg id="toggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
        </button>

        <!-- Collapsible Sidebar -->
        <aside id="sidebar" class="w-0 bg-gray-200 dark:bg-gray-800 transition-all duration-300 ease-in-out overflow-hidden flex-shrink-0">
            <div id="channelListContent" class="p-4 pt-10 h-full overflow-y-auto">
                <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-100">Public Channels</h3>
                <ul id="publicChannelList" class="space-y-1">
                    <!-- Channel list items will be injected here by JavaScript -->
                </ul>
            </div>
        </aside>

        <!-- Chat Content Area -->
        <div id="chatContentArea" class="flex-1 flex flex-col overflow-hidden">
            <div id="messagesListContainer" class="flex-1 relative overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <!-- These will be dynamically shown/hidden within this container -->
                <div id="noMessagesPlaceholder" class="absolute inset-0 flex items-center justify-center hidden">
                    <p class="text-gray-600 dark:text-gray-400 text-lg">No messages yet. Start the conversation!</p>
                </div>
                <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-lg font-semibold animate-pulse">Loading chat...</div>
                </div>
                <!-- Actual messages will be appended here -->
            </div>
        </div>
    </main>

    <!-- Message input form -->
    <form id="messageForm" class="p-4 bg-white dark:bg-gray-800 shadow-md rounded-t-xl flex items-center space-x-3">
        <input
            type="text"
            id="newMessageInput"
            placeholder="Type your message here..."
            class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-all duration-300"
        />
        <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
            Send
        </button>
    </form>

    <!-- Confirmation Modal (hidden by default) -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <p class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Delete Message?</p>
            <p class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to delete your message?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteYes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                    Yes, Delete
                </button>
                <button id="confirmDeleteNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                    No, Keep
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyBZkcLg8FgW7jKe70HqP8CIkhzkk8hx_wQ",
            authDomain: "chat-8ed3f.firebaseapp.com",
            projectId: "chat-8ed3f",
            storageBucket: "chat-8ed3f.firebasestorage.app",
            messagingSenderId: "85452728479",
            appId: "1:85452728479:web:8e1cfa353c6d7814865aaa",
            measurementId: "G-BNR85XC62S"
        };

        // Use the projectId from your config for the Firestore collection path
        const appId = firebaseConfig.projectId;

        let db;
        let auth;
        let currentUserId = null;
        let currentUserName = localStorage.getItem('wChatUserName') || ''; // Load nickname from local storage
        let currentChannelId = localStorage.getItem('wChatCurrentChannel') || 'general-chat'; // Load channel from local storage or default
        let messageListenerInitialized = false; // Flag to ensure message listener is set up only once
        let messageIdToDelete = null; // Stores the ID of the message to be deleted via modal
        let unsubscribeMessages = null; // Stores the unsubscribe function for the Firestore listener

        // DOM element references
        const userIdDisplay = document.getElementById('userIdDisplay');
        const nicknameInput = document.getElementById('nicknameInput');
        // Renamed from messagesContainer to messagesListContainer for clarity of its content
        const messagesListContainer = document.getElementById('messagesListContainer');
        const newMessageInput = document.getElementById('newMessageInput');
        const messageForm = document.getElementById('messageForm');
        const noMessagesPlaceholder = document.getElementById('noMessagesPlaceholder');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteYes = document.getElementById('confirmDeleteYes');
        const confirmDeleteNo = document.getElementById('confirmDeleteNo');
        const channelInput = document.getElementById('channelInput');
        const joinChannelButton = document.getElementById('joinChannelButton');
        const currentChannelDisplay = document.getElementById('currentChannelDisplay');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        const publicChannelList = document.getElementById('publicChannelList');

        // Predefined public channels
        const publicChannels = [
            'info-and-rules', 'general', 'general2', 'chat', 'public',
            'math', 'science', 'algebra', 'chemistry', 'studies',
            'history', 'trig', 'ffa', 'geometry', 'geography',
            'paisley', 'rants'
        ];

        // Set initial UI values
        nicknameInput.value = currentUserName;
        channelInput.value = currentChannelId;
        currentChannelDisplay.textContent = `Current: #${currentChannelId}`;

        /**
         * Scrolls the messages list container to the bottom.
         */
        function scrollToBottom() {
            messagesListContainer.scrollTop = messagesListContainer.scrollHeight;
        }

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in (either existing anonymous user or newly signed-in)
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `Your ID: ${currentUserId}`;
                        console.log("User signed in:", user.uid);
                    } else {
                        // No user is signed in, attempt to sign in anonymously
                        try {
                            console.log("Attempting anonymous sign-in...");
                            await signInAnonymously(auth);
                            // The onAuthStateChanged listener will be triggered again if sign-in succeeds
                            // and the 'if (user)' block above will handle setting currentUserId.
                        } catch (error) {
                            console.error("Error during anonymous sign-in:", error);
                            // If anonymous sign-in fails, ensure ID is null
                            currentUserId = null;
                            userIdDisplay.textContent = `Your ID: Not authenticated`;
                            console.warn("Authentication failed. User will be able to read messages but not send.");
                        }
                    }

                    // Once authentication state is resolved (user is null or has a uid)
                    // and message listener hasn't been initialized yet, proceed to hide loading and setup listener.
                    if (!messageListenerInitialized) {
                        loadingIndicator.classList.add('hidden'); // Hide loading indicator
                        setupMessageListener(); // Call setupMessageListener with currentChannelId
                        messageListenerInitialized = true; // Set flag to prevent re-initialization
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase App:", error);
                loadingIndicator.textContent = "Error loading chat: Firebase App init failed. Check your Firebase config and network.";
            }
        }

        /**
         * Sets up a real-time listener for messages from Firestore based on currentChannelId.
         */
        function setupMessageListener() {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Unsubscribe from previous listener if it exists
                console.log("Unsubscribed from previous channel listener.");
            }

            if (!db || !currentChannelId) {
                console.warn("Firestore or currentChannelId not ready for message listener.");
                return;
            }

            // Show loading indicator before fetching new channel messages
            loadingIndicator.classList.remove('hidden');
            noMessagesPlaceholder.classList.add('hidden'); // Ensure placeholder is hidden
            messagesListContainer.innerHTML = ''; // Clear old messages immediately

            // Create a query to get messages for the current channel, ordered by timestamp
            const q = query(
                collection(db, `artifacts/${appId}/public/data/messages`),
                where('channelId', '==', currentChannelId), // Filter by channelId
                orderBy('timestamp')
            );

            // Set up real-time listener for messages
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden'); // Hide loading once snapshot arrives
                messagesListContainer.innerHTML = ''; // Clear again to ensure no duplicates if initial render was slow
                const messages = [];

                if (snapshot.empty) {
                    noMessagesPlaceholder.classList.remove('hidden');
                } else {
                    noMessagesPlaceholder.classList.add('hidden');
                }

                snapshot.forEach((doc) => {
                    messages.push({ ...doc.data(), id: doc.id });
                });

                renderMessages(messages);
                scrollToBottom(); // Scroll to the bottom after rendering new messages
            }, (error) => {
                console.error("Error fetching messages:", error);
                loadingIndicator.classList.add('hidden'); // Hide loading on error
                // Optionally display an error message to the user within the messagesListContainer
                messagesListContainer.innerHTML = `<div class="text-center text-red-500 dark:text-red-400">Error loading messages: ${error.message}</div>`;
            });
            console.log(`Listening for messages on channel: #${currentChannelId}`);
        }

        /**
         * Renders the given messages into the DOM.
         * @param {Array<Object>} messages - Array of message objects.
         */
        function renderMessages(messages) {
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${msg.userId === currentUserId ? 'justify-end' : 'justify-start'}`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-lg relative break-words
                    ${msg.userId === currentUserId
                        ? 'bg-blue-500 text-white rounded-br-none'
                        : 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-bl-none'
                    }`;

                const userNameP = document.createElement('p');
                userNameP.className = `text-xs font-semibold mb-1 ${msg.userId === currentUserId ? 'text-blue-200' : 'text-gray-500 dark:text-gray-400'}`;
                userNameP.textContent = msg.userName || 'Anonymous';

                const messageTextP = document.createElement('p');
                messageTextP.className = 'text-base';
                messageTextP.textContent = msg.text;

                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'text-xs text-opacity-75 block text-right mt-1';
                // Convert Firestore Timestamp to Date object and format
                if (msg.timestamp && typeof msg.timestamp.toDate === 'function') {
                    timestampSpan.textContent = msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (msg.timestamp) {
                     // Fallback for cases where timestamp might not be a Firestore Timestamp object
                    timestampSpan.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }


                messageBubble.appendChild(userNameP);
                messageBubble.appendChild(messageTextP);
                messageBubble.appendChild(timestampSpan);
                messageDiv.appendChild(messageBubble);

                // Add delete button if the message belongs to the current user
                if (msg.userId === currentUserId) {
                    const deleteButton = document.createElement('button');
                    // SVG for a trash icon
                    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1  0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zm1 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                                              </svg>`;
                    deleteButton.className = 'absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full shadow-md transition-transform duration-200 transform hover:scale-110';
                    deleteButton.title = 'Delete Message';
                    deleteButton.onclick = () => {
                        messageIdToDelete = msg.id; // Store the ID of the message to delete
                        confirmationModal.classList.remove('hidden'); // Show the confirmation modal
                    };
                    messageBubble.appendChild(deleteButton);
                }

                messageDiv.appendChild(messageBubble);
                messagesListContainer.appendChild(messageDiv); // Append to messagesListContainer
            });
        }

        /**
         * Handles sending a new message.
         * @param {Event} e - The submit event.
         */
        async function sendMessage(e) {
            e.preventDefault(); // Prevent default form submission

            const messageText = newMessageInput.value.trim();
            // Check if currentUserId is null (authentication failed or not ready)
            if (messageText === '' || !currentUserId || !db || !currentChannelId) {
                if (!currentUserId) {
                    console.error("Cannot send message: User is not authenticated. Please ensure Firebase Anonymous Authentication is enabled.");
                } else if (!currentChannelId) {
                    console.error("Cannot send message: No channel selected.");
                }
                return;
            }

            try {
                // Add a new document to the messages collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), {
                    userId: currentUserId,
                    userName: currentUserName || 'Anonymous', // Use 'Anonymous' if no name is set
                    text: messageText,
                    channelId: currentChannelId, // Add channel ID to the message
                    timestamp: serverTimestamp(), // Firestore generates server timestamp
                });
                newMessageInput.value = ''; // Clear the message input after sending
            } catch (error) {
                console.error("Error sending message:", error);
                // Optionally display an error message to the user
            }
        }

        /**
         * Deletes a message from Firestore.
         * @param {string} msgId - The ID of the message to delete.
         */
        async function performDeleteMessage(msgId) {
            if (!db || !msgId) {
                console.error("Database or message ID not valid for deletion.");
                return;
            }

            try {
                const messageDocRef = doc(db, `artifacts/${appId}/public/data/messages`, msgId);
                await deleteDoc(messageDocRef);
                console.log("Message deleted successfully:", msgId);
            } catch (error) {
                console.error("Error deleting message:", error);
                // Optionally display error to user
            }
        }

        /**
         * Handles joining or creating a channel.
         */
        function joinChannel() {
            const newChannel = channelInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, ''); // Sanitize channel name
            if (!newChannel) {
                console.warn("Channel name cannot be empty or contain only special characters.");
                // Optionally provide user feedback in UI
                return;
            }

            if (newChannel && newChannel !== currentChannelId) {
                currentChannelId = newChannel;
                localStorage.setItem('wChatCurrentChannel', currentChannelId); // Persist channel
                currentChannelDisplay.textContent = `Current: #${currentChannelId}`;
                console.log(`Attempting to join channel: #${currentChannelId}`);
                if (db) { // Ensure db is initialized before setting up listener
                    setupMessageListener(); // Re-setup listener for the new channel
                } else {
                    console.warn("Firebase DB not initialized yet, cannot join channel immediately.");
                }
            } else if (newChannel === currentChannelId) {
                console.log("Already in this channel.");
            }
        }

        /**
         * Populates the sidebar with predefined channels and sets up click listeners.
         */
        function populateChannelList() {
            publicChannelList.innerHTML = ''; // Clear existing list
            publicChannels.forEach(channel => {
                const listItem = document.createElement('li');
                const channelLink = document.createElement('a');
                channelLink.href = '#'; // Prevent full page reload
                channelLink.className = 'block p-2 rounded-lg text-gray-800 dark:text-gray-200 hover:bg-blue-300 dark:hover:bg-blue-700 transition-colors duration-200';
                channelLink.textContent = `#${channel}`;
                channelLink.onclick = (e) => {
                    e.preventDefault();
                    channelInput.value = channel;
                    joinChannel();
                    // Collapse sidebar after selection on small screens
                    if (window.innerWidth < 768) { // md breakpoint in Tailwind is 768px
                        sidebar.classList.remove('w-64'); // Ensure it collapses
                        sidebar.classList.add('w-0');
                        toggleIcon.classList.remove('rotate-180'); // Icon points right (collapsed)
                    }
                };
                listItem.appendChild(channelLink);
                publicChannelList.appendChild(listItem);
            });
        }

        /**
         * Toggles the visibility of the sidebar.
         */
        function toggleSidebar() {
            const isExpanded = sidebar.classList.contains('w-64');

            if (isExpanded) {
                // Collapse it
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-0');
                toggleIcon.classList.remove('rotate-180'); // Point right (collapsed)
            } else {
                // Expand it
                sidebar.classList.remove('w-0');
                sidebar.classList.add('w-64');
                toggleIcon.classList.add('rotate-180'); // Point left (expanded)
            }
        }

        // Event listener for nickname input change
        nicknameInput.addEventListener('input', (e) => {
            currentUserName = e.target.value;
            localStorage.setItem('wChatUserName', currentUserName); // Persist nickname
        });

        // Event listener for message form submission
        messageForm.addEventListener('submit', sendMessage);

        // Event listener for join channel button
        joinChannelButton.addEventListener('click', joinChannel);

        // Allow pressing Enter in channel input to join
        channelInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                joinChannel();
            }
        });

        // Event listener for sidebar toggle button
        sidebarToggle.addEventListener('click', toggleSidebar);

        // Event listeners for confirmation modal buttons
        confirmDeleteYes.addEventListener('click', () => {
            if (messageIdToDelete) {
                performDeleteMessage(messageIdToDelete);
                messageIdToDelete = null; // Clear the stored ID
            }
            confirmationModal.classList.add('hidden'); // Hide the modal
        });

        confirmDeleteNo.addEventListener('click', () => {
            messageIdToDelete = null; // Clear the stored ID
            confirmationModal.classList.add('hidden'); // Hide the modal
        });

        // Initialize Firebase and populate channels when the DOM is fully loaded
        window.onload = () => {
            initializeFirebase();
            populateChannelList();
            // Set initial state of sidebar based on screen size
            // By default, it's w-0 in HTML, so expand it if on medium/large screens
            if (window.innerWidth >= 768) {
                sidebar.classList.add('w-64'); // Set to expanded width
                sidebar.classList.remove('w-0'); // Remove collapsed width
                toggleIcon.classList.add('rotate-180'); // Icon points left (expanded)
            } else {
                // Keep it collapsed on small screens, icon points right
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-0');
                toggleIcon.classList.remove('rotate-180');
            }
        };
    </script>
</body>
</html>
