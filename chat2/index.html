<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wChat 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #333;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #666;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        body.light {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        body.dark {
            background-color: #111827;
            color: #f9fafb;
        }

        body.midnight {
            background-color: #000000;
            color: #f9fafb;
        }
        body.midnight header {
            background-image: linear-gradient(to right, #1a202c, #2d3748);
        }
        body.midnight .bg-white {
            background-color: #0a0a0a;
        }
        body.midnight .text-gray-900 {
            color: #f9fafb;
        }
        body.midnight .text-gray-700 {
            color: #d1d5db;
        }
        body.midnight .border-gray-300 {
            border-color: #374151;
        }
        body.midnight .placeholder-gray-200::placeholder {
            color: #6b7280;
        }
        body.midnight .bg-blue-500 {
            background-color: #1f2937;
        }
        body.midnight .bg-blue-600 {
            background-color: #2d3748;
        }
        body.midnight .bg-blue-500:hover {
            background-color: #2d3748;
        }
        body.midnight .bg-blue-600:hover {
            background-color: #1f2937;
        }
        body.midnight .text-blue-200 {
            color: #9ca3af;
        }
        body.midnight .text-gray-500 {
            color: #9ca3af;
        }
        body.midnight .bg-gray-200 {
            background-color: #1a202c;
        }
        body.midnight .hover\:bg-gray-300:hover {
            background-color: #2d3748;
        }
        body.midnight .dark\:bg-gray-700 {
            background-color: #1f2937;
        }
        body.midnight .dark\:hover\:bg-gray-600:hover {
            background-color: #2d3748;
        }
        body.midnight .dark\:text-gray-100 {
            color: #f9fafb;
        }
        body.midnight .dark\:text-gray-200 {
            color: #e5e7eb;
        }
        body.midnight .dark\:text-gray-300 {
            color: #d1d5db;
        }
        body.midnight .dark\:text-gray-400 {
            color: #9ca3af;
        }
        body.midnight .dark\:border-gray-600 {
            border-color: #374151;
        }
        body.midnight .dark\:bg-gray-800 {
            background-color: #0a0a0a;
        }

        body.autumn {
            background-color: #EAE7DC;
            color: #2A2A2A;
        }
        body.autumn header {
            background-image: linear-gradient(to right, #B83B00, #8F2D00);
        }
        body.autumn .bg-white {
            background-color: #F8F4E3;
        }
        body.autumn .text-gray-900 {
            color: #2A2A2A;
        }
        body.autumn .text-gray-700 {
            color: #5C5C5C;
        }
        body.autumn .border-gray-300 {
            border-color: #C7BCA1;
        }
        body.autumn .placeholder-gray-200::placeholder {
            color: #8D8B84;
        }
        body.autumn .bg-blue-500 {
            background-color: #D2691E;
        }
        body.autumn .bg-blue-600 {
            background-color: #C04000;
        }
        body.autumn .bg-blue-500:hover {
            background-color: #C04000;
        }
        body.autumn .bg-blue-600:hover {
            background-color: #D2691E;
        }
        body.autumn .text-blue-200 {
            color: #FAEBD7;
        }
        body.autumn .text-gray-500 {
            color: #7D7D7D;
        }
        body.autumn .bg-gray-200 {
            background-color: #D4CDBC;
        }
        body.autumn .hover\:bg-gray-300:hover {
            background-color: #C7BCA1;
        }
        body.autumn .dark\:bg-gray-800 {
            background-color: #F8F4E3;
        }
        body.autumn .dark\:text-gray-100 {
            color: #2A2A2A;
        }
        body.autumn .dark\:text-gray-300 {
            color: #5C5C5C;
        }
        body.autumn .dark\:border-gray-600 {
            border-color: #C7BCA1;
        }
        body.autumn .dark\:bg-gray-700 {
             background-color: #D4CDBC;
        }
        body.autumn .dark\:hover\:bg-gray-600:hover {
             background-color: #C7BCA1;
        }
        body.autumn .text-blue-700 {
            color: #C04000;
        }
        body.autumn .bg-green-600 {
            background-color: #8B4513;
        }
        body.autumn .bg-green-600:hover {
            background-color: #A0522D;
        }
        body.autumn .bg-red-600 {
            background-color: #A52A2A;
        }
        body.autumn .bg-red-600:hover {
            background-color: #CD5C5C;
        }


        body.terminal {
            background-color: #000000;
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
        }
        body.terminal header {
            background-image: linear-gradient(to right, #001f00, #003300);
        }
        body.terminal .bg-white {
            background-color: #000000;
        }
        body.terminal .text-gray-900 {
            color: #00FF00;
        }
        body.terminal .text-gray-700 {
            color: #00CC00;
        }
        body.terminal .border-gray-300 {
            border-color: #006600;
        }
        body.terminal .placeholder-gray-200::placeholder {
            color: #006600;
        }
        body.terminal .bg-blue-500 {
            background-color: #008000;
        }
        body.terminal .bg-blue-600 {
            background-color: #006600;
        }
        body.terminal .bg-blue-500:hover {
            background-color: #006600;
        }
        body.terminal .bg-blue-600:hover {
            background-color: #008000;
        }
        body.terminal .text-blue-200 {
            color: #00FF00;
        }
        body.terminal .text-gray-500 {
            color: #00FF00;
        }
        body.terminal .bg-gray-200 {
            background-color: #000000;
        }
        body.terminal .hover\:bg-gray-300:hover {
            background-color: #001a00;
        }
        body.terminal .dark\:bg-gray-800 {
            background-color: #000000;
        }
        body.terminal .dark\:text-gray-100 {
            color: #00FF00;
        }
        body.terminal .dark\:text-gray-300 {
            color: #00CC00;
        }
        body.terminal .dark\:border-gray-600 {
            border-color: #006600;
        }
        body.terminal .dark\:bg-gray-700 {
            background-color: #001a00;
        }
        body.terminal .dark\:hover\:bg-gray-600:hover {
            background-color: #003300;
        }
        body.terminal .text-blue-700 {
            color: #00FF00;
        }
        body.terminal .bg-green-600 {
            background-color: #00AA00;
        }
        body.terminal .bg-green-600:hover {
            background-color: #008800;
        }
        body.terminal .bg-red-600 {
            background-color: #880000;
        }
        body.terminal .bg-red-600:hover {
            background-color: #BB0000;
        }

        body.mario {
            background-color: #6B85F1;
            color: #2D2D2D;
            font-family: 'Press Start 2P', cursive;
        }
        body.mario header {
            background-image: linear-gradient(to right, #B83B00, #E44D26);
        }
        body.mario .bg-white {
            background-color: #F7E4B3;
        }
        body.mario .text-gray-900 {
            color: #2D2D2D;
        }
        body.mario .text-gray-700 {
            color: #5D5D5D;
        }
        body.mario .border-gray-300 {
            border-color: #A06634;
        }
        body.mario .placeholder-gray-200::placeholder {
            color: #888888;
        }
        body.mario .bg-blue-500 {
            background-color: #8B4513;
        }
        body.mario .bg-blue-600 {
            background-color: #6B2E0A;
        }
        body.mario .bg-blue-500:hover {
            background-color: #6B2E0A;
        }
        body.mario .bg-blue-600:hover {
            background-color: #8B4513;
        }
        body.mario .text-blue-200 {
            color: #FFFFFF;
        }
        body.mario .text-gray-500 {
            color: #5D5D5D;
        }
        body.mario .bg-gray-200 {
            background-color: #92CD40;
        }
        body.mario .hover\:bg-gray-300:hover {
            background-color: #79B335;
        }
        body.mario .dark\:bg-gray-800 {
            background-color: #F7E4B3;
        }
        body.mario .dark\:text-gray-100 {
            color: #2D2D2D;
        }
        body.mario .dark\:text-gray-300 {
            color: #5D5D5D;
        }
        body.mario .dark\:border-gray-600 {
            border-color: #A06634;
        }
        body.mario .dark\:bg-gray-700 {
            background-color: #92CD40;
        }
        body.mario .dark\:hover\:bg-gray-600:hover {
            background-color: #79B335;
        }
        body.mario .text-blue-700 {
            color: #B83B00;
        }
        body.mario .bg-green-600 {
            background-color: #008000;
        }
        body.mario .bg-green-600:hover {
            background-color: #006400;
        }
        body.mario .bg-red-600 {
            background-color: #CC0000;
        }
        body.mario .bg-red-600:hover {
            background-color: #FF0000;
        }

        body.windows95 {
            background-color: #008080;
            color: #000000;
            font-family: 'MS Sans Serif', 'Arial', sans-serif;
        }
        body.windows95 header {
            background-image: linear-gradient(to right, #C0C0C0, #808080);
            color: #000000;
            border-bottom: 2px solid #000000;
            border-right: 2px solid #FFFFFF;
            border-left: 2px solid #FFFFFF;
            border-top: 2px solid #FFFFFF;
        }
        body.windows95 h1 {
            color: #000000;
            text-shadow: 1px 1px 0px #FFFFFF;
        }
        body.windows95 .bg-white {
            background-color: #C0C0C0;
            border: 2px solid #000000;
            border-right-color: #FFFFFF;
            border-bottom-color: #FFFFFF;
        }
        body.windows95 .text-gray-900 {
            color: #000000;
        }
        body.windows95 .text-gray-700 {
            color: #000000;
        }
        body.windows95 .border-gray-300 {
            border-color: #808080;
            border-right-color: #FFFFFF;
            border-bottom-color: #FFFFFF;
        }
        body.windows95 .placeholder-gray-200::placeholder {
            color: #404040;
        }
        body.windows95 .bg-blue-500 {
            background-color: #000080;
            color: #FFFFFF;
            border: none;
        }
        body.windows95 .bg-blue-600 {
            background-color: #000080;
            color: #FFFFFF;
            border: none;
        }
        body.windows95 .bg-blue-500:hover {
            background-color: #0000B0;
        }
        body.windows95 .bg-blue-600:hover {
            background-color: #0000B0;
        }
        body.windows95 .text-blue-200 {
            color: #FFFFFF;
        }
        body.windows95 .text-gray-500 {
            color: #404040;
        }
        body.windows95 .bg-gray-200 {
            background-color: #C0C0C0;
            border: 2px solid #000000;
            border-right-color: #FFFFFF;
            border-bottom-color: #FFFFFF;
        }
        body.windows95 .hover\:bg-gray-300:hover {
            background-color: #A0A0A0;
        }
        body.windows95 .dark\:bg-gray-800 {
            background-color: #C0C0C0;
        }
        body.windows95 .dark\:text-gray-100 {
            color: #000000;
        }
        body.windows95 .dark\:text-gray-300 {
            color: #000000;
        }
        body.windows95 .dark\:border-gray-600 {
            border-color: #808080;
        }
        body.windows95 .dark\:bg-gray-700 {
            background-color: #A0A0A0;
        }
        body.windows95 .dark\:hover\:bg-gray-600:hover {
            background-color: #808080;
        }
        body.windows95 .text-blue-700 {
            color: #000080;
        }
        body.windows95 .bg-green-600 {
            background-color: #C0C0C0;
            color: #000000;
            border: 2px solid #000000;
            border-right-color: #FFFFFF;
            border-bottom-color: #FFFFFF;
        }
        body.windows95 .bg-green-600:hover {
            background-color: #A0A0A0;
        }
        body.windows95 .bg-red-600 {
            background-color: #C0C0C0;
            color: #000000;
            border: 2px solid #000000;
            border-right-color: #FFFFFF;
            border-bottom-color: #FFFFFF;
        }
        body.windows95 .bg-red-600:hover {
            background-color: #A0A0A0;
        }
        body.windows95 button {
            border-radius: 0;
            box-shadow: none;
        }
        body.windows95 button:active {
            border: 2px solid #FFFFFF;
            border-right-color: #000000;
            border-bottom-color: #000000;
            background-image: none;
            background-color: #A0A0A0;
            transform: none;
        }
        body.windows95 .rounded-lg {
            border-radius: 0;
        }
        body.windows95 .rounded-xl {
            border-radius: 0;
        }
        body.windows95 .rounded-b-xl {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        body.windows95 .rounded-t-xl {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        body.windows95 .rounded-full {
            border-radius: 0;
        }


        body.windowsxp {
            background-image: linear-gradient(to bottom right, #3A6EA5, #4A8EDC);
            color: #000000;
            font-family: 'Tahoma', sans-serif;
        }
        body.windowsxp header {
            background-image: linear-gradient(to right, #003399, #0077EE);
            color: #FFFFFF;
            border-bottom: 1px solid #111111;
        }
        body.windowsxp .bg-white {
            background-color: #EFF3F9;
            border: 1px solid #ACACAC;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        body.windowsxp .text-gray-900 {
            color: #000000;
        }
        body.windowsxp .text-gray-700 {
            color: #333333;
        }
        body.windowsxp .border-gray-300 {
            border-color: #ACACAC;
        }
        body.windowsxp .placeholder-gray-200::placeholder {
            color: #777777;
        }
        body.windowsxp .bg-blue-500 {
            background-image: linear-gradient(to top, #3A6EA5, #4A8EDC);
            color: #FFFFFF;
        }
        body.windowsxp .bg-blue-600 {
            background-image: linear-gradient(to top, #003399, #0077EE);
            color: #FFFFFF;
        }
        body.windowsxp .bg-blue-500:hover {
            background-image: linear-gradient(to top, #4A8EDC, #3A6EA5);
        }
        body.windowsxp .bg-blue-600:hover {
            background-image: linear-gradient(to top, #0077EE, #003399);
        }
        body.windowsxp .text-blue-200 {
            color: #EEFFFF;
        }
        body.windowsxp .text-gray-500 {
            color: #555555;
        }
        body.windowsxp .bg-gray-200 {
            background-color: #DDE8F3;
            border: 1px solid #ACACAC;
        }
        body.windowsxp .hover\:bg-gray-300:hover {
            background-color: #CCDCEB;
        }
        body.windowsxp .dark\:bg-gray-800 {
            background-color: #EFF3F9;
        }
        body.windowsxp .dark\:text-gray-100 {
            color: #000000;
        }
        body.windowsxp .dark\:text-gray-300 {
            color: #333333;
        }
        body.windowsxp .dark\:border-gray-600 {
            border-color: #ACACAC;
        }
        body.windowsxp .dark\:bg-gray-700 {
            background-color: #CCDCEB;
        }
        body.windowsxp .dark\:hover\:bg-gray-600:hover {
            background-color: #DDE8F3;
        }
        body.windowsxp .text-blue-700 {
            color: #003399;
        }
        body.windowsxp .bg-green-600 {
            background-image: linear-gradient(to top, #3A8E3A, #4CBF4C);
            color: #FFFFFF;
        }
        body.windowsxp .bg-green-600:hover {
            background-image: linear-gradient(to top, #4CBF4C, #3A8E3A);
        }
        body.windowsxp .bg-red-600 {
            background-image: linear-gradient(to top, #B83B00, #E44D26);
            color: #FFFFFF;
        }
        body.windowsxp .bg-red-600:hover {
            background-image: linear-gradient(to top, #E44D26, #B83B00);
        }


        body.windows7 {
            background-image: radial-gradient(circle at top left, #B9D2EF, #7EA5D9);
            color: #333333;
            font-family: 'Segoe UI', sans-serif;
        }
        body.windows7 header {
            background-image: linear-gradient(to right, #004D8C, #007ACC);
            color: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        body.windows7 .bg-white {
            background-color: #E8EDF4;
            border: 1px solid #C0C0C0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.windows7 .text-gray-900 {
            color: #333333;
        }
        body.windows7 .text-gray-700 {
            color: #555555;
        }
        body.windows7 .border-gray-300 {
            border-color: #C0C0C0;
        }
        body.windows7 .placeholder-gray-200::placeholder {
            color: #888888;
        }
        body.windows7 .bg-blue-500 {
            background-image: linear-gradient(to top, #007ACC, #00A3EF);
            color: #FFFFFF;
            border: 1px solid #005691;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }
        body.windows7 .bg-blue-600 {
            background-image: linear-gradient(to top, #005691, #007ACC);
            color: #FFFFFF;
            border: 1px solid #003F6B;
        }
        body.windows7 .bg-blue-500:hover {
            background-image: linear-gradient(to top, #00A3EF, #007ACC);
        }
        body.windows7 .bg-blue-600:hover {
            background-image: linear-gradient(to top, #007ACC, #005691);
        }
        body.windows7 .text-blue-200 {
            color: #EEF8FF;
        }
        body.windows7 .text-gray-500 {
            color: #777777;
        }
        body.windows7 .bg-gray-200 {
            background-color: #D0E0F0;
            border: 1px solid #C0C0C0;
        }
        body.windows7 .hover\:bg-gray-300:hover {
            background-color: #C0D0E0;
        }
        body.windows7 .dark\:bg-gray-800 {
            background-color: #E8EDF4;
        }
        body.windows7 .dark\:text-gray-100 {
            color: #333333;
        }
        body.windows7 .dark\:text-gray-300 {
            color: #555555;
        }
        body.windows7 .dark\:border-gray-600 {
            border-color: #C0C0C0;
        }
        body.windows7 .dark\:bg-gray-700 {
            background-color: #C0D0E0;
        }
        body.windows7 .dark\:hover\:bg-gray-600:hover {
            background-color: #D0E0F0;
        }
        body.windows7 .text-blue-700 {
            color: #007ACC;
        }
        body.windows7 .bg-green-600 {
            background-image: linear-gradient(to top, #62B82F, #7CD34B);
            border: 1px solid #4F8E26;
            color: #FFFFFF;
        }
        body.windows7 .bg-green-600:hover {
            background-image: linear-gradient(to top, #7CD34B, #62B82F);
        }
        body.windows7 .bg-red-600 {
            background-image: linear-gradient(to top, #D93B3B, #E44D4D);
            border: 1px solid #A52D2D;
            color: #FFFFFF;
        }
        body.windows7 .bg-red-600:hover {
            background-image: linear-gradient(to top, #E44D4D, #D93B3B);
        }
        body.windows7 button {
            border-radius: 3px;
        }
        body.windows7 .rounded-lg {
            border-radius: 3px;
        }
        body.windows7 .rounded-xl {
            border-radius: 4px;
        }
        body.windows7 .rounded-b-xl {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        body.windows7 .rounded-t-xl {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }


        body.windows10 {
            background-color: #262626;
            color: #FFFFFF;
            font-family: 'Segoe UI', sans-serif;
        }
        body.windows10 header {
            background-color: #2F2F2F;
            background-image: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border-bottom: 1px solid #444444;
        }
        body.windows10 .bg-white {
            background-color: #1A1A1A;
            border: 1px solid #333333;
            box-shadow: none;
        }
        body.windows10 .text-gray-900 {
            color: #FFFFFF;
        }
        body.windows10 .text-gray-700 {
            color: #CCCCCC;
        }
        body.windows10 .border-gray-300 {
            border-color: #444444;
        }
        body.windows10 .placeholder-gray-200::placeholder {
            color: #AAAAAA;
        }
        body.windows10 .bg-blue-500 {
            background-color: #0078D7;
            color: #FFFFFF;
            border: none;
            box-shadow: none;
        }
        body.windows10 .bg-blue-600 {
            background-color: #005BA1;
            color: #FFFFFF;
            border: none;
        }
        body.windows10 .bg-blue-500:hover {
            background-color: #108DE0;
        }
        body.windows10 .bg-blue-600:hover {
            background-color: #0078D7;
        }
        body.windows10 .text-blue-200 {
            color: #FFFFFF;
        }
        body.windows10 .text-gray-500 {
            color: #999999;
        }
        body.windows10 .bg-gray-200 {
            background-color: #202020;
            border: 1px solid #333333;
        }
        body.windows10 .hover\:bg-gray-300:hover {
            background-color: #333333;
        }
        body.windows10 .dark\:bg-gray-800 {
            background-color: #1A1A1A;
        }
        body.windows10 .dark\:text-gray-100 {
            color: #FFFFFF;
        }
        body.windows10 .dark\:text-gray-300 {
            color: #CCCCCC;
        }
        body.windows10 .dark\:border-gray-600 {
            border-color: #444444;
        }
        body.windows10 .dark\:bg-gray-700 {
            background-color: #202020;
        }
        body.windows10 .dark\:hover\:bg-gray-600:hover {
            background-color: #333333;
        }
        body.windows10 .text-blue-700 {
            color: #0078D7;
        }
        body.windows10 .bg-green-600 {
            background-color: #107C10;
            color: #FFFFFF;
            border: none;
        }
        body.windows10 .bg-green-600:hover {
            background-color: #14A014;
        }
        body.windows10 .bg-red-600 {
            background-color: #E81123;
            color: #FFFFFF;
            border: none;
        }
        body.windows10 .bg-red-600:hover {
            background-color: #F04F5C;
        }
        body.windows10 button {
            border-radius: 3px;
        }
        body.windows10 .rounded-lg {
            border-radius: 3px;
        }
        body.windows10 .rounded-xl {
            border-radius: 4px;
        }
        body.windows10 .rounded-b-xl {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        body.windows10 .rounded-t-xl {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        body.wackybox {
            background-color: #FF00FF;
            color: #00FFFF;
            font-family: 'Comic Sans MS', cursive;
        }
        body.wackybox header {
            background-image: linear-gradient(to right, #FFFF00, #FF0000);
            color: #0000FF;
            text-shadow: 2px 2px 0px #00FF00;
            border: 5px dashed #800080;
        }
        body.wackybox h1 {
            color: #0000FF;
        }
        body.wackybox .bg-white {
            background-color: #00FF00;
            color: #FF00FF;
            border: 3px double #FFD700;
            box-shadow: 5px 5px 0px 0px #FF4500;
        }
        body.wackybox .text-gray-900 {
            color: #FF00FF;
        }
        body.wackybox .text-gray-700 {
            color: #00FFFF;
        }
        body.wackybox .border-gray-300 {
            border-color: #FF00FF;
        }
        body.wackybox .placeholder-gray-200::placeholder {
            color: #800080;
        }
        body.wackybox .bg-blue-500 {
            background-color: #FF69B4;
            color: #000080;
            border: 2px solid #00FFFF;
        }
        body.wackybox .bg-blue-600 {
            background-color: #FF1493;
            color: #FFFFFF;
            border: 2px outset #000080;
        }
        body.wackybox .bg-blue-500:hover {
            background-color: #00FFFF;
            color: #FF00FF;
        }
        body.wackybox .bg-blue-600:hover {
            background-color: #FF00FF;
            color: #FFFF00;
        }
        body.wackybox .text-blue-200 {
            color: #FFA500;
        }
        body.wackybox .text-gray-500 {
            color: #8A2BE2;
        }
        body.wackybox .bg-gray-200 {
            background-color: #008000;
            border: 4px groove #FFD700;
        }
        body.wackybox .hover\:bg-gray-300:hover {
            background-color: #FF00FF;
            color: #00FF00;
        }
        body.wackybox .dark\:bg-gray-800 {
            background-color: #00FF00;
        }
        body.wackybox .dark\:text-gray-100 {
            color: #FF00FF;
        }
        body.wackybox .dark\:text-gray-300 {
            color: #00FFFF;
        }
        body.wackybox .dark\:border-gray-600 {
            border-color: #FF00FF;
        }
        body.wackybox .dark\:bg-gray-700 {
            background-color: #008000;
        }
        body.wackybox .dark\:hover\:bg-gray-600:hover {
            background-color: #FF00FF;
        }
        body.wackybox .text-blue-700 {
            color: #FF8C00;
        }
        body.wackybox .bg-green-600 {
            background-color: #FF4500;
            color: #0000FF;
            border: 3px ridge #ADFF2F;
        }
        body.wackybox .bg-green-600:hover {
            background-color: #ADFF2F;
            color: #FF4500;
        }
        body.wackybox .bg-red-600 {
            background-color: #000080;
            color: #FFD700;
            border: 3px inset #FF00FF;
        }
        body.wackybox .bg-red-600:hover {
            background-color: #FF00FF;
            color: #000080;
        }
        body.wackybox button {
            border-radius: 15px;
            transition: all 0.1s ease-in-out;
            box-shadow: 0px 0px 10px 5px rgba(255,0,255,0.7);
        }
        body.wackybox button:active {
            transform: scale(0.95) rotate(5deg);
            box-shadow: none;
        }
        body.wackybox .rounded-lg,
        body.wackybox .rounded-xl,
        body.wackybox .rounded-b-xl,
        body.wackybox .rounded-t-xl,
        body.wackybox .rounded-full {
            border-radius: 15px;
        }

        .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .text-gray-900 {
            color: #f9fafb;
        }
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        .dark .border-gray-300 {
            border-color: #4b5563;
        }
        .dark .placeholder-gray-200::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 text-gray-900 font-sans">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-md rounded-b-xl flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-white">wChat 2</h1>
        <div class="flex items-center space-x-4">
            <button id="userSettingsButton" class="text-white text-2xl p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors duration-200">
                &#x2699;
            </button>
            <span id="userIdDisplay" class="text-sm text-white font-medium bg-blue-500 py-1 px-3 rounded-full shadow-inner">
                Your ID: Loading...
            </span>
            <input
                type="text"
                id="nicknameInput"
                placeholder="Set your nickname"
                class="p-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-200 focus:outline-none focus:ring-2 focus:ring-white transition-all duration-300 w-32 md:w-48"
                maxlength="20"
            />
        </div>
    </header>

    <section class="bg-white dark:bg-gray-800 p-4 shadow-md rounded-b-xl relative">
        <button id="channelToggleButton" class="absolute top-4 right-4 p-1 rounded-full bg-blue-500 text-white shadow-md z-10 transition-transform duration-300 hover:scale-110">
            <svg id="channelToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="channelControlArea" class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            <div class="flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0 md:space-x-4 pt-2">
                <div class="flex items-center space-x-2 w-full md:w-auto">
                    <label for="channelInput" class="text-gray-700 dark:text-gray-300 font-semibold text-sm">Channel:</label>
                    <input
                        type="text"
                        id="channelInput"
                        placeholder="Enter channel name (password)"
                        class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-all duration-300"
                        value="general-chat"
                    />
                </div>
                <button
                    id="joinChannelButton"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 w-full md:w-auto"
                >
                    Join/Create Channel
                </button>
                <span id="currentChannelDisplay" class="text-blue-700 dark:text-blue-300 font-semibold text-sm w-full text-center md:text-right">
                    Current: #general-chat
                </span>
            </div>
        </div>
    </section>

    <main class="flex flex-1 overflow-hidden relative">
        <button id="sidebarToggle" class="absolute top-4 left-4 p-1 rounded-full bg-blue-500 text-white shadow-md z-10 transition-transform duration-300 hover:scale-110">
            <svg id="toggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
        </button>

        <aside id="sidebar" class="w-0 bg-gray-200 dark:bg-gray-800 transition-all duration-300 ease-in-out overflow-hidden flex-shrink-0">
            <div id="channelListContent" class="p-4 pt-10 h-full overflow-y-auto">
                <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-100">Public Channels</h3>
                <ul id="publicChannelList" class="space-y-1">
                </ul>
            </div>
        </aside>

        <div id="chatContentArea" class="flex-1 flex flex-col overflow-hidden">
            <div id="messagesListContainer" class="flex-1 relative overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div id="noMessagesPlaceholder" class="absolute inset-0 flex items-center justify-center hidden">
                    <p class="text-gray-600 dark:text-gray-400 text-lg">No messages yet. Start the conversation!</p>
                </div>
                <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-lg font-semibold animate-pulse">Loading chat...</div>
                </div>
            </div>
        </div>
    </main>

    <form id="messageForm" class="p-4 bg-white dark:bg-gray-800 shadow-md rounded-t-xl flex flex-col space-y-3">
        <div id="imagePreviewContainer" class="hidden flex items-center justify-between p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
            <img id="imagePreview" src="" alt="Image Preview" class="max-w-xs max-h-24 rounded-md object-contain mr-4">
            <span id="imageFileName" class="text-sm text-gray-700 dark:text-gray-300 truncate flex-1"></span>
            <button type="button" id="cancelImageButton" class="ml-4 p-1 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-red-900 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div id="uploadProgressBarContainer" class="hidden w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
            <div id="uploadProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>

        <div id="imageSizeError" class="hidden bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg relative text-sm" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="imageSizeErrorMessage">Image size exceeds 1MB limit. Please choose a smaller image.</span>
        </div>

        <div class="flex items-center space-x-3">
            <input
                type="file"
                id="imageInput"
                accept="image/*"
                class="hidden"
            />
            <button type="button" id="attachImageButton" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 shadow-sm transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </button>
            <input
                type="text"
                id="newMessageInput"
                placeholder="Type your message here..."
                class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100 transition-all duration-300"
            />
            <button
                type="submit"
                id="sendButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
                <span id="sendButtonText">Send</span>
            </button>
        </div>
    </form>

    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <p class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Delete Message?</p>
            <p class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to delete your message?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteYes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                    Yes, Delete
                </button>
                <button id="confirmDeleteNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                    No, Keep
                </button>
            </div>
        </div>
    </div>

    <div id="userSettingsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-md w-full relative">
            <button id="closeSettingsModalButton" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">User Settings</h2>

            <div class="mb-4">
                <label for="userColorInput" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Message Color:</label>
                <input type="color" id="userColorInput" class="w-full h-10 rounded-lg cursor-pointer" value="#4CAF50">
            </div>

            <div class="mb-6">
                <label for="themeSelect" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">App Theme:</label>
                <select id="themeSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="midnight">Midnight (OLED Optimized)</option>
                    <option value="autumn">Autumn</option>
                    <option value="terminal">Terminal</option>
                    <option value="mario">Super Mario Bros.</option>
                    <option value="windows95">Windows 95</option>
                    <option value="windowsxp">Windows XP</option>
                    <option value="windows7">Windows 7</option>
                    <option value="windows10">Windows 10</option>
                    <option value="wackybox">Wackybox (Ugly Mode)</option>
                    <option value="system">System</option>
                </select>
            </div>

            <button id="saveUserSettingsButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95">
                Save Settings
            </button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbIMQv9Z44Ms2zNZh2SAmELkS8AJKsYvo",
            authDomain: "chat-5c6f4.firebaseapp.com",
            projectId: "chat-5c6f4",
            storageBucket: "chat-5c6f4.firebasestorage.app",
            messagingSenderId: "450004774412",
            appId: "1:450004774412:web:160c2275021b82745b4829",
            measurementId: "G-2Y6JBMK2CP"
        };

        const appId = firebaseConfig.projectId;

        let db;
        let auth;
        let currentUserId = null;
        let currentUserName = localStorage.getItem('wChatUserName') || '';
        let currentChannelId = localStorage.getItem('wChatCurrentChannel') || 'general-chat';
        let currentColor = localStorage.getItem('wChatUserColor') || '#4CAF50';
        let currentTheme = localStorage.getItem('wChatTheme') || 'dark';
        let messageListenerInitialized = false;
        let messageIdToDelete = null;
        let messageIdToEdit = null;
        let originalMessageText = null;
        let unsubscribeMessages = null;
        let currentImageFile = null;
        let imageSizeErrorTimeout = null;

        const userIdDisplay = document.getElementById('userIdDisplay');
        const nicknameInput = document.getElementById('nicknameInput');
        const messagesListContainer = document.getElementById('messagesListContainer');
        const newMessageInput = document.getElementById('newMessageInput');
        const messageForm = document.getElementById('messageForm');
        const noMessagesPlaceholder = document.getElementById('noMessagesPlaceholder');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteYes = document.getElementById('confirmDeleteYes');
        const confirmDeleteNo = document.getElementById('confirmDeleteNo');
        const channelInput = document.getElementById('channelInput');
        const joinChannelButton = document.getElementById('joinChannelButton');
        const currentChannelDisplay = document.getElementById('currentChannelDisplay');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        const publicChannelList = document.getElementById('publicChannelList');
        const sendButton = document.getElementById('sendButton');
        const sendButtonText = document.getElementById('sendButtonText');
        const imageInput = document.getElementById('imageInput');
        const attachImageButton = document.getElementById('attachImageButton');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const imageFileName = document.getElementById('imageFileName');
        const cancelImageButton = document.getElementById('cancelImageButton');
        const uploadProgressBarContainer = document.getElementById('uploadProgressBarContainer');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const imageSizeError = document.getElementById('imageSizeError');
        const imageSizeErrorMessage = document.getElementById('imageSizeErrorMessage');

        const channelToggleButton = document.getElementById('channelToggleButton');
        const channelToggleIcon = document.getElementById('channelToggleIcon');
        const channelControlArea = document.getElementById('channelControlArea');

        const userSettingsButton = document.getElementById('userSettingsButton');
        const userSettingsModal = document.getElementById('userSettingsModal');
        const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
        const userColorInput = document.getElementById('userColorInput');
        const themeSelect = document.getElementById('themeSelect');
        const saveUserSettingsButton = document.getElementById('saveUserSettingsButton');


        const publicChannels = [
            'info-and-rules', 'general', 'general2', 'chat', 'public',
            'math', 'science', 'algebra', 'chemistry', 'studies',
            'history', 'trig', 'ffa', 'geometry', 'geography',
            'paisley', 'rants'
        ];

        function applyTheme(theme) {
            const body = document.body;
            body.classList.remove('light', 'dark', 'midnight', 'autumn', 'terminal', 'mario', 'windows95', 'windowsxp', 'windows7', 'windows10', 'wackybox');

            if (theme === 'system') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.add('dark');
                } else {
                    body.classList.add('light');
                }
            } else {
                body.classList.add(theme);
            }
        }

        applyTheme(localStorage.getItem('wChatTheme') || 'dark');

        nicknameInput.value = currentUserName;
        channelInput.value = currentChannelId;
        currentChannelDisplay.textContent = `Current: #${currentChannelId}`;


        function resetEditMode() {
            messageIdToEdit = null;
            originalMessageText = null;
            newMessageInput.value = '';
            sendButtonText.textContent = 'Send';
        }

        function clearImageSelection() {
            currentImageFile = null;
            imageInput.value = '';
            imagePreview.src = '';
            imageFileName.textContent = '';
            imagePreviewContainer.classList.add('hidden');
            uploadProgressBarContainer.classList.add('hidden');
            uploadProgressBar.style.width = '0%';
            hideImageSizeError();
        }

        function showImageSizeError(message) {
            imageSizeErrorMessage.textContent = message;
            imageSizeError.classList.remove('hidden');
            if (imageSizeErrorTimeout) {
                clearTimeout(imageSizeErrorTimeout);
            }
            imageSizeErrorTimeout = setTimeout(() => {
                hideImageSizeError();
            }, 5000);
        }

        function hideImageSizeError() {
            imageSizeError.classList.add('hidden');
            if (imageSizeErrorTimeout) {
                clearTimeout(imageSizeErrorTimeout);
                imageSizeErrorTimeout = null;
            }
        }


        function scrollToBottom() {
            messagesListContainer.scrollTop = messagesListContainer.scrollHeight;
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `Your ID: ${currentUserId}`;
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error during anonymous sign-in:", error);
                            currentUserId = null;
                            userIdDisplay.textContent = `Your ID: Not authenticated`;
                            console.warn("Authentication failed. User will be able to read messages but not send.");
                        }
                    }

                    if (!messageListenerInitialized) {
                        loadingIndicator.classList.add('hidden');
                        setupMessageListener();
                        messageListenerInitialized = true;
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase App:", error);
                loadingIndicator.textContent = "Error loading chat: Firebase App init failed. Check your Firebase config and network.";
            }
        }

        function setupMessageListener() {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            if (!db || !currentChannelId) {
                console.warn("Firestore or currentChannelId not ready for message listener.");
                return;
            }

            loadingIndicator.classList.remove('hidden');
            noMessagesPlaceholder.classList.add('hidden');
            messagesListContainer.innerHTML = '';
            resetEditMode();
            clearImageSelection();

            const q = query(
                collection(db, `artifacts/${appId}/public/data/messages`),
                where('channelId', '==', currentChannelId),
                orderBy('timestamp')
            );

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                messagesListContainer.innerHTML = '';
                const messages = [];

                if (snapshot.empty) {
                    noMessagesPlaceholder.classList.remove('hidden');
                } else {
                    noMessagesPlaceholder.classList.add('hidden');
                }

                snapshot.forEach((doc) => {
                    messages.push({ ...doc.data(), id: doc.id });
                });

                renderMessages(messages);
                scrollToBottom();
            }, (error) => {
                console.error("Error fetching messages:", error);
                loadingIndicator.classList.add('hidden');
                messagesListContainer.innerHTML = `<div class="text-center text-red-500 dark:text-red-400">Error loading messages: ${error.message}</div>`;
            });
        }

        function renderMessages(messages) {
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${msg.userId === currentUserId ? 'justify-end' : 'justify-start'}`;

                const messageBubble = document.createElement('div');
                const isImageMessage = msg.imageDataUrl && (!msg.text || msg.text.trim() === '');
                messageBubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-lg relative break-words
                    ${msg.userId === currentUserId
                        ? 'bg-blue-500 text-white rounded-br-none'
                        : 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-bl-none'
                    }
                    ${isImageMessage ? 'p-1' : ''} `;

                const userNameP = document.createElement('p');
                userNameP.className = `text-xs font-semibold mb-1`;
                userNameP.textContent = msg.userName || 'Anonymous';
                userNameP.style.color = msg.senderColor || '#000000';

                messageBubble.appendChild(userNameP);

                if (msg.imageDataUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.src = msg.imageDataUrl;
                    imgElement.alt = "Shared Image";
                    imgElement.className = "max-w-full h-auto rounded-lg mb-2 cursor-pointer";
                    imgElement.style.maxWidth = '250px';
                    imgElement.style.maxHeight = '250px';
                    imgElement.loading = "lazy";
                    imgElement.onerror = (e) => {
                        e.target.onerror = null;
                        e.target.src = "https://placehold.co/200x200/cccccc/333333?text=Image+Load+Error";
                        e.target.alt = "Image failed to load.";
                    };
                    imgElement.onclick = () => window.open(msg.imageDataUrl, '_blank');
                    messageBubble.appendChild(imgElement);
                }

                if (msg.text && msg.text.trim() !== '') {
                    const messageTextP = document.createElement('p');
                    messageTextP.className = 'text-base';
                    messageTextP.textContent = msg.text;
                    messageBubble.appendChild(messageTextP);
                }

                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'text-xs text-opacity-75 block text-right mt-1';
                if (msg.timestamp && typeof msg.timestamp.toDate === 'function') {
                    timestampSpan.textContent = msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (msg.timestamp) {
                     timestampSpan.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                messageBubble.appendChild(timestampSpan);
                messageDiv.appendChild(messageBubble);

                if (msg.userId === currentUserId) {
                    const editButton = document.createElement('button');
                    editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                              <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-6.071 6.071l-1.414 1.414 4.243 4.243 1.414-1.414-4.243-4.243z" />
                                              <path fill-rule="evenodd" d="M3 6a2 2 0 012-2h4a1 1  0 010 2H5v9h9V8a1 1 0 012 0v8a2 2 0 01-2 2H5a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                            </svg>`;
                    editButton.className = 'absolute -top-2 left-2 bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-full shadow-md transition-transform duration-200 transform hover:scale-110';
                    editButton.title = 'Edit Message';
                    editButton.onclick = () => {
                        messageIdToEdit = msg.id;
                        originalMessageText = msg.text;
                        newMessageInput.value = msg.text || '';
                        sendButtonText.textContent = 'Save Edits';
                        newMessageInput.focus();
                        clearImageSelection();
                        scrollToBottom();
                    };
                    messageBubble.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1  0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zm1 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                                              </svg>`;
                    deleteButton.className = 'absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full shadow-md transition-transform duration-200 transform hover:scale-110';
                    deleteButton.title = 'Delete Message';
                    deleteButton.onclick = () => {
                        messageIdToDelete = { id: msg.id };
                        confirmationModal.classList.remove('hidden');
                    };
                    messageBubble.appendChild(deleteButton);
                }

                messagesListContainer.appendChild(messageDiv);
            });
        }

        async function sendMessage(e) {
            e.preventDefault();

            const messageText = newMessageInput.value.trim();

            if (!currentUserId || !db || !currentChannelId) {
                if (!currentUserId) {
                    console.error("Cannot send message: User is not authenticated.");
                } else if (!currentChannelId) {
                    console.error("Cannot send message: No channel selected.");
                }
                return;
            }

            if (messageText === '' && !currentImageFile) {
                console.warn("Cannot send empty message or without an image.");
                return;
            }

            try {
                if (messageIdToEdit) {
                    const messageDocRef = doc(db, `artifacts/${appId}/public/data/messages`, messageIdToEdit);
                    await updateDoc(messageDocRef, {
                        text: messageText,
                    });
                    console.log("Message updated successfully:", messageIdToEdit);
                } else {
                    let imageDataUrl = null;

                    if (currentImageFile) {
                        uploadProgressBarContainer.classList.remove('hidden');
                        uploadProgressBar.style.width = '50%';
                        sendButton.disabled = true;

                        const reader = new FileReader();
                        imageDataUrl = await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                            reader.readAsDataURL(currentImageFile);
                        });

                        uploadProgressBar.style.width = '100%';
                        sendButton.disabled = false;
                        uploadProgressBarContainer.classList.add('hidden');
                        uploadProgressBar.style.width = '0%';
                    }

                    await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), {
                        userId: currentUserId,
                        userName: currentUserName || 'Anonymous',
                        senderColor: currentColor,
                        text: messageText,
                        channelId: currentChannelId,
                        timestamp: serverTimestamp(),
                        imageDataUrl: imageDataUrl
                    });
                }
                resetEditMode();
                clearImageSelection();
            }
            catch (error) {
                console.error("Error sending/updating message or uploading image:", error);
                uploadProgressBarContainer.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
            }
        }

        async function performDeleteMessage(msgInfo) {
            if (!db || !msgInfo || !msgInfo.id) {
                console.error("Database or message ID not valid for deletion.");
                return;
            }

            try {
                const messageDocRef = doc(db, `artifacts/${appId}/public/data/messages`, msgInfo.id);
                await deleteDoc(messageDocRef);
                console.log("Message deleted successfully from Firestore:", msgInfo.id);
            } catch (error) {
                console.error("Error deleting message:", error);
                window.alert("Failed to delete message. Please check console for details.");
            }
        }

        function joinChannel() {
            const newChannel = channelInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
            if (!newChannel) {
                console.warn("Channel name cannot be empty or contain only special characters.");
                return;
            }

            if (newChannel && newChannel !== currentChannelId) {
                currentChannelId = newChannel;
                localStorage.setItem('wChatCurrentChannel', currentChannelId);
                currentChannelDisplay.textContent = `Current: #${currentChannelId}`;
                if (db) {
                    setupMessageListener();
                } else {
                    console.warn("Firebase DB not initialized yet, cannot join channel immediately.");
                }
            } else if (newChannel === currentChannelId) {
                console.log("Already in this channel.");
            }
        }

        function populateChannelList() {
            publicChannelList.innerHTML = '';
            publicChannels.forEach(channel => {
                const listItem = document.createElement('li');
                const channelLink = document.createElement('a');
                channelLink.href = '#';
                channelLink.className = 'block p-2 rounded-lg text-gray-800 dark:text-gray-200 hover:bg-blue-300 dark:hover:bg-blue-700 transition-colors duration-200';
                channelLink.textContent = `#${channel}`;
                channelLink.onclick = (e) => {
                    e.preventDefault();
                    channelInput.value = channel;
                    joinChannel();
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('w-64');
                        sidebar.classList.add('w-0');
                        toggleIcon.classList.remove('rotate-180');
                    }
                };
                listItem.appendChild(channelLink);
                publicChannelList.appendChild(listItem);
            });
        }

        function toggleSidebar() {
            const isExpanded = sidebar.classList.contains('w-64');

            if (isExpanded) {
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-0');
                toggleIcon.classList.remove('rotate-180');
            } else {
                sidebar.classList.remove('w-0');
                sidebar.classList.add('w-64');
                toggleIcon.classList.add('rotate-180');
            }
        }

        function toggleChannelControl() {
            const isExpanded = !channelControlArea.classList.contains('max-h-0');

            if (isExpanded) {
                channelControlArea.classList.add('max-h-0');
                channelControlArea.classList.remove('max-h-full');
                channelToggleIcon.classList.remove('rotate-0');
                channelToggleIcon.classList.add('rotate-180');
            } else {
                channelControlArea.classList.remove('max-h-0');
                channelControlArea.classList.add('max-h-full');
                channelToggleIcon.classList.remove('rotate-180');
                channelToggleIcon.classList.add('rotate-0');
            }
        }

        function openUserSettingsModal() {
            userSettingsModal.classList.remove('hidden');
            userColorInput.value = currentColor;
            themeSelect.value = localStorage.getItem('wChatTheme') || 'dark';
        }

        function closeUserSettingsModal() {
            userSettingsModal.classList.add('hidden');
        }

        function saveUserSettings() {
            currentColor = userColorInput.value;
            localStorage.setItem('wChatUserColor', currentColor);

            currentTheme = themeSelect.value;
            localStorage.setItem('wChatTheme', currentTheme);
            applyTheme(currentTheme);

            closeUserSettingsModal();
        }


        nicknameInput.addEventListener('input', (e) => {
            currentUserName = e.target.value;
            localStorage.setItem('wChatUserName', currentUserName);
        });

        newMessageInput.addEventListener('input', () => {
            if (messageIdToEdit && newMessageInput.value.trim() !== originalMessageText) {
                 sendButtonText.textContent = 'Save Edits';
            } else if (!messageIdToEdit && newMessageInput.value.trim() === '') {
                sendButtonText.textContent = 'Send';
            }
        });

        messageForm.addEventListener('submit', sendMessage);

        joinChannelButton.addEventListener('click', joinChannel);

        channelInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                joinChannel();
            }
        });

        sidebarToggle.addEventListener('click', toggleSidebar);
        channelToggleButton.addEventListener('click', toggleChannelControl);

        confirmDeleteYes.addEventListener('click', () => {
            if (messageIdToDelete) {
                performDeleteMessage(messageIdToDelete);
                messageIdToDelete = null;
            }
            confirmationModal.classList.add('hidden');
        });

        confirmDeleteNo.addEventListener('click', () => {
            messageIdToDelete = null;
            confirmationModal.classList.add('hidden');
        });

        attachImageButton.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 1 * 1024 * 1024;
                if (file.size > maxSize) {
                    showImageSizeError("Image size exceeds 1MB limit. Please choose a smaller image.");
                    clearImageSelection();
                    return;
                }

                currentImageFile = file;
                imageFileName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                resetEditMode();
                hideImageSizeError();
            } else {
                clearImageSelection();
            }
        });

        cancelImageButton.addEventListener('click', clearImageSelection);

        userSettingsButton.addEventListener('click', openUserSettingsModal);
        closeSettingsModalButton.addEventListener('click', closeUserSettingsModal);
        saveUserSettingsButton.addEventListener('click', saveUserSettings);


        window.onload = () => {
            initializeFirebase();
            populateChannelList();
            if (window.innerWidth >= 768) {
                sidebar.classList.add('w-64');
                sidebar.classList.remove('w-0');
                toggleIcon.classList.add('rotate-180');
            } else {
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-0');
                toggleIcon.classList.remove('rotate-180');
            }
            if (window.innerWidth >= 768) {
                 channelControlArea.classList.remove('max-h-0');
                 channelControlArea.classList.add('max-h-full');
                 channelToggleIcon.classList.add('rotate-0');
                 channelToggleIcon.classList.remove('rotate-180');
            } else {
                 channelControlArea.classList.add('max-h-0');
                 channelControlArea.classList.remove('max-h-full');
                 channelToggleIcon.classList.add('rotate-180');
                 channelToggleIcon.classList.remove('rotate-0');
            }
            applyTheme(localStorage.getItem('wChatTheme') || 'dark');
        };
    </script>
</body>
</html>
